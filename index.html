<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.gstatic.com https://accounts.google.com https://*.googleapis.com https://ssl.gstatic.com https://www.google.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://accounts.google.com https://sheets.googleapis.com https://www.googleapis.com https://apis.google.com;">
  <title>Compactor Progress Tracker</title>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: clamp(10px, 2vw, 15px);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      height: auto;
      color: #333;
      line-height: 1.5;
      font-size: clamp(14px, 2.5vw, 16px);
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .container {
      max-width: min(1400px, 95vw);
      margin: 0 auto;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      padding: clamp(15px, 2.5vw, 20px);
      position: relative;
      flex-grow: 1;
      height: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800);
    }

    header {
      text-align: center;
      margin-bottom: clamp(15px, 3vw, 25px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
    }

    h1 {
      color: #2c3e50;
      margin: clamp(10px, 2vw, 15px) 0;
      font-weight: 600;
      position: relative;
      padding-bottom: 15px;
      font-size: clamp(1.5rem, 5vw, 2rem);
      flex: 1 1 auto;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(60px, 10vw, 80px);
      height: 4px;
      background: linear-gradient(90deg, #4CAF50, #2196F3);
      border-radius: 2px;
    }

    .btn-signin {
      background-color: #4285F4;
      color: white;
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.85rem, 2.2vw, 0.95rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(5px, 1vw, 8px);
      min-width: 100px;
      touch-action: manipulation;
    }

    .btn-signin:hover {
      background-color: #3578e5;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3);
    }

    .btn-signin.hidden {
      display: none;
    }

    .dashboard {
      display: flex;
      flex-direction: column;
      gap: clamp(15px, 3vw, 25px);
      margin-bottom: clamp(15px, 3vw, 25px);
      flex-grow: 1;
    }

    @media (min-width: 768px) {
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: clamp(10px, 2vw, 20px);
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
      width: 100%;
      overflow: visible;
      flex-grow: 0;
      min-height: 0;
      overflow-y: auto;
    }

    .card-header {
      font-size: clamp(1rem, 3vw, 1.25rem);
      font-weight: 600;
      margin-bottom: clamp(10px, 2vw, 15px);
      color: #2c3e50;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .compactor-grid {
      display: grid;
      grid-template-rows: repeat(2, auto);
      grid-template-columns: repeat(5, minmax(50px, 1fr));
      grid-template-areas: 
        "b1 b2 b3 b4 b5"
        "b6 b7 b8 b9 b10";
      gap: clamp(8px, 1.5vw, 12px);
      margin-bottom: clamp(10px, 2vw, 20px);
    }

    .compactor-btn[data-machine="1"] { grid-area: b1; }
    .compactor-btn[data-machine="2"] { grid-area: b2; }
    .compactor-btn[data-machine="3"] { grid-area: b3; }
    .compactor-btn[data-machine="4"] { grid-area: b4; }
    .compactor-btn[data-machine="5"] { grid-area: b5; }
    .compactor-btn[data-machine="6"] { grid-area: b6; }
    .compactor-btn[data-machine="7"] { grid-area: b7; }
    .compactor-btn[data-machine="8"] { grid-area: b8; }
    .compactor-btn[data-machine="9"] { grid-area: b9; }
    .compactor-btn[data-machine="10"] { grid-area: b10; }

    .compactor-btn {
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(14px, 2.5vw, 18px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #4CAF50;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      touch-action: manipulation;
    }

    .compactor-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .compactor-btn.active {
      background-color: #6c757d;
      transform: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .error {
      color: #e74c3c;
      font-size: clamp(0.9rem, 2vw, 1rem);
      margin: clamp(10px, 1vw, 10px) 0;
      min-height: 24px;
      font-weight: bold;
      text-align: center;
    }

    .table-container {
      overflow-x: hidden;
      overflow-y: auto;
      margin-top: clamp(10px, 2vw, 20px);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      width: 100%;
      max-height: 400px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      table-layout: fixed;
    }

    th {
      background-color: #f1f5f9;
      padding: clamp(4px, 1vw, 8px);
      text-align: center;
      font-weight: 600;
      color: #2c3e50;
      border: 1px solid #d1d5db;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
    }

    td {
      padding: clamp(4px, 1vw, 8px);
      border: 1px solid #d1d5db;
      color: #4a5568;
      text-align: center;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #hourlyTable th:nth-child(1),
    #hourlyTable td:nth-child(1) {
      width: clamp(80px, 15vw, 100px);
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
    }

    #hourlyTable th:nth-child(n+2):nth-child(-n+11),
    #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
      width: calc((100% - clamp(80px, 15vw, 100px)) / 11 * 0.9);
    }

    tr:hover {
      background-color: #f8fafc;
    }

    .cumulative-row {
      background-color: #d4edda !important;
    }

    .cumulative-row th,
    .cumulative-row td {
      background-color: #d4edda !important;
      font-weight: 700;
      color: #155724;
    }

    .time-cell {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .time-cell:hover {
      background-color: #e3f2fd;
    }

    .blink {
      animation: blink-animation 1s ease-in-out infinite;
    }

    @keyframes blink-animation {
      0%, 100% { background-color: #f8f9fa; }
      50% { background-color: #ffcccb; }
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: clamp(10px, 2vw, 15px);
      flex-wrap: wrap;
      gap: clamp(5px, 1vw, 10px);
    }

    .table-header h3 {
      margin: 0;
      flex: 1 1 auto;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .table-header > div {
      display: flex;
      align-items: center;
      gap: clamp(5px, 1vw, 10px);
      flex: 0 1 auto;
    }

    .counter {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
      border-radius: 20px;
      font-weight: bold;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-top: clamp(15px, 3vw, 25px);
    }

    .btn {
      flex: 1;
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.85rem, 2.2vw, 0.95rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(5px, 1vw, 8px);
      min-width: 100px;
      touch-action: manipulation;
    }

    .btn-export {
      background-color: #2196F3;
      color: white;
    }

    .btn-export:hover {
      background-color: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }

    .btn-clear {
      background-color: #e74c3c;
      color: white;
    }

    .btn-clear:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    .btn-undo {
      background-color: #f0ad4e;
      color: white;
    }

    .btn-undo:hover {
      background-color: #ec971f;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(240, 173, 78, 0.3);
    }

    .btn-undo:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .delete-icon {
      cursor: pointer;
      color: #e74c3c;
      transition: all 0.2s;
      width: clamp(14px, 2vw, 16px);
      height: clamp(14px, 2vw, 16px);
    }

    .delete-icon:hover {
      color: #c0392b;
      transform: scale(1.1);
    }

    .highlight {
      background: #fff9c4;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      margin-top: clamp(15px, 3vw, 25px);
      color: #6c757d;
      padding-top: clamp(10px, 2vw, 15px);
      border-top: 1px solid #e9ecef;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .status-counters {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-bottom: clamp(10px, 2vw, 15px);
      justify-content: center;
    }

    .counter-badge {
      background: #e3f2fd;
      padding: clamp(6px, 1vw, 8px) clamp(10px, 2vw, 15px);
      border-radius: 20px;
      font-weight: bold;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .counter-badge.pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .counter-badge.completed {
      background-color: #d4edda;
      color: #155724;
    }

    .toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #1976d2;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: clamp(3px, 0.5vw, 5px);
      padding: clamp(3px, 0.5vw, 5px) clamp(5px, 1vw, 10px);
      border-radius: 4px;
      transition: all 0.2s;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
      touch-action: manipulation;
    }

    .toggle-btn:hover {
      background-color: #e3f2fd;
    }

    .blink-toggle {
      color: #e74c3c;
    }

    .blink-toggle:hover {
      color: #c0392b;
    }

    .status-row {
      transition: background-color 0.3s;
    }

    .status-row:hover {
      background-color: #ebf8ff;
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .table-container {
        overflow-x: hidden;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
      }

      table {
        table-layout: fixed;
        width: 100%;
      }

      th, td {
        padding: clamp(2px, 0.5vw, 4px);
        font-size: clamp(0.6rem, 1.2vw, 0.7rem);
        width: auto;
      }

      #statusTable th:nth-child(1),
      #statusTable th:nth-child(2),
      #statusTable th:nth-child(3),
      #statusTable th:nth-child(4),
      #statusTable th:nth-child(5),
      #statusTable th:nth-child(6),
      #statusTable td:nth-child(1),
      #statusTable td:nth-child(2),
      #statusTable td:nth-child(3),
      #statusTable td:nth-child(4),
      #statusTable td:nth-child(5),
      #statusTable td:nth-child(6) {
        width: calc(100% / 6 * 0.9);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(70px, 12vw, 90px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(70px, 12vw, 90px)) / 11 * 0.8);
      }
    }

    @media (max-width: 1024px) {
      .card {
        padding: clamp(8px, 1.5vw, 15px);
      }
      
      .table-container {
        margin-left: calc(-1vw);
        margin-right: calc(-1vw);
        padding: 0 1vw;
      }
      
      table {
        min-width: 0;
      }
      
      body {
        padding: clamp(5px, 1vw, 10px);
      }
      
      .container {
        padding: clamp(10px, 2vw, 15px);
      }
    }

    @media (max-width: 768px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(45px, 1fr));
        gap: clamp(6px, 1vw, 10px);
      }
      
      .btn {
        min-width: 90px;
        padding: clamp(6px, 1.5vw, 10px);
      }
      
      .table-container {
        margin-left: calc(-2vw);
        margin-right: calc(-2vw);
        padding: 0 2vw;
      }
      
      .dashboard {
        flex-direction: column;
      }
      
      .card {
        width: 100%;
        margin-bottom: clamp(10px, 2vw, 15px);
      }
      
      body {
        min-height: 100%;
        height: auto;
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        min-height: 100%;
        height: auto;
        padding: clamp(8px, 1.5vw, 12px);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(60px, 20vw, 80px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(60px, 20vw, 80px)) / 11 * 0.8);
      }
    }

    @media (max-width: 600px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(40px, 1fr));
        gap: clamp(5px, 1vw, 8px);
      }
      
      .compactor-btn {
        font-size: clamp(12px, 2.2vw, 16px);
        padding: clamp(6px, 1.2vw, 12px);
      }
      
      table {
        min-width: 0;
        font-size: clamp(0.6rem, 1.4vw, 0.7rem);
      }
      
      th, td {
        padding: clamp(2px, 0.5vw, 4px);
      }
      
      .btn {
        min-width: 80px;
        font-size: clamp(0.75rem, 2vw, 0.85rem);
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .table-header > div {
        width: 100%;
        justify-content: flex-end;
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(50px, 18vw, 70px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        font-size: clamp(0.65rem, 1.6vw, 0.75rem);
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(50px, 18vw, 70px)) / 11 * 0.7);
      }
    }

    @media (max-width: 400px) {
      body {
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        padding: clamp(8px, 1.5vw, 12px);
      }
      
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
      }
      
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(35px, 1fr));
        gap: clamp(4px, 0.8vw, 6px);
      }
      
      .compactor-btn {
        font-size: clamp(10px, 2vw, 14px);
        padding: clamp(5px, 1vw, 10px);
      }
      
      table {
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Compactor Progress Tracker</h1>
      <button class="btn btn-signin" id="signInBtn">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
        </svg>
        Sign In
      </button>
    </header>
    
    <div class="dashboard">
      <div class="card">
        <div class="card-header">Compactor Entry</div>
        
        <div class="compactor-grid">
          <button class="compactor-btn" data-machine="1">1</button>
          <button class="compactor-btn" data-machine="2">2</button>
          <button class="compactor-btn" data-machine="3">3</button>
          <button class="compactor-btn" data-machine="4">4</button>
          <button class="compactor-btn" data-machine="5">5</button>
          <button class="compactor-btn" data-machine="6">6</button>
          <button class="compactor-btn" data-machine="7">7</button>
          <button class="compactor-btn" data-machine="8">8</button>
          <button class="compactor-btn" data-machine="9">9</button>
          <button class="compactor-btn" data-machine="10">10</button>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="table-header">
          <h3>Hourly Records</h3>
          <div>
            <span class="counter" id="hourlyCount">0 hours</span>
            <button class="toggle-btn" id="toggleHourly">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
              </svg>
              Show All
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="hourlyTable">
            <thead>
              <tr class="cumulative-row" id="cumulativeRow" style="display: none;">
                <th>Cumulative Total</th>
                <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                <th></th>
              </tr>
              <tr>
                <th>Time Slot</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
                <th>5</th>
                <th>6</th>
                <th>7</th>
                <th>8</th>
                <th>9</th>
                <th>10</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="hourlyBody">
              <tr>
                <td colspan="12" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No hourly records</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-export" id="exportButton">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            Export to CSV
          </button>
          <button class="btn btn-clear" id="clearButton">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
              <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
            Clear All Data
          </button>
          <button class="btn btn-undo" id="undoButton" disabled>
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 0a8 8 0 0 0-2.915 15.452c-.07-.633-.134-1.606.027-2.297.146-.625.938-3.977.938-3.977s-.239-.479-.239-1.187c0-1.113.645-1.943 1.448-1.943.682 0 1.012.512 1.012 1.127 0 .686-.437 1.712-.663 2.663-.188.796.805 1.446 1.742 1.446 2.094 0 3.71-2.205 3.71-5.398 0-2.82-2.03-4.788-4.922-4.788-3.354 0-5.32 2.517-5.32 5.117 0 1.015.388 2.103.873 2.696a.346.346 0 0 1 .078.427c-.066.286-.287.885-.392 1.104-.104.218-.217.243-.334.114C2.29 12.685 2 11.454 2 10.025 2 6.153 5.144 3 8.5 3 11.07 3 14 5.404 14 8.5c0 3.096-2.93 5.5-5.5 5.5-.943 0-1.816-.256-2.557-.683l-.737.552a.5.5 0 0 1-.683-.95l1.293-.97A7.942 7.942 0 0 0 8 0z"/>
            </svg>
            Undo
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">Current Status</div>
        
        <div class="status-counters">
          <div class="counter-badge pending" id="pendingCount">0 pending</div>
          <div class="counter-badge completed" id="completedCount">0 completed</div>
        </div>
        
        <div class="table-header">
          <h3>Status Records</h3>
          <div>
            <span class="counter" id="statusCount">0 records</span>
            <button class="toggle-btn blink-toggle" id="toggleBlink">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
              Stop Blinking
            </button>
            <button class="toggle-btn" id="toggleRecords" style="display: none;">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
              </svg>
              Show All
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="statusTable">
            <thead>
              <tr>
                <th>Container #</th>
                <th>Compactor</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Duration</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="statusBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No records</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="footer">
      Compactor Progress Tracker v2.4 | Data is stored locally in your browser
    </div>
  </div>
<script>
const API_KEY = 'AIzaSyD7iPND2yyzqY1JyC5n1la7S5NnDwpNOVM';
const CLIENT_ID = '959994109190-rrpedrd8vg3es3meibc9gbim7a1r0254.apps.googleusercontent.com';
const SPREADSHEET_ID = '1w6suOx0R43BUGhi_ylAohNzj7j3Z_quO9k2yoJ5CcSo';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
const HOURLY_RANGE = 'HourlyData!A1:L';
const STATUS_RANGE = 'StatusData!A1:F';

let tokenClient;
let gapiInited = false;
let gisInited = false;
let isSignedIn = false;
let records = JSON.parse(localStorage.getItem('compactorRecords')) || [];
let hourlyData = JSON.parse(localStorage.getItem('hourlyData')) || {};
let lastAction = null;
let isBlinking = true;

function initApp() {
  if (gapiInited && gisInited) {
    initializeElements();
    loadGapiClient();
  }
}

function loadGapiClient() {
  gapi.load('client', () => {
    gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: DISCOVERY_DOCS,
    }).then(() => {
      gapiInited = true;
      initializeGis();
      initApp();
    }).catch(err => showError('Failed to initialize Google API: ' + err.message));
  });
}

function initializeGis() {
  window.google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse,
    prompt_parent_id: 'signInBtn',
    use_fedcm_for_prompt: true
  });
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      console.log('Token Response:', tokenResponse); // Debug
      if (tokenResponse.access_token) {
        isSignedIn = true;
        document.getElementById('signInBtn').classList.add('hidden');
        loadSheetData();
      } else {
        console.error('No access token received');
        showError('Authentication failed: No access token received');
      }
      document.getElementById('signInBtn').disabled = false;
      document.getElementById('signInBtn').textContent = 'Sign In';
    },
  });
  gisInited = true;
  initApp();
}

function handleCredentialResponse(response) {
  if (response.credential) {
    tokenClient.requestAccessToken();
  } else {
    document.getElementById('signInBtn').disabled = false;
    document.getElementById('signInBtn').textContent = 'Sign In';
    showError('Sign-in failed. Please try again.');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  if (!window.google || !window.google.accounts) {
    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.async = true;
    gisScript.defer = true;
    gisScript.onload = () => {
      gisInited = true;
      initApp();
    };
    gisScript.onerror = () => showError('Failed to load Google Identity Services');
    document.head.appendChild(gisScript);
  } else {
    gisInited = true;
    initApp();
  }

  if (!window.gapi) {
    const gapiScript = document.createElement('script');
    gapiScript.src = 'https://apis.google.com/js/api.js';
    gapiScript.async = true;
    gapiScript.defer = true;
    gapiScript.onload = () => {
      gapiInited = true;
      initApp();
    };
    gapiScript.onerror = () => showError('Failed to load Google API Client');
    document.head.appendChild(gapiScript);
  } else {
    gapiInited = true;
    initApp();
  }
});

function initializeElements() {
  document.querySelectorAll('.compactor-btn').forEach(btn => {
    btn.addEventListener('click', () => handleCompactorClick(btn));
  });

  document.getElementById('exportButton').addEventListener('click', exportToCSV);
  document.getElementById('clearButton').addEventListener('click', clearData);
  document.getElementById('undoButton').addEventListener('click', undoLastAction);
  document.getElementById('toggleHourly').addEventListener('click', toggleHourlyRecords);
  document.getElementById('toggleBlink').addEventListener('click', toggleBlink);
  document.getElementById('toggleRecords').addEventListener('click', toggleStatusRecords);
  document.getElementById('signInBtn').addEventListener('click', () => {
    if (!isSignedIn) {
      const btn = document.getElementById('signInBtn');
      btn.disabled = true;
      btn.textContent = 'Signing In...';
      tokenClient.requestAccessToken();
    }
  });

  loadLocalData();
  updateTables();
}

function loadSheetData(attempt = 1) {
  if (!isSignedIn) return;
  Promise.all([
    gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: HOURLY_RANGE,
    }),
    gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: STATUS_RANGE,
    })
  ]).then(([hourlyResponse, statusResponse]) => {
    if (hourlyResponse.result.values) {
      parseHourlySheetData(hourlyResponse.result.values);
    }
    if (statusResponse.result.values) {
      parseStatusSheetData(statusResponse.result.values);
    }
    updateTables();
    saveToLocalStorage();
  }).catch(err => {
    if (err.status === 429 && attempt <= 3) {
      setTimeout(() => loadSheetData(attempt + 1), Math.pow(2, attempt) * 1000);
    } else {
      let message = 'Error loading sheet data: ' + err.message;
      if (err.status === 403) message = 'Permission denied: Please check spreadsheet access.';
      if (err.status === 400) message = 'Invalid request: Check sheet names and ranges.';
      showError(message);
    }
  });
}

function parseHourlySheetData(values) {
  const headers = values[0];
  if (!headers.includes('Time Slot') || headers.length !== 12) {
    showError('Invalid HourlyData sheet format');
    return;
  }
  hourlyData = {};
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    if (row.length < 12) continue;
    const timeSlot = row[0];
    hourlyData[timeSlot] = {};
    for (let j = 1; j < headers.length - 1; j++) {
      const value = parseInt(row[j]);
      hourlyData[timeSlot][headers[j]] = isNaN(value) ? 0 : value;
    }
    const total = parseInt(row[headers.length - 1]);
    hourlyData[timeSlot].total = isNaN(total) ? 0 : total;
  }
}

function parseStatusSheetData(values) {
  records = [];
  for (let i = 1; i < values.length; i++) {
    const [container, compactor, inTime, outTime, duration] = values[i];
    if (container && compactor && inTime) {
      records.push({
        container,
        compactor,
        inTime,
        outTime: outTime || '',
        duration: duration || '',
        isNew: false
      });
    }
  }
}

function saveToSheet() {
  if (!isSignedIn) return;
  const hourlyValues = [
    ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
    ...Object.keys(hourlyData).map(time => [
      time,
      ...Array(10).fill().map((_, i) => hourlyData[time][i + 1] || 0),
      hourlyData[time].total || 0
    ])
  ];

  const statusValues = [
    ['Container #', 'Compactor', 'In Time', 'Out Time', 'Duration', 'Action'],
    ...records.map(r => [
      r.container,
      r.compactor,
      r.inTime,
      r.outTime,
      r.duration,
      ''
    ])
  ];

  Promise.all([
    gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: HOURLY_RANGE,
      valueInputOption: 'RAW',
      resource: { values: hourlyValues }
    }),
    gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: SPREADSHEET_ID,
      range: STATUS_RANGE,
      valueInputOption: 'RAW',
      resource: { values: statusValues }
    })
  ]).then(() => {
    showError('Data successfully synced to Google Sheets', 'success');
  }).catch(err => {
    let message = 'Error saving to sheet: ' + err.message;
    if (err.status === 403) message = 'Permission denied: Please check spreadsheet access.';
    if (err.status === 429) message = 'Rate limit exceeded: Please try again later.';
    showError(message);
  });
}

function handleCompactorClick(btn) {
  if (!isSignedIn) {
    showError('Please sign in to record compactor entries.');
    return;
  }

  const machine = btn.dataset.machine;
  const isActive = btn.classList.contains('active');
  const now = new Date();
  const containerId = `CT${now.getTime()}`;
  const timeSlot = getTimeSlot(now);

  if (!isActive) {
    const compactorInUse = records.some(r => r.compactor === machine && !r.outTime);
    if (compactorInUse) {
      showError(`Compactor ${machine} is already in use.`);
      return;
    }

    btn.classList.add('active');
    const record = {
      container: containerId,
      compactor: machine,
      inTime: formatDateTime(now),
      outTime: '',
      duration: '',
      isNew: true
    };
    records.push(record);
    lastAction = { type: 'add', record: { ...record } };
    updateHourlyData(machine, timeSlot, 1);
  } else {
    const record = records.find(r => r.compactor === machine && !r.outTime);
    if (record) {
      record.outTime = formatDateTime(now);
      record.duration = calculateDuration(record.inTime, record.outTime);
      record.isNew = false;
      btn.classList.remove('active');
      lastAction = { type: 'complete', record: { ...record } };
    }
  }

  saveToLocalStorage();
  saveToSheet();
  updateTables();
  document.getElementById('undoButton').disabled = false;
}

function getTimeSlot(date) {
  const hours = date.getHours();
  const period = hours < 12 ? 'AM' : 'PM';
  const hour = hours % 12 || 12;
  return `${hour}:00 ${period}`;
}

function formatDateTime(date) {
  return date.toLocaleString('en-US', {
    month: 'short',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Asia/Hong_Kong'
  });
}

function calculateDuration(inTime, outTime) {
  const start = new Date(inTime);
  const end = new Date(outTime);
  const diff = (end - start) / 1000 / 60;
  return diff >= 60 ? `${Math.floor(diff / 60)}h ${Math.round(diff % 60)}m` : `${Math.round(diff)}m`;
}

function updateHourlyData(machine, timeSlot, value) {
  if (!hourlyData[timeSlot]) {
    hourlyData[timeSlot] = { total: 0 };
    for (let i = 1; i <= 10; i++) {
      hourlyData[timeSlot][i] = 0;
    }
  }
  hourlyData[timeSlot][machine] = (hourlyData[timeSlot][machine] || 0) + value;
  hourlyData[timeSlot].total = Object.keys(hourlyData[timeSlot])
    .filter(key => key !== 'total')
    .reduce((sum, key) => sum + (hourlyData[timeSlot][key] || 0), 0);
}

function saveToLocalStorage() {
  localStorage.setItem('compactorRecords', JSON.stringify(records));
  localStorage.setItem('hourlyData', JSON.stringify(hourlyData));
}

function loadLocalData() {
  records = JSON.parse(localStorage.getItem('compactorRecords')) || [];
  hourlyData = JSON.parse(localStorage.getItem('hourlyData')) || {};
  updateCompactorButtons();
}

function updateCompactorButtons() {
  document.querySelectorAll('.compactor-btn').forEach(btn => {
    const machine = btn.dataset.machine;
    const isActive = records.some(r => r.compactor === machine && !r.outTime);
    btn.classList.toggle('active', isActive);
  });
}

function updateTables() {
  updateHourlyTable();
  updateStatusTable();
  updateCounters();
}

function updateHourlyTable() {
  const tbody = document.getElementById('hourlyBody');
  tbody.innerHTML = '';
  const cumulative = Array(10).fill(0);
  let totalSum = 0;

  const rows = Object.keys(hourlyData).sort((a, b) => {
    const timeA = parseTimeSlot(a);
    const timeB = parseTimeSlot(b);
    return timeA - timeB;
  });

  if (rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No hourly records</td></tr>';
    document.getElementById('cumulativeRow').style.display = 'none';
    return;
  }

  const showAll = document.getElementById('toggleHourly').textContent.includes('Show All');
  const filteredRows = showAll ? rows : rows.slice(-3);

  filteredRows.forEach(time => {
    const row = document.createElement('tr');
    const cells = [time];
    for (let i = 1; i <= 10; i++) {
      const count = hourlyData[time][i] || 0;
      cumulative[i - 1] += count;
      cells.push(count > 0 ? `<span class="highlight">${count}</span>` : '0');
    }
    const total = hourlyData[time].total || 0;
    totalSum += total;
    cells.push(total > 0 ? `<span class="highlight">${total}</span>` : '0');
    row.innerHTML = cells.map((cell, i) => `<td${i === 0 ? ' class="time-cell"' : ''}>${cell}</td>`).join('');
    row.querySelector('.time-cell').addEventListener('click', () => filterByTime(time));
    tbody.appendChild(row);
  });

  const cumulativeRow = document.getElementById('cumulativeRow');
  cumulativeRow.style.display = totalSum > 0 ? '' : 'none';
  cumulativeRow.cells[0].textContent = 'Cumulative Total';
  for (let i = 1; i <= 10; i++) {
    cumulativeRow.cells[i].innerHTML = cumulative[i - 1] > 0 ? `<span class="highlight">${cumulative[i - 1]}</span>` : '0';
  }
  cumulativeRow.cells[11].innerHTML = totalSum > 0 ? `<span class="highlight">${totalSum}</span>` : '0';
}

function parseTimeSlot(timeSlot) {
  const [hour, period] = timeSlot.split(':00 ');
  let hours = parseInt(hour);
  if (period === 'PM' && hours !== 12) hours += 12;
  if (period === 'AM' && hours === 12) hours = 0;
  return hours;
}

function updateStatusTable() {
  const tbody = document.getElementById('statusBody');
  tbody.innerHTML = '';
  const showAll = document.getElementById('toggleRecords').textContent.includes('Show All');
  const filteredRecords = showAll ? records : records.filter(r => r.isNew || !r.outTime);

  if (filteredRecords.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No records</td></tr>';
    return;
  }

  filteredRecords.forEach((record, index) => {
    const row = document.createElement('tr');
    row.className = record.isNew && isBlinking ? 'blink status-row' : 'status-row';
    row.innerHTML = `
      <td>${record.container}</td>
      <td>${record.compactor}</td>
      <td>${record.inTime}</td>
      <td>${record.outTime || 'In Progress'}</td>
      <td>${record.duration || '-'}</td>
      <td><svg class="delete-icon" data-index="${index}" viewBox="0 0 16 16">
        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
      </svg></td>
    `;
    tbody.appendChild(row);
  });

  document.querySelectorAll('.delete-icon').forEach(icon => {
    icon.addEventListener('click', () => {
      const index = parseInt(icon.dataset.index);
      deleteRecord(index);
    });
  });
}

function updateCounters() {
  const pending = records.filter(r => !r.outTime).length;
  const completed = records.filter(r => r.outTime).length;
  document.getElementById('pendingCount').textContent = `${pending} pending`;
  document.getElementById('completedCount').textContent = `${completed} completed`;
  document.getElementById('statusCount').textContent = `${records.length} records`;
  document.getElementById('hourlyCount').textContent = `${Object.keys(hourlyData).length} hours`;
}

function deleteRecord(index) {
  const record = records[index];
  if (!record) return;

  lastAction = { type: 'delete', record: { ...record }, index };
  if (!record.outTime) {
    const timeSlot = getTimeSlot(new Date(record.inTime));
    updateHourlyData(record.compactor, timeSlot, -1);
    if (hourlyData[timeSlot].total === 0) delete hourlyData[timeSlot];
  }
  records.splice(index, 1);
  saveToLocalStorage();
  saveToSheet();
  updateTables();
  document.getElementById('undoButton').disabled = false;
}

function toggleHourlyRecords() {
  const btn = document.getElementById('toggleHourly');
  btn.innerHTML = btn.textContent.includes('Show All') ?
    '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg> Show Recent' :
    '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg> Show All';
  updateHourlyTable();
}

function toggleStatusRecords() {
  const btn = document.getElementById('toggleRecords');
  btn.innerHTML = btn.textContent.includes('Show All') ?
    '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg> Show Recent' :
    '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg> Show All';
  updateStatusTable();
}

function toggleBlink() {
  isBlinking = !isBlinking;
  const btn = document.getElementById('toggleBlink');
  btn.innerHTML = isBlinking ?
    '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg> Stop Blinking' :
    '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/></svg> Start Blinking';
  updateStatusTable();
}

function filterByTime(timeSlot) {
  const filtered = records.filter(r => getTimeSlot(new Date(r.inTime)) === timeSlot);
  document.getElementById('statusBody').innerHTML = filtered.length === 0 ?
    '<tr><td colspan="6" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No records for this time slot</td></tr>' :
    filtered.map((r, i) => `
      <tr class="${r.isNew && isBlinking ? 'blink status-row' : 'status-row'}">
        <td>${r.container}</td>
        <td>${r.compactor}</td>
        <td>${r.inTime}</td>
        <td>${r.outTime || 'In Progress'}</td>
        <td>${r.duration || '-'}</td>
        <td><svg class="delete-icon" data-index="${i}" viewBox="0 0 16 16">
          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
        </svg></td>
      </tr>
    `).join('');

  document.querySelectorAll('.delete-icon').forEach(icon => {
    icon.addEventListener('click', () => {
      const index = parseInt(icon.dataset.index);
      deleteRecord(index);
    });
  });

  document.getElementById('toggleRecords').style.display = 'none';
}

function exportToCSV() {
  const headers = ['Container #', 'Compactor', 'In Time', 'Out Time', 'Duration'];
  const csv = [
    headers.join(','),
    ...records.map(r => [
      r.container,
      r.compactor,
      `"${r.inTime}"`,
      `"${r.outTime || ''}"`,
      `"${r.duration || ''}"`
    ].join(','))
  ].join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `compactor_records_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearData() {
  lastAction = {
    type: 'clear',
    records: [...records],
    hourlyData: { ...hourlyData }
  };
  records = [];
  hourlyData = {};
  saveToLocalStorage();
  saveToSheet();
  updateTables();
  document.getElementById('undoButton').disabled = false;
}

function undoLastAction() {
  if (!lastAction) return;

  if (lastAction.type === 'add') {
    records.pop();
    const timeSlot = getTimeSlot(new Date(lastAction.record.inTime));
    updateHourlyData(lastAction.record.compactor, timeSlot, -1);
    if (hourlyData[timeSlot].total === 0) delete hourlyData[timeSlot];
  } else if (lastAction.type === 'complete') {
    const record = records.find(r => r.container === lastAction.record.container);
    if (record) {
      record.outTime = '';
      record.duration = '';
      record.isNew = true;
    }
  } else if (lastAction.type === 'delete') {
    records.splice(lastAction.index, 0, lastAction.record);
    if (!lastAction.record.outTime) {
      const timeSlot = getTimeSlot(new Date(lastAction.record.inTime));
      updateHourlyData(lastAction.record.compactor, timeSlot, 1);
    }
  } else if (lastAction.type === 'clear') {
    records = [...lastAction.records];
    hourlyData = { ...lastAction.hourlyData };
  }

  lastAction = null;
  saveToLocalStorage();
  saveToSheet();
  updateTables();
  document.getElementById('undoButton').disabled = true;
}

function showError(message, type = 'error') {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = message;
  errorDiv.style.color = type === 'success' ? '#155724' : '#e74c3c';
  setTimeout(() => errorDiv.textContent = '', 5000);
}
</script>

</body>
</html>
