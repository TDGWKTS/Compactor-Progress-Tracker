<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.gstatic.com https://accounts.google.com https://*.googleapis.com https://ssl.gstatic.com https://www.google.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://accounts.google.com https://sheets.googleapis.com https://www.googleapis.com https://apis.google.com;">
  <title>Compactor Progress Tracker</title>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: clamp(10px, 2vw, 15px);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      height: auto;
      color: #333;
      line-height: 1.5;
      font-size: clamp(14px, 2.5vw, 16px);
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .container {
      max-width: min(1400px, 95vw);
      margin: 0 auto;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      padding: clamp(15px, 2.5vw, 20px);
      position: relative;
      flex-grow: 1;
      height: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800);
    }

    header {
      text-align: center;
      margin-bottom: clamp(15px, 3vw, 25px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
    }

    h1 {
      color: #2c3e50;
      margin: clamp(10px, 2vw, 15px) 0;
      font-weight: 600;
      position: relative;
      padding-bottom: 15px;
      font-size: clamp(1.5rem, 5vw, 2rem);
      flex: 1 1 auto;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(60px, 10vw, 80px);
      height: 4px;
      background: linear-gradient(90deg, #4CAF50, #2196F3);
      border-radius: 2px;
    }

    .btn-signin {
      background-color: #4285F4;
      color: white;
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.85rem, 2.2vw, 0.95rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(5px, 1vw, 8px);
      min-width: 100px;
      touch-action: manipulation;
    }

    .btn-signin:hover {
      background-color: #3578e5;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3);
    }

    .btn-signin.hidden {
      display: none;
    }

    .dashboard {
      display: flex;
      flex-direction: column;
      gap: clamp(15px, 3vw, 25px);
      margin-bottom: clamp(15px, 3vw, 25px);
      flex-grow: 1;
    }

    @media (min-width: 768px) {
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: clamp(10px, 2vw, 20px);
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
      width: 100%;
      overflow: visible;
      flex-grow: 0;
      min-height: 0;
      overflow-y: auto;
    }

    .card-header {
      font-size: clamp(1rem, 3vw, 1.25rem);
      font-weight: 600;
      margin-bottom: clamp(10px, 2vw, 15px);
      color: #2c3e50;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .compactor-grid {
      display: grid;
      grid-template-rows: repeat(2, auto);
      grid-template-columns: repeat(5, minmax(50px, 1fr));
      grid-template-areas: 
        "b1 b2 b3 b4 b5"
        "b6 b7 b8 b9 b10";
      gap: clamp(8px, 1.5vw, 12px);
      margin-bottom: clamp(10px, 2vw, 20px);
    }

    .compactor-btn[data-machine="1"] { grid-area: b1; }
    .compactor-btn[data-machine="2"] { grid-area: b2; }
    .compactor-btn[data-machine="3"] { grid-area: b3; }
    .compactor-btn[data-machine="4"] { grid-area: b4; }
    .compactor-btn[data-machine="5"] { grid-area: b5; }
    .compactor-btn[data-machine="6"] { grid-area: b6; }
    .compactor-btn[data-machine="7"] { grid-area: b7; }
    .compactor-btn[data-machine="8"] { grid-area: b8; }
    .compactor-btn[data-machine="9"] { grid-area: b9; }
    .compactor-btn[data-machine="10"] { grid-area: b10; }

    .compactor-btn {
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(14px, 2.5vw, 18px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #4CAF50;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      touch-action: manipulation;
    }

    .compactor-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .compactor-btn.active {
      background-color: #6c757d;
      transform: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .error {
      color: #e74c3c;
      font-size: clamp(0.9rem, 2vw, 1rem);
      margin: clamp(10px, 1vw, 10px) 0;
      min-height: 24px;
      font-weight: bold;
      text-align: center;
    }

    .table-container {
      overflow-x: hidden;
      overflow-y: auto;
      margin-top: clamp(10px, 2vw, 20px);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      width: 100%;
      max-height: 400px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      table-layout: fixed;
    }

    th {
      background-color: #f1f5f9;
      padding: clamp(4px, 1vw, 8px);
      text-align: center;
      font-weight: 600;
      color: #2c3e50;
      border: 1px solid #d1d5db;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
    }

    td {
      padding: clamp(4px, 1vw, 8px);
      border: 1px solid #d1d5db;
      color: #4a5568;
      text-align: center;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #hourlyTable th:nth-child(1),
    #hourlyTable td:nth-child(1) {
      width: clamp(80px, 15vw, 100px);
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
    }

    #hourlyTable th:nth-child(n+2):nth-child(-n+11),
    #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
      width: calc((100% - clamp(80px, 15vw, 100px)) / 11 * 0.9);
    }

    tr:hover {
      background-color: #f8fafc;
    }

    .cumulative-row {
      background-color: #d4edda !important;
    }

    .cumulative-row th,
    .cumulative-row td {
      background-color: #d4edda !important;
      font-weight: 700;
      color: #155724;
    }

    .time-cell {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .time-cell:hover {
      background-color: #e3f2fd;
    }

    .blink {
      animation: blink-animation 1s ease-in-out infinite;
    }

    @keyframes blink-animation {
      0%, 100% { background-color: #f8f9fa; }
      50% { background-color: #ffcccb; }
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: clamp(10px, 2vw, 15px);
      flex-wrap: wrap;
      gap: clamp(5px, 1vw, 10px);
    }

    .table-header h3 {
      margin: 0;
      flex: 1 1 auto;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .table-header > div {
      display: flex;
      align-items: center;
      gap: clamp(5px, 1vw, 10px);
      flex: 0 1 auto;
    }

    .counter {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
      border-radius: 20px;
      font-weight: bold;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-top: clamp(15px, 3vw, 25px);
    }

    .btn {
      flex: 1;
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.85rem, 2.2vw, 0.95rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(5px, 1vw, 8px);
      min-width: 100px;
      touch-action: manipulation;
    }

    .btn-export {
      background-color: #2196F3;
      color: white;
    }

    .btn-export:hover {
      background-color: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }

    .btn-clear {
      background-color: #e74c3c;
      color: white;
    }

    .btn-clear:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    .btn-undo {
      background-color: #f0ad4e;
      color: white;
    }

    .btn-undo:hover {
      background-color: #ec971f;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(240, 173, 78, 0.3);
    }

    .btn-undo:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .delete-icon {
      cursor: pointer;
      color: #e74c3c;
      transition: all 0.2s;
      width: clamp(14px, 2vw, 16px);
      height: clamp(14px, 2vw, 16px);
    }

    .delete-icon:hover {
      color: #c0392b;
      transform: scale(1.1);
    }

    .highlight {
      background: #fff9c4;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      margin-top: clamp(15px, 3vw, 25px);
      color: #6c757d;
      padding-top: clamp(10px, 2vw, 15px);
      border-top: 1px solid #e9ecef;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .status-counters {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-bottom: clamp(10px, 2vw, 15px);
      justify-content: center;
    }

    .counter-badge {
      background: #e3f2fd;
      padding: clamp(6px, 1vw, 8px) clamp(10px, 2vw, 15px);
      border-radius: 20px;
      font-weight: bold;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .counter-badge.pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .counter-badge.completed {
      background-color: #d4edda;
      color: #155724;
    }

    .toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #1976d2;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: clamp(3px, 0.5vw, 5px);
      padding: clamp(3px, 0.5vw, 5px) clamp(5px, 1vw, 10px);
      border-radius: 4px;
      transition: all 0.2s;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
      touch-action: manipulation;
    }

    .toggle-btn:hover {
      background-color: #e3f2fd;
    }

    .blink-toggle {
      color: #e74c3c;
    }

    .blink-toggle:hover {
      color: #c0392b;
    }

    .status-row {
      transition: background-color 0.3s;
    }

    .status-row:hover {
      background-color: #ebf8ff;
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .table-container {
        overflow-x: hidden;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
      }

      table {
        table-layout: fixed;
        width: 100%;
      }

      th, td {
        padding: clamp(2px, 0.5vw, 4px);
        font-size: clamp(0.6rem, 1.2vw, 0.7rem);
        width: auto;
      }

      #statusTable th:nth-child(1),
      #statusTable th:nth-child(2),
      #statusTable th:nth-child(3),
      #statusTable th:nth-child(4),
      #statusTable th:nth-child(5),
      #statusTable th:nth-child(6),
      #statusTable td:nth-child(1),
      #statusTable td:nth-child(2),
      #statusTable td:nth-child(3),
      #statusTable td:nth-child(4),
      #statusTable td:nth-child(5),
      #statusTable td:nth-child(6) {
        width: calc(100% / 6 * 0.9);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(70px, 12vw, 90px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(70px, 12vw, 90px)) / 11 * 0.8);
      }
    }

    @media (max-width: 1024px) {
      .card {
        padding: clamp(8px, 1.5vw, 15px);
      }
      
      .table-container {
        margin-left: calc(-1vw);
        margin-right: calc(-1vw);
        padding: 0 1vw;
      }
      
      table {
        min-width: 0;
      }
      
      body {
        padding: clamp(5px, 1vw, 10px);
      }
      
      .container {
        padding: clamp(10px, 2vw, 15px);
      }
    }

    @media (max-width: 768px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(45px, 1fr));
        gap: clamp(6px, 1vw, 10px);
      }
      
      .btn {
        min-width: 90px;
        padding: clamp(6px, 1.5vw, 10px);
      }
      
      .table-container {
        margin-left: calc(-2vw);
        margin-right: calc(-2vw);
        padding: 0 2vw;
      }
      
      .dashboard {
        flex-direction: column;
      }
      
      .card {
        width: 100%;
        margin-bottom: clamp(10px, 2vw, 15px);
      }
      
      body {
        min-height: 100%;
        height: auto;
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        min-height: 100%;
        height: auto;
        padding: clamp(8px, 1.5vw, 12px);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(60px, 20vw, 80px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(60px, 20vw, 80px)) / 11 * 0.8);
      }
    }

    @media (max-width: 600px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(40px, 1fr));
        gap: clamp(5px, 1vw, 8px);
      }
      
      .compactor-btn {
        font-size: clamp(12px, 2.2vw, 16px);
        padding: clamp(6px, 1.2vw, 12px);
      }
      
      table {
        min-width: 0;
        font-size: clamp(0.6rem, 1.4vw, 0.7rem);
      }
      
      th, td {
        padding: clamp(2px, 0.5vw, 4px);
      }
      
      .btn {
        min-width: 80px;
        font-size: clamp(0.75rem, 2vw, 0.85rem);
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .table-header > div {
        width: 100%;
        justify-content: flex-end;
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(50px, 18vw, 70px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        font-size: clamp(0.65rem, 1.6vw, 0.75rem);
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(50px, 18vw, 70px)) / 11 * 0.7);
      }
    }

    @media (max-width: 400px) {
      body {
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        padding: clamp(8px, 1.5vw, 12px);
      }
      
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
      }
      
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(35px, 1fr));
        gap: clamp(4px, 0.8vw, 6px);
      }
      
      .compactor-btn {
        font-size: clamp(10px, 2vw, 14px);
        padding: clamp(5px, 1vw, 10px);
      }
      
      table {
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Compactor Progress Tracker</h1>
      <button class="btn btn-signin" id="signInBtn">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
        </svg>
        Sign In
      </button>
    </header>
    
    <div class="dashboard">
      <div class="card">
        <div class="card-header">Compactor Entry</div>
        
        <div class="compactor-grid">
          <button class="compactor-btn" data-machine="1">1</button>
          <button class="compactor-btn" data-machine="2">2</button>
          <button class="compactor-btn" data-machine="3">3</button>
          <button class="compactor-btn" data-machine="4">4</button>
          <button class="compactor-btn" data-machine="5">5</button>
          <button class="compactor-btn" data-machine="6">6</button>
          <button class="compactor-btn" data-machine="7">7</button>
          <button class="compactor-btn" data-machine="8">8</button>
          <button class="compactor-btn" data-machine="9">9</button>
          <button class="compactor-btn" data-machine="10">10</button>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="table-header">
          <h3>Hourly Records</h3>
          <div>
            <span class="counter" id="hourlyCount">0 hours</span>
            <button class="toggle-btn" id="toggleHourly">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
              </svg>
              Show All
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="hourlyTable">
            <thead>
              <tr class="cumulative-row" id="cumulativeRow" style="display: none;">
                <th>Cumulative Total</th>
                <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                <th></th>
              </tr>
              <tr>
                <th>Time Slot</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
                <th>5</th>
                <th>6</th>
                <th>7</th>
                <th>8</th>
                <th>9</th>
                <th>10</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="hourlyBody">
              <tr>
                <td colspan="12" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No hourly records</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-export" id="exportButton">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            Export to CSV
          </button>
          <button class="btn btn-clear" id="clearButton">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
              <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
            Clear All Data
          </button>
          <button class="btn btn-undo" id="undoButton" disabled>
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 0a8 8 0 0 0-2.915 15.452c-.07-.633-.134-1.606.027-2.297.146-.625.938-3.977.938-3.977s-.239-.479-.239-1.187c0-1.113.645-1.943 1.448-1.943.682 0 1.012.512 1.012 1.127 0 .686-.437 1.712-.663 2.663-.188.796.805 1.446 1.742 1.446 2.094 0 3.71-2.205 3.71-5.398 0-2.82-2.03-4.788-4.922-4.788-3.354 0-5.32 2.517-5.32 5.117 0 1.015.388 2.103.873 2.696a.346.346 0 0 1 .078.427c-.066.286-.287.885-.392 1.104-.104.218-.217.243-.334.114C2.29 12.685 2 11.454 2 10.025 2 6.153 5.144 3 8.5 3 11.07 3 14 5.404 14 8.5c0 3.096-2.93 5.5-5.5 5.5-.943 0-1.816-.256-2.557-.683l-.737.552a.5.5 0 0 1-.683-.95l1.293-.97A7.942 7.942 0 0 0 8 0z"/>
            </svg>
            Undo
          </button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">Current Status</div>
        
        <div class="status-counters">
          <div class="counter-badge pending" id="pendingCount">0 pending</div>
          <div class="counter-badge completed" id="completedCount">0 completed</div>
        </div>
        
        <div class="table-header">
          <h3>Status Records</h3>
          <div>
            <span class="counter" id="statusCount">0 records</span>
            <button class="toggle-btn blink-toggle" id="toggleBlink">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
              Stop Blinking
            </button>
            <button class="toggle-btn" id="toggleRecords" style="display: none;">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
              </svg>
              Show All
            </button>
          </div>
        </div>
        
        <div class="table-container">
          <table id="statusTable">
            <thead>
              <tr>
                <th>Container #</th>
                <th>Compactor</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Duration</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="statusBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No records</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="footer">
      Compactor Progress Tracker v2.4 | Data is stored locally in your browser
    </div>
  </div>
<script>
const API_KEY = 'AIzaSyD7iPND2yyzqY1JyC5n1la7S5NnDwpNOVM';
const CLIENT_ID = '959994109190-rrpedrd8vg3es3meibc9gbim7a1r0254.apps.googleusercontent.com';
const SPREADSHEET_ID = '1w6suOx0R43BUGhi_ylAohNzj7j3Z_quO9k2yoJ5CcSo';
const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

let log = [];
let actionHistory = [];
let showAllRecords = false;
let showAllHourly = false;
let isBlinkingEnabled = true;
let updateInterval = null;
let syncInterval = null;
let accessToken = null;

function initializeApp() {
  // Restore data from localStorage
  const savedLog = localStorage.getItem('compactorLog');
  if (savedLog) {
    log = JSON.parse(savedLog);
  }

  const savedHistory = localStorage.getItem('compactorActionHistory');
  if (savedHistory) {
    actionHistory = JSON.parse(savedHistory);
  }

  updateStatusTable();
  updateHourlyTable();
  updateMachineButtonStates();
  document.getElementById('undoButton').disabled = actionHistory.length === 0;

  updateInterval = setInterval(updateStatusTable, 60000);
  syncInterval = setInterval(syncToGoogleSheets, 5 * 60 * 1000);

  // Wait for Google Identity Services to load before attempting sign-in
  checkGoogleIdentityServices().then(() => {
    if (!sessionStorage.getItem('loggedIn')) {
      requestAccessToken();
    } else {
      initClient();
    }
  }).catch(error => {
    console.error('Failed to load Google Identity Services:', error);
    document.getElementById('error').textContent = 'Failed to load Google Identity Services. Please refresh the page or check your network connection.';
  });
}

async function checkGoogleIdentityServices() {
  return new Promise((resolve, reject) => {
    const maxAttempts = 10;
    let attempts = 0;

    const check = () => {
      if (window.google && window.google.accounts && window.google.accounts.oauth2) {
        resolve();
      } else if (attempts < maxAttempts) {
        attempts++;
        setTimeout(check, 500);
      } else {
        reject(new Error('Google Identity Services not loaded after maximum attempts'));
      }
    };

    check();
  });
}

async function initClient() {
  try {
    if (!window.gapi) {
      throw new Error('Google API script not loaded');
    }

    if (!accessToken) {
      console.warn('No access token available. Requesting authentication...');
      document.getElementById('signInBtn').classList.remove('hidden');
      document.getElementById('error').textContent = 'Please sign in to initialize Google API.';
      return false;
    }

    await new Promise((resolve, reject) => {
      gapi.load('client', {
        callback: () => resolve(),
        onerror: () => reject(new Error('Failed to load gapi client')),
        timeout: 15000,
        ontimeout: () => reject(new Error('Google API load timeout'))
      });
    });

    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
    });

    // Set access token for all API calls
    gapi.client.setToken({ access_token: accessToken });

    // Verify worksheet existence
    const response = await gapi.client.sheets.spreadsheets.get({
      spreadsheetId: SPREADSHEET_ID,
      fields: 'sheets.properties.title'
    });
    const sheetTitles = response.result.sheets.map(sheet => sheet.properties.title);
    if (!sheetTitles.includes('Hourly') || !sheetTitles.includes('Status')) {
      throw new Error('Required worksheets "Hourly" and/or "Status" not found in the spreadsheet');
    }

    console.log('Google API client initialized successfully with write access');
    return true;
  } catch (error) {
    const errorDetails = error.result?.error?.message || error.result?.error?.details || error.message || JSON.stringify(error, null, 2);
    const errorCode = error.result?.error?.code || error.status || 'Unknown';
    console.error('Error initializing Google API:', {
      message: error.message,
      details: errorDetails,
      code: errorCode,
      result: error.result,
      stack: error.stack
    });
    document.getElementById('error').textContent = `Failed to initialize Google API (Code ${errorCode}): ${errorDetails}. Please check your API key, client ID, spreadsheet access (ensure the authenticated user has write permissions), or network connection.`;
    return false;
  }
}

function requestAccessToken() {
  if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
    console.error('Google Identity Services not loaded');
    document.getElementById('error').textContent = 'Google Identity Services not loaded. Please refresh the page or check your network connection.';
    return;
  }

  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPE,
    callback: (response) => {
      if (response.error) {
        console.error('Token request error:', response);
        document.getElementById('error').textContent = `Authentication failed: ${response.error_description || response.error || 'Unknown error'}. Please try again.`;
        accessToken = null;
      } else {
        accessToken = response.access_token;
        console.log('Access token received:', accessToken);
        document.getElementById('error').textContent = '';
        sessionStorage.setItem('loggedIn', 'true');
        document.getElementById('signInBtn').classList.add('hidden');
        initClient();
        syncToGoogleSheets();
      }
    },
  });

  tokenClient.requestAccessToken();
}

async function syncToGoogleSheets() {
  try {
    if (!accessToken) {
      console.warn('No access token. Requesting authentication...');
      document.getElementById('error').textContent = 'Please sign in to sync data to Google Sheets.';
      return false;
    }

    gapi.client.setToken({ access_token: accessToken });

    // Prepare Status Records
    const statusValues = log.map((entry, index) => [
      entry.entryTimestamp,
      log.length - index,
      entry.machineNumber,
      entry.inTime,
      entry.outTime || '',
      calculateDuration(entry.inTime, entry.outTime).display
    ]);

    // Prepare Hourly Records
    const timeSlots = [
      { start: '07:30', end: '08:29' },
      { start: '08:30', end: '09:29' },
      { start: '09:30', end: '10:29' },
      { start: '10:30', end: '11:29' },
      { start: '11:30', end: '12:29' },
      { start: '12:30', end: '13:29' },
      { start: '13:30', end: '14:29' },
      { start: '14:30', end: '15:29' },
      { start: '15:30', end: '16:29' },
      { start: '16:30', end: '17:29' },
      { start: '17:30', end: '18:29' },
      { start: '18:30', end: '19:29' },
      { start: '19:30', end: '20:29' },
      { start: '20:30', end: '21:29' },
      { start: '22:30', end: '23:29' },
      { start: '23:30', end: '00:29' },
      { start: '00:30', end: '01:29' },
      { start: '01:30', end: '02:29' },
      { start: '02:30', end: '03:29' },
      { start: '03:30', end: '04:29' },
      { start: '04:30', end: '05:29' },
      { start: '05:30', end: '06:29' }
    ];

    const parseTime = (timeStr, referenceDate = new Date()) => {
      const [hours, mins] = timeStr.split(':').map(Number);
      const date = new Date(referenceDate);
      date.setHours(hours, mins, 0, 0);
      if (hours < 7) date.setDate(date.getDate() + 1);
      return date;
    };

    const hourlyRecords = [];
    const completedEntries = log.filter(entry => entry.outTime);

    timeSlots.forEach(slot => {
      const slotStart = parseTime(slot.start);
      const slotEnd = parseTime(slot.end, slotStart);
      const machineCounts = Array(11).fill(0);

      completedEntries.forEach(entry => {
        const inTime = parseTime(entry.inTime);
        const outTime = parseTime(entry.outTime, inTime);

        if (inTime >= slotStart && outTime <= slotEnd) {
          machineCounts[entry.machineNumber]++;
        }
      });

      if (machineCounts.some(count => count > 0)) {
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        hourlyRecords.push([
          `${slot.start}-${slot.end}`,
          ...machineCounts.slice(1),
          total
        ]);
      }
    });

    const cumulativeCounts = Array(11).fill(0);
    completedEntries.forEach(entry => {
      cumulativeCounts[entry.machineNumber]++;
    });
    const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);
    if (cumulativeTotal > 0) {
      hourlyRecords.unshift(['Cumulative Total', ...cumulativeCounts.slice(1), cumulativeTotal]);
    }

    // Sync Status Records
    let retries = 3;
    while (retries > 0) {
      try {
        // Clear existing data in Status worksheet
        await gapi.client.sheets.spreadsheets.values.clear({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Status!A:F'
        });

        // Write new data to Status worksheet
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Status!A1',
          valueInputOption: 'RAW',
          resource: {
            values: [
              ['Timestamp', 'Container #', 'Compactor', 'In Time', 'Out Time', 'Duration'],
              ...statusValues
            ]
          }
        });

        // Sync Hourly Records
        await gapi.client.sheets.spreadsheets.values.clear({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Hourly!A:L'
        });

        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Hourly!A1',
          valueInputOption: 'RAW',
          resource: {
            values: [
              ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
              ...hourlyRecords
            ]
          }
        });

        // Generate and upload CSV files
        const statusCsvContent = [
          ['Timestamp', 'Container #', 'Compactor', 'In Time', 'Out Time', 'Duration'],
          ...statusValues
        ].map(row => row.join(',')).join('\n');

        const hourlyCsvContent = [
          ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
          ...hourlyRecords
        ].map(row => row.join(',')).join('\n');

        const statusBlob = new Blob([statusCsvContent], { type: 'text/csv;charset=utf-8;' });
        const hourlyBlob = new Blob([hourlyCsvContent], { type: 'text/csv;charset=utf-8;' });

        const statusFileName = generateCSVFilename('CPT_SR');
        const hourlyFileName = generateCSVFilename('CPT_HR');

        // Upload CSV files to Google Sheets (simulating file upload by appending to new sheets)
        const statusSheetName = statusFileName.replace('.csv', '');
        const hourlySheetName = hourlyFileName.replace('.csv', '');

        // Create new sheets for CSV data
        await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: SPREADSHEET_ID,
          resource: {
            requests: [
              { addSheet: { properties: { title: statusSheetName } } },
              { addSheet: { properties: { title: hourlySheetName } } }
            ]
          }
        });

        // Write CSV data to new sheets
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${statusSheetName}!A1`,
          valueInputOption: 'RAW',
          resource: { values: [ ['Timestamp', 'Container #', 'Compactor', 'In Time', 'Out Time', 'Duration'], ...statusValues ] }
        });

        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${hourlySheetName}!A1`,
          valueInputOption: 'RAW',
          resource: { values: [ ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'], ...hourlyRecords ] }
        });

        console.log('Data synced to Google Sheets and CSV files uploaded:', statusSheetName, hourlySheetName);
        document.getElementById('error').textContent = '';
        return true;
      } catch (error) {
        if ((error.status === 429 || error.result?.error?.code === 429) && retries > 0) {
          const delay = (4 - retries) * 2000;
          console.warn(`Rate limit hit (429). Retrying in ${delay}ms...`);
          await new Promise(resolve => setTimeout(resolve, delay));
          retries--;
        } else if (error.status === 401 || error.result?.error?.code === 401) {
          console.warn('Access token invalid or expired. Requesting new token...');
          document.getElementById('signInBtn').classList.remove('hidden');
          accessToken = null;
          sessionStorage.removeItem('loggedIn');
          document.getElementById('error').textContent = 'Session expired. Please sign in again.';
          return false;
        } else if (error.status === 403 || error.result?.error?.code === 403) {
          throw new Error('Permission denied: Ensure the authenticated user has write access to the spreadsheet');
        } else if (error.status === 400 || error.result?.error?.code === 400) {
          throw new Error('Bad request: Check spreadsheet ID and worksheet ranges (Status!A:F, Hourly!A:L)');
        } else {
          throw error;
        }
      }
    }

    throw new Error('Failed to sync after retries');
  } catch (error) {
    const errorDetails = error.result?.error?.message || error.result?.error?.details || error.message || JSON.stringify(error, null, 2);
    const errorCode = error.result?.error?.code || error.status || 'Unknown';
    console.error('Error syncing to Google Sheets:', {
      message: error.message,
      details: errorDetails,
      code: errorCode,
      result: error.result,
      stack: error.stack
    });
    document.getElementById('error').textContent = `Failed to sync data to Google Sheets (Code ${errorCode}): ${errorDetails}. Please verify spreadsheet ID, worksheet names (Hourly, Status), write permissions for the authenticated user, or try again.`;
    return false;
  }
}

function generateCSVFilename(prefix) {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const seconds = String(now.getSeconds()).padStart(2, '0');
  return `${prefix}_${year}${month}${day}_${hours}${minutes}${seconds}.csv`;
}

function exportToCSV() {
  try {
    // Generate Status CSV
    const statusRows = [
      ['Timestamp', 'Container #', 'Compactor', 'In Time', 'Out Time', 'Duration'],
      ...log.map((entry, index) => [
        entry.entryTimestamp,
        log.length - index,
        entry.machineNumber,
        entry.inTime,
        entry.outTime || '',
        calculateDuration(entry.inTime, entry.outTime).display
      ])
    ];

    const statusCsvContent = statusRows.map(row => row.join(',')).join('\n');
    const statusBlob = new Blob([statusCsvContent], { type: 'text/csv;charset=utf-8;' });
    const statusUrl = URL.createObjectURL(statusBlob);
    const statusLink = document.createElement('a');
    statusLink.setAttribute('href', statusUrl);
    statusLink.setAttribute('download', generateCSVFilename('CPT_SR'));
    document.body.appendChild(statusLink);
    statusLink.click();
    document.body.removeChild(statusLink);
    URL.revokeObjectURL(statusUrl);

    // Generate Hourly CSV
    const timeSlots = [
      { start: '07:30', end: '08:29' },
      { start: '08:30', end: '09:29' },
      { start: '09:30', end: '10:29' },
      { start: '10:30', end: '11:29' },
      { start: '11:30', end: '12:29' },
      { start: '12:30', end: '13:29' },
      { start: '13:30', end: '14:29' },
      { start: '14:30', end: '15:29' },
      { start: '15:30', end: '16:29' },
      { start: '16:30', end: '17:29' },
      { start: '17:30', end: '18:29' },
      { start: '18:30', end: '19:29' },
      { start: '19:30', end: '20:29' },
      { start: '20:30', end: '21:29' },
      { start: '21:30', end: '22:29' },
      { start: '22:30', end: '23:29' },
      { start: '23:30', end: '00:29' },
      { start: '00:30', end: '01:29' },
      { start: '01:30', end: '02:29' },
      { start: '02:30', end: '03:29' },
      { start: '03:30', end: '04:29' },
      { start: '04:30', end: '05:29' },
      { start: '05:30', end: '06:29' }
    ];

    const parseTime = (timeStr, referenceDate = new Date()) => {
      const [hours, mins] = timeStr.split(':').map(Number);
      const date = new Date(referenceDate);
      date.setHours(hours, mins, 0, 0);
      if (hours < 7) date.setDate(date.getDate() + 1);
      return date;
    };

    const hourlyRecords = [];
    const completedEntries = log.filter(entry => entry.outTime);

    timeSlots.forEach(slot => {
      const slotStart = parseTime(slot.start);
      const slotEnd = parseTime(slot.end, slotStart);
      const machineCounts = Array(11).fill(0);

      completedEntries.forEach(entry => {
        const inTime = parseTime(entry.inTime);
        const outTime = parseTime(entry.outTime, inTime);

        if (inTime >= slotStart && outTime <= slotEnd) {
          machineCounts[entry.machineNumber]++;
        }
      });

      if (machineCounts.some(count => count > 0)) {
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        hourlyRecords.push([
          `${slot.start}-${slot.end}`,
          ...machineCounts.slice(1),
          total
        ]);
      }
    });

    const cumulativeCounts = Array(11).fill(0);
    completedEntries.forEach(entry => {
      cumulativeCounts[entry.machineNumber]++;
    });
    const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);
    if (cumulativeTotal > 0) {
      hourlyRecords.unshift(['Cumulative Total', ...cumulativeCounts.slice(1), cumulativeTotal]);
    }

    const hourlyCsvContent = [
      ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
      ...hourlyRecords
    ].map(row => row.join(',')).join('\n');

    const hourlyBlob = new Blob([hourlyCsvContent], { type: 'text/csv;charset=utf-8;' });
    const hourlyUrl = URL.createObjectURL(hourlyBlob);
    const hourlyLink = document.createElement('a');
    hourlyLink.setAttribute('href', hourlyUrl);
    hourlyLink.setAttribute('download', generateCSVFilename('CPT_HR'));
    document.body.appendChild(hourlyLink);
    hourlyLink.click();
    document.body.removeChild(hourlyLink);
    URL.revokeObjectURL(hourlyUrl);

    // Sync to Google Sheets
    syncToGoogleSheets();
  } catch (error) {
    console.error('Error exporting to CSV:', error);
    document.getElementById('error').textContent = 'An error occurred while exporting data. Please try again.';
  }
}

function updateStatusTable() {
  const statusBody = document.getElementById('statusBody');
  const statusCount = document.getElementById('statusCount');
  const pendingCount = document.getElementById('pendingCount');
  const completedCount = document.getElementById('completedCount');
  const toggleButton = document.getElementById('toggleRecords');

  const pendingRecords = log.filter(entry => !entry.outTime).length;
  const completedRecords = log.filter(entry => entry.outTime).length;

  statusCount.textContent = `${log.length} records`;
  pendingCount.textContent = `${pendingRecords} pending`;
  completedCount.textContent = `${completedRecords} completed`;

  toggleButton.style.display = log.length > 10 ? 'flex' : 'none';
  toggleButton.innerHTML = `
    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
    </svg>
    ${showAllRecords ? 'Show Less' : 'Show All'}
  `;

  if (log.length === 0) {
    statusBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #6c757d;">No records</td></tr>`;
    return;
  }

  log.sort((a, b) => new Date(b.entryTimestamp) - new Date(a.entryTimestamp));
  const displayEntries = showAllRecords ? log : log.slice(0, 10);

  statusBody.innerHTML = '';

  displayEntries.forEach((entry, index) => {
    const row = document.createElement('tr');
    row.className = 'status-row';

    const { display, minutes } = calculateDuration(entry.inTime, entry.outTime);
    const blinkClass = isBlinkingEnabled && !entry.outTime && minutes > 39 ? 'blink' : '';
    const containerNumber = log.length - (showAllRecords ? index : index);
    const entryIndex = log.indexOf(entry);

    row.innerHTML = `
      <td>${containerNumber}</td>
      <td class="${blinkClass}">${entry.machineNumber}</td>
      <td class="time-cell" onclick="editEntry(${entry.machineNumber}, '${entry.entryTimestamp.replace(/'/g, "\\'")}', 'inTime')">${entry.inTime}</td>
      <td class="time-cell" onclick="${entry.outTime ? `editEntry(${entry.machineNumber}, '${entry.entryTimestamp.replace(/'/g, "\\'")}', 'outTime')` : `promptOutTime(${entryIndex})`}">
        ${entry.outTime || '-'}
      </td>
      <td>${display}</td>
      <td>
        <svg class="delete-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" onclick="deleteEntry(${entry.machineNumber}, '${entry.entryTimestamp.replace(/'/g, "\\'")}')">
          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
        </svg>
      </td>
    `;

    statusBody.appendChild(row);
  });
}

function updateHourlyTable() {
  const hourlyBody = document.getElementById('hourlyBody');
  const hourlyCount = document.getElementById('hourlyCount');
  const toggleButton = document.getElementById('toggleHourly');
  const cumulativeRow = document.getElementById('cumulativeRow');

  const timeSlots = [
    { start: '07:30', end: '08:29' },
    { start: '08:30', end: '09:29' },
    { start: '09:30', end: '10:29' },
    { start: '10:30', end: '11:29' },
    { start: '11:30', end: '12:29' },
    { start: '12:30', end: '13:29' },
    { start: '13:30', end: '14:29' },
    { start: '14:30', end: '15:29' },
    { start: '15:30', end: '16:29' },
    { start: '16:30', end: '17:29' },
    { start: '17:30', end: '18:29' },
    { start: '18:30', end: '19:29' },
    { start: '19:30', end: '20:29' },
    { start: '20:30', end: '21:29' },
    { start: '21:30', end: '22:29' },
    { start: '22:30', end: '23:29' },
    { start: '23:30', end: '00:29' },
    { start: '00:30', end: '01:29' },
    { start: '01:30', end: '02:29' },
    { start: '02:30', end: '03:29' },
    { start: '03:30', end: '04:29' },
    { start: '04:30', end: '05:29' },
    { start: '05:30', end: '06:29' }
  ];

  const parseTime = (timeStr, referenceDate = new Date()) => {
    const [hours, mins] = timeStr.split(':').map(Number);
    const date = new Date(referenceDate);
    date.setHours(hours, mins, 0, 0);
    if (hours < 7) date.setDate(date.getDate() + 1);
    return date;
  };

  const hourlyRecords = [];
  const completedEntries = log.filter(entry => entry.outTime);

  timeSlots.forEach(slot => {
    const slotStart = parseTime(slot.start);
    const slotEnd = parseTime(slot.end, slotStart);
    const machineCounts = Array(11).fill(0);

    completedEntries.forEach(entry => {
      const inTime = parseTime(entry.inTime);
      const outTime = parseTime(entry.outTime, inTime);

      if (inTime >= slotStart && outTime <= slotEnd) {
        machineCounts[entry.machineNumber]++;
      }
    });

    if (machineCounts.some(count => count > 0)) {
      hourlyRecords.push({
        timeSlot: `${slot.start}-${slot.end}`,
        machineCounts,
        startTime: slotStart
      });
    }
  });

  hourlyCount.textContent = `${hourlyRecords.length} hours`;
  toggleButton.style.display = hourlyRecords.length > 5 ? 'flex' : 'none';
  toggleButton.innerHTML = `
    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
    </svg>
    ${showAllHourly ? 'Show Less' : 'Show All'}
  `;

  const cumulativeCounts = Array(11).fill(0);
  completedEntries.forEach(entry => {
    cumulativeCounts[entry.machineNumber]++;
  });
  const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);

  if (cumulativeTotal > 0) {
    cumulativeRow.style.display = 'table-row';
    cumulativeRow.innerHTML = `
      <th>Cumulative Total</th>
      ${cumulativeCounts.slice(1).map(count => `<th>${count}</th>`).join('')}
      <th>${cumulativeTotal}</th>
    `;
  } else {
    cumulativeRow.style.display = 'none';
    cumulativeRow.innerHTML = `
      <th>Cumulative Total</th>
      ${Array(10).fill().map(() => `<th>0</th>`).join('')}
      <th>0</th>
    `;
  }

  hourlyBody.innerHTML = '';

  if (hourlyRecords.length === 0) {
    hourlyBody.innerHTML = `<tr><td colspan="12" style="text-align: center; color: #6c757d;">No hourly records</td></tr>`;
    return;
  }

  hourlyRecords.sort((a, b) => b.startTime - a.startTime);
  const displayRecords = showAllHourly ? hourlyRecords : hourlyRecords.slice(0, 5);

  displayRecords.forEach(record => {
    const row = document.createElement('tr');
    const total = record.machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
    row.innerHTML = `
      <td>${record.timeSlot}</td>
      ${record.machineCounts.slice(1).map(count => `<td>${count}</td>`).join('')}
      <td class="total-cell">${total}</td>
    `;
    hourlyBody.appendChild(row);
  });
}

function updateMachineButtonStates() {
  document.querySelectorAll('.compactor-btn').forEach(button => {
    const machineNum = parseInt(button.getAttribute('data-machine'));
    const hasActiveSession = log.some(entry => 
      entry.machineNumber === machineNum && !entry.outTime
    );
    button.classList.toggle('active', hasActiveSession);
  });
}

function calculateDuration(inTime, outTime = null) {
  const parseTime = timeStr => {
    const [hours, mins] = timeStr.split(':').map(Number);
    const date = new Date();
    date.setHours(hours, mins, 0, 0);
    if (hours < 7) date.setDate(date.getDate() + 1);
    return date;
  };

  try {
    const start = parseTime(inTime);
    const end = outTime ? parseTime(outTime) : new Date();

    if (end < start) {
      end.setDate(end.getDate() + 1);
    }

    const diffMs = end - start;
    const diffMins = Math.floor(diffMs / 60000);
    const hours = Math.floor(diffMins / 60);
    const mins = diffMins % 60;

    return {
      display: `${hours}h ${mins}m`,
      minutes: diffMins
    };
  } catch {
    return { display: 'N/A', minutes: 0 };
  }
}

function handleMachineButtonClick(machineNum) {
  try {
    const errorDiv = document.getElementById('error');
    const currentTime = new Date().toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false,
      timeZone: 'Asia/Hong_Kong'
    }).replace("24:", "00:");

    const existingEntry = log.find(entry => 
      entry.machineNumber === machineNum && !entry.outTime
    );

    if (existingEntry) {
      const { minutes } = calculateDuration(existingEntry.inTime);
      if (minutes < 40) {
        errorDiv.textContent = `Cannot complete compacting on machine ${machineNum} yet. Minimum 40 minutes required (current: ${minutes} minutes).`;
        return;
      }

      existingEntry.outTime = currentTime;
      existingEntry.entryTimestamp = new Date().toISOString();

      actionHistory.push({
        type: 'outTime',
        machineNumber: machineNum,
        timestamp: existingEntry.entryTimestamp,
        previousState: { ...existingEntry, outTime: null }
      });

      errorDiv.textContent = '';
      document.getElementById('undoButton').disabled = false;

      localStorage.setItem('compactorLog', JSON.stringify(log));
      localStorage.setItem('compactorActionHistory', JSON.stringify(actionHistory));
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      syncToGoogleSheets();
    } else {
      const newEntry = {
        machineNumber: machineNum,
        inTime: currentTime,
        outTime: null,
        entryTimestamp: new Date().toISOString()
      };

      log.push(newEntry);
      actionHistory.push({
        type: 'inTime',
        machineNumber: machineNum,
        timestamp: newEntry.entryTimestamp,
        previousState: null
      });

      errorDiv.textContent = '';
      document.getElementById('undoButton').disabled = false;

      localStorage.setItem('compactorLog', JSON.stringify(log));
      localStorage.setItem('compactorActionHistory', JSON.stringify(actionHistory));
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      syncToGoogleSheets();
    }
  } catch (error) {
    console.error('Error handling machine button click:', error);
    document.getElementById('error').textContent = 'An error occurred while processing the machine action. Please try again.';
  }
}

function promptOutTime(index) {
  try {
    const entry = log[index];
    if (!entry || entry.outTime) return;

    const currentTime = new Date().toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false,
      timeZone: 'Asia/Hong_Kong'
    }).replace("24:", "00:");

    const { minutes } = calculateDuration(entry.inTime);
    if (minutes < 40) {
      document.getElementById('error').textContent = `Cannot complete compacting on machine ${entry.machineNumber} yet. Minimum 40 minutes required (current: ${minutes} minutes).`;
      return;
    }

    const timeInput = prompt('Enter Out Time (HH:MM, 24-hour format):', currentTime);
    if (!timeInput) return;

    const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
    if (!timeRegex.test(timeInput)) {
      document.getElementById('error').textContent = 'Invalid time format. Please use HH:MM (24-hour format).';
      return;
    }

    entry.outTime = timeInput;
    entry.entryTimestamp = new Date().toISOString();

    actionHistory.push({
      type: 'outTime',
      machineNumber: entry.machineNumber,
      timestamp: entry.entryTimestamp,
      previousState: { ...entry, outTime: null }
    });

    document.getElementById('error').textContent = '';
    document.getElementById('undoButton').disabled = false;

    localStorage.setItem('compactorLog', JSON.stringify(log));
    localStorage.setItem('compactorActionHistory', JSON.stringify(actionHistory));
    updateStatusTable();
    updateHourlyTable();
    updateMachineButtonStates();
    syncToGoogleSheets();
  } catch (error) {
    console.error('Error prompting out time:', error);
    document.getElementById('error').textContent = 'An error occurred while setting out time. Please try again.';
  }
}

function editEntry(machineNumber, entryTimestamp, field) {
  try {
    const entry = log.find(e => 
      e.machineNumber === machineNumber && e.entryTimestamp === entryTimestamp
    );
    if (!entry) {
      document.getElementById('error').textContent = 'Entry not found.';
      return;
    }

    const currentValue = field === 'inTime' ? entry.inTime : entry.outTime;
    const newTime = prompt(`Enter new ${field === 'inTime' ? 'In' : 'Out'} Time (HH:MM, 24-hour format):`, currentValue);
    if (!newTime) return;

    const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
    if (!timeRegex.test(newTime)) {
      document.getElementById('error').textContent = 'Invalid time format. Please use HH:MM (24-hour format).';
      return;
    }

    if (field === 'outTime' && entry.inTime) {
      const inTimeDate = parseTime(entry.inTime);
      const outTimeDate = parseTime(newTime, inTimeDate);
      if (outTimeDate < inTimeDate) {
        outTimeDate.setDate(outTimeDate.getDate() + 1);
      }
      const duration = calculateDuration(entry.inTime, newTime).minutes;
      if (duration < 40) {
        document.getElementById('error').textContent = `Out time must be at least 40 minutes after in time (current: ${duration} minutes).`;
        return;
      }
    }

    actionHistory.push({
      type: 'edit',
      machineNumber,
      timestamp: entryTimestamp,
      previousState: { ...entry }
    });

    if (field === 'inTime') {
      entry.inTime = newTime;
    } else {
      entry.outTime = newTime;
    }
    entry.entryTimestamp = new Date().toISOString();

    document.getElementById('error').textContent = '';
    document.getElementById('undoButton').disabled = false;

    localStorage.setItem('compactorLog', JSON.stringify(log));
    localStorage.setItem('compactorActionHistory', JSON.stringify(actionHistory));
    updateStatusTable();
    updateHourlyTable();
    updateMachineButtonStates();
    syncToGoogleSheets();
  } catch (error) {
    console.error('Error editing entry:', error);
    document.getElementById('error').textContent = 'An error occurred while editing the entry. Please try again.';
  }
}

function deleteEntry(machineNumber, entryTimestamp) {
  try {
    const entryIndex = log.findIndex(e => 
      e.machineNumber === machineNumber && e.entryTimestamp === entryTimestamp
    );
    if (entryIndex === -1) {
      document.getElementById('error').textContent = 'Entry not found.';
      return;
    }

    const entry = log[entryIndex];
    actionHistory.push({
      type: 'delete',
      machineNumber,
      timestamp: entryTimestamp,
      previousState: { ...entry }
    });

    log.splice(entryIndex, 1);

    document.getElementById('error').textContent = '';
    document.getElementById('undoButton').disabled = false;

    localStorage.setItem('compactorLog', JSON.stringify(log));
    localStorage.setItem('compactorActionHistory', JSON.stringify(actionHistory));
    updateStatusTable();
    updateHourlyTable();
    updateMachineButtonStates();
    syncToGoogleSheets();
  } catch (error) {
    console.error('Error deleting entry:', error);
    document.getElementById('error').textContent = 'An error occurred while deleting the entry. Please try again.';
  }
}

function clearAllData() {
  try {
    if (log.length === 0) {
      document.getElementById('error').textContent = 'No data to clear.';
      return;
    }

    actionHistory.push({
      type: 'clear',
      previousState: [...log]
    });

    log = [];
    localStorage.removeItem('compactorLog');

    document.getElementById('error').textContent = 'All data cleared.';
    document.getElementById('undoButton').disabled = false;

    localStorage.setItem('compactorActionHistory', JSON.stringify(actionHistory));
    updateStatusTable();
    updateHourlyTable();
    updateMachineButtonStates();
    syncToGoogleSheets();
  } catch (error) {
    console.error('Error clearing data:', error);
    document.getElementById('error').textContent = 'An error occurred while clearing data. Please try again.';
  }
}

function undoLastAction() {
  try {
    if (actionHistory.length === 0) {
      document.getElementById('error').textContent = 'No actions to undo.';
      return;
    }

    const lastAction = actionHistory.pop();
    switch (lastAction.type) {
      case 'inTime':
        log = log.filter(e => 
          !(e.machineNumber === lastAction.machineNumber && e.entryTimestamp === lastAction.timestamp)
        );
        break;

      case 'outTime':
      case 'edit':
        const entryIndex = log.findIndex(e => 
          e.machineNumber === lastAction.machineNumber && e.entryTimestamp === lastAction.timestamp
        );
        if (entryIndex !== -1) {
          log[entryIndex] = { ...lastAction.previousState };
        }
        break;

      case 'delete':
        log.push({ ...lastAction.previousState });
        break;

      case 'clear':
        log = [...lastAction.previousState];
        break;

      default:
        console.warn('Unknown action type:', lastAction.type);
        return;
    }

    document.getElementById('error').textContent = 'Last action undone.';
    document.getElementById('undoButton').disabled = actionHistory.length === 0;

    localStorage.setItem('compactorLog', JSON.stringify(log));
    localStorage.setItem('compactorActionHistory', JSON.stringify(actionHistory));
    updateStatusTable();
    updateHourlyTable();
    updateMachineButtonStates();
    syncToGoogleSheets();
  } catch (error) {
    console.error('Error undoing action:', error);
    document.getElementById('error').textContent = 'An error occurred while undoing the last action. Please try again.';
  }
}

function toggleRecords() {
  showAllRecords = !showAllRecords;
  updateStatusTable();
}

function toggleHourly() {
  showAllHourly = !showAllHourly;
  updateHourlyTable();
}

function toggleBlink() {
  isBlinkingEnabled = !isBlinkingEnabled;
  document.getElementById('toggleBlink').innerHTML = `
    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="${isBlinkingEnabled ? 'M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z' : 'M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z'}"/>
      <path d="${isBlinkingEnabled ? 'M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z' : 'M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z'}"/>
    </svg>
    ${isBlinkingEnabled ? 'Stop Blinking' : 'Start Blinking'}
  `;
  updateStatusTable();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();

  document.querySelectorAll('.compactor-btn').forEach(button => {
    button.addEventListener('click', () => {
      const machineNum = parseInt(button.getAttribute('data-machine'));
      handleMachineButtonClick(machineNum);
    });
  });

  document.getElementById('exportButton').addEventListener('click', exportToCSV);
  document.getElementById('clearButton').addEventListener('click', clearAllData);
  document.getElementById('undoButton').addEventListener('click', undoLastAction);
  document.getElementById('toggleRecords').addEventListener('click', toggleRecords);
  document.getElementById('toggleHourly').addEventListener('click', toggleHourly);
  document.getElementById('toggleBlink').addEventListener('click', toggleBlink);
  document.getElementById('signInBtn').addEventListener('click', requestAccessToken);
});

// Cleanup on window unload
window.addEventListener('unload', () => {
  if (updateInterval) clearInterval(updateInterval);
  if (syncInterval) clearInterval(syncInterval);
});
</script>
</body>
</html>
