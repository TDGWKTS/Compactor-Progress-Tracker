<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compactor Progress Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 1200px; margin: auto; }
    .machine-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .machine-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .machine-button:hover { background-color: #0056b3; }
    .machine-button.active { background-color: #28a745; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; }
    .control-button { padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .control-button:hover { background-color: #c82333; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #007bff; color: white; }
    .error { color: red; margin: 10px 0; }
    .footer { text-align: center; margin-top: 20px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Compactor Progress Tracker</h1>
    <div class="machine-buttons" id="machineButtons"></div>
    <div class="controls">
      <button class="control-button" onclick="undoLastAction()">Undo</button>
      <button class="control-button" onclick="clearData()">Clear Data</button>
      <button class="control-button" onclick="exportToCSV()">Export to CSV</button>
    </div>
    <div class="error" id="error"></div>
    <h2>Current Status</h2>
    <table id="statusTable">
      <thead>
        <tr>
          <th>No. of Container</th>
          <th>Compactor</th>
          <th>In Time</th>
          <th>Out Time</th>
          <th>Duration</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h2>Hourly Records</h2>
    <table id="hourlyTable">
      <thead>
        <tr>
          <th>Time Slot</th>
          <th>Machine 1</th>
          <th>Machine 2</th>
          <th>Machine 3</th>
          <th>Machine 4</th>
          <th>Machine 5</th>
          <th>Machine 6</th>
          <th>Machine 7</th>
          <th>Machine 8</th>
          <th>Machine 9</th>
          <th>Machine 10</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="footer">
      Compactor Progress Tracker v2.4 | Data is stored locally in your browser | <span id="lastSync">Last synced: None</span>
    </div>
  </div>

  
   <script>
    // Configuration
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzx-lh6_AQ_Ky7ijNLy8Xt_sk830aledU1ok69wBt_t0lMKCK8t8CTp3CQdoe1ehbMysg/exec';
    const SYNC_INTERVAL = 30000; // 30 seconds
    let syncTimeout = null;
    let lastSyncTime = null;

    // In-memory log to track entries and action history for undo
    let log = [];
    let actionHistory = [];
    let showAllRecords = false;
    let showAllHourly = false;
    let isBlinkingEnabled = true;
    let updateInterval = null;

    // Initialize with no sample data
    function initializeSampleData() {
      log = [];
      actionHistory = [];
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      document.getElementById('undoButton').disabled = true;
      
      // Start dynamic updates every 60 seconds
      updateInterval = setInterval(updateStatusTable, 60000);
      
      // Start Google Sheets sync every 30 seconds
      startSyncTimer();
      
      // Load initial data from Google Sheets
      loadFromGoogleSheets();
    }
    
    // Start the sync timer
    function startSyncTimer() {
      if (syncTimeout) clearTimeout(syncTimeout);
      syncTimeout = setTimeout(() => {
        syncWithGoogleSheets();
        startSyncTimer();
      }, SYNC_INTERVAL);
    }
    
    // Load data from Google Sheets
    async function loadFromGoogleSheets() {
      try {
        showSyncStatus('Loading data from Google Sheets...');
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=load`);
        const data = await response.json();
        
        if (data.status === 'success') {
          log = data.completedRecords.map(record => ({
            machineNumber: parseInt(record[0]),
            inTime: record[1],
            outTime: record[2] || '',
            entryTimestamp: record[3] || new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' })
          }));
          
          updateStatusTable();
          updateHourlyTable();
          updateMachineButtonStates();
          lastSyncTime = new Date();
          showSyncStatus('Data loaded successfully', 'success');
        } else {
          throw new Error(data.message || 'Failed to load data');
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showSyncStatus('Error loading data', 'error');
      }
    }
    
    // Sync data with Google Sheets
    async function syncWithGoogleSheets() {
      try {
        showSyncStatus('Syncing with Google Sheets...');
        
        // Prepare status data
        const statusData = log.map(entry => [
          entry.machineNumber,
          entry.inTime,
          entry.outTime,
          entry.entryTimestamp
        ]);
        
        // Prepare hourly data
        const timeSlots = [
          { start: '07:30', end: '08:29' },
          { start: '08:30', end: '09:29' },
          { start: '09:30', end: '10:29' },
          { start: '10:30', end: '11:29' },
          { start: '11:30', end: '12:29' },
          { start: '12:30', end: '13:29' },
          { start: '13:30', end: '14:29' },
          { start: '14:30', end: '15:29' },
          { start: '15:30', end: '16:29' },
          { start: '16:30', end: '17:29' },
          { start: '17:30', end: '18:29' },
          { start: '18:30', end: '19:29' },
          { start: '19:30', end: '20:29' },
          { start: '20:30', end: '21:29' },
          { start: '21:30', end: '22:29' },
          { start: '22:30', end: '23:29' },
          { start: '23:30', end: '00:29' },
          { start: '00:30', end: '01:29' },
          { start: '01:30', end: '02:29' },
          { start: '02:30', end: '03:29' },
          { start: '03:30', end: '04:29' },
          { start: '04:30', end: '05:29' },
          { start: '05:30', end: '06:29' }
        ];
        
        const parseTime = (timeStr, referenceDate = new Date()) => {
          const [hours, minutes] = timeStr.split(':').map(Number);
          const date = new Date(referenceDate);
          date.setHours(hours, minutes, 0, 0);
          if (hours < 7) date.setDate(date.getDate() + 1);
          return date;
        };
        
        const hourlyData = [];
        const completedEntries = log.filter(entry => entry.outTime);
        
        timeSlots.forEach(slot => {
          const slotStart = parseTime(slot.start);
          const slotEnd = parseTime(slot.end, slotStart);
          const machineCounts = Array(11).fill(0); // Index 0 unused, 1-10 for machines
          
          completedEntries.forEach(entry => {
            const inTime = parseTime(entry.inTime);
            const outTime = parseTime(entry.outTime, inTime);
            
            if (inTime >= slotStart && outTime <= slotEnd) {
              machineCounts[entry.machineNumber]++;
            }
          });
          
          hourlyData.push([
            `${slot.start}-${slot.end}`,
            ...machineCounts.slice(1),
            machineCounts.slice(1).reduce((sum, count) => sum + count, 0)
          ]);
        });
        
        // Send data to Google Sheets
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'sync',
            statusData: statusData,
            hourlyData: hourlyData
          })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
          lastSyncTime = new Date();
          showSyncStatus('Data synced successfully', 'success');
        } else {
          throw new Error(result.message || 'Sync failed');
        }
      } catch (error) {
        console.error('Error syncing data:', error);
        showSyncStatus('Sync failed: ' + error.message, 'error');
      }
    }
    
    // Show sync status notification
    function showSyncStatus(message, type = 'info') {
      const statusElement = document.getElementById('syncStatus');
      statusElement.textContent = message;
      statusElement.style.display = 'block';
      statusElement.style.backgroundColor = type === 'error' ? '#d32f2f' : 
                                          type === 'success' ? '#388e3c' : 
                                          '#1976d2';
      
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 3000);
    }

    // [All other existing functions remain exactly the same]
    
    // Initialize sample data and attach event listeners when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeSampleData();
    
      // Attach event listeners to buttons
      document.getElementById('exportButton').addEventListener('click', exportToCSV);
      document.getElementById('clearButton').addEventListener('click', clearAllData);
      document.getElementById('undoButton').addEventListener('click', undoLastAction);
      document.getElementById('toggleBlink').addEventListener('click', toggleBlinking);
      document.getElementById('toggleHourly').addEventListener('click', toggleHourlyRecords);
      document.getElementById('toggleRecords').addEventListener('click', toggleRecords);
    
      // Attach event listeners to machine buttons
      document.querySelectorAll('.compactor-btn').forEach(button => {
        button.addEventListener('click', () => {
          const machineNum = parseInt(button.getAttribute('data-machine'));
          handleMachineButtonClick(machineNum);
          
          // Trigger immediate sync after user action
          syncWithGoogleSheets();
        });
      });
    
      // Clean up interval on page unload
      window.addEventListener('unload', () => {
        if (updateInterval) clearInterval(updateInterval);
        if (syncTimeout) clearTimeout(syncTimeout);
      });
    });
    
    // [All other existing functions remain exactly the same]
  </script>
</body>
</html>
