<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compactor Progress Tracker</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: clamp(10px, 2vw, 15px);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      height: auto;
      color: #333;
      line-height: 1.5;
      font-size: clamp(14px, 2.5vw, 16px);
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Cover Page Styles */
    #cover-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .login-container {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      padding: 30px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-container h1 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    .login-container p {
      color: #6c757d;
      margin-bottom: 30px;
    }

    .password-input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .password-input:focus {
      border-color: #4CAF50;
      outline: none;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .login-btn:hover {
      background-color: #45a049;
    }

    .error-message {
      color: #e74c3c;
      margin-top: 10px;
      font-weight: bold;
      min-height: 20px;
    }

    /* Main Container Styles */
    #main-container {
      display: none;
    }

    .container {
      max-width: min(1400px, 95vw);
      margin: 0 auto;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      padding: clamp(15px, 2.5vw, 20px);
      position: relative;
      flex-grow: 1;
      height: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800);
    }

    header {
      text-align: center;
      margin-bottom: clamp(15px, 3vw, 25px);
      position: relative;
    }

    h1 {
      color: #2c3e50;
      margin: clamp(10px, 2vw, 15px) 0;
      font-weight: 600;
      position: relative;
      padding-bottom: 15px;
      font-size: clamp(1.5rem, 5vw, 2rem);
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(60px, 10vw, 80px);
      height: 4px;
      background: linear-gradient(90deg, #4CAF50, #2196F3);
      border-radius: 2px;
    }

    .logout-btn {
      background: none;
      border: 1px solid #e74c3c;
      color: #e74c3c;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .logout-btn:hover {
      background-color: #e74c3c;
      color: white;
    }

    .dashboard {
      display: flex;
      flex-direction: column;
      gap: clamp(15px, 3vw, 25px);
      margin-bottom: clamp(15px, 3vw, 25px);
      flex-grow: 1;
    }

    @media (min-width: 768px) {
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: clamp(10px, 2vw, 20px);
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
      width: 100%;
      overflow: visible;
      flex-grow: 0;
      min-height: 0;
      overflow-y: auto;
    }

    .card-header {
      font-size: clamp(1rem, 3vw, 1.25rem);
      font-weight: 600;
      margin-bottom: clamp(10px, 2vw, 15px);
      color: #2c3e50;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .compactor-grid {
      display: grid;
      grid-template-rows: repeat(2, auto);
      grid-template-columns: repeat(5, minmax(50px, 1fr));
      grid-template-areas: 
        "b1 b2 b3 b4 b5"
        "b6 b7 b8 b9 b10";
      gap: clamp(8px, 1.5vw, 12px);
      margin-bottom: clamp(10px, 2vw, 20px);
    }

    .compactor-btn[data-machine="1"] { grid-area: b1; }
    .compactor-btn[data-machine="2"] { grid-area: b2; }
    .compactor-btn[data-machine="3"] { grid-area: b3; }
    .compactor-btn[data-machine="4"] { grid-area: b4; }
    .compactor-btn[data-machine="5"] { grid-area: b5; }
    .compactor-btn[data-machine="6"] { grid-area: b6; }
    .compactor-btn[data-machine="7"] { grid-area: b7; }
    .compactor-btn[data-machine="8"] { grid-area: b8; }
    .compactor-btn[data-machine="9"] { grid-area: b9; }
    .compactor-btn[data-machine="10"] { grid-area: b10; }

    .compactor-btn {
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(14px, 2.5vw, 18px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #4CAF50;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      touch-action: manipulation;
    }

    .compactor-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .compactor-btn.active {
      background-color: #6c757d;
      transform: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .error {
      color: #e74c3c;
      font-size: clamp(0.9rem, 2vw, 1rem);
      margin: clamp(10px, 1vw, 10px) 0;
      min-height: 24px;
      font-weight: bold;
      text-align: center;
    }

    .table-container {
      overflow-x: auto;
      overflow-y: auto;
      margin-top: clamp(10px, 2vw, 20px);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      width: 100%;
      max-height: 400px;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      table-layout: fixed;
      min-width: 600px;
    }

    th {
      background-color: #f1f5f9;
      padding: clamp(4px, 1vw, 8px);
      text-align: center;
      font-weight: 600;
      color: #2c3e50;
      border: 1px solid #d1d5db;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
    }

    td {
      padding: clamp(4px, 1vw, 8px);
      border: 1px solid #d1d5db;
      color: #4a5568;
      text-align: center;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #hourlyTable th:nth-child(1),
    #hourlyTable td:nth-child(1) {
      width: clamp(80px, 15vw, 100px);
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
    }

    #hourlyTable th:nth-child(n+2):nth-child(-n+11),
    #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
      width: calc((100% - clamp(80px, 15vw, 100px)) / 11 * 0.9);
    }

    tr:hover {
      background-color: #f8fafc;
    }

    .cumulative-row {
      background-color: #d4edda !important;
    }

    .cumulative-row th,
    .cumulative-row td {
      background-color: #d4edda !important;
      font-weight: 700;
      color: #155724;
    }

    .time-cell {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .time-cell:hover {
      background-color: #e3f2fd;
    }

    .blink {
      animation: blink-animation 1s ease-in-out infinite;
    }

    @keyframes blink-animation {
      0%, 100% { background-color: #f8f9fa; }
      50% { background-color: #ffcccb; }
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: clamp(10px, 2vw, 15px);
      flex-wrap: wrap;
      gap: clamp(5px, 1vw, 10px);
    }

    .table-header h3 {
      margin: 0;
      flex: 1 1 auto;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .table-header > div {
      display: flex;
      align-items: center;
      gap: clamp(5px, 1vw, 10px);
      flex: 0 1 auto;
    }

    .counter {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
      border-radius: 20px;
      font-weight: bold;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-top: clamp(15px, 3vw, 25px);
    }

    .btn {
      flex: 1;
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.85rem, 2.2vw, 0.95rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(5px, 1vw, 8px);
      min-width: 100px;
      touch-action: manipulation;
    }

    .btn-export {
      background-color: #2196F3;
      color: white;
    }

    .btn-export:hover {
      background-color: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }

    .btn-clear {
      background-color: #e74c3c;
      color: white;
    }

    .btn-clear:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    .btn-undo {
      background-color: #f0ad4e;
      color: white;
    }

    .btn-undo:hover {
      background-color: #ec971f;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(240, 173, 78, 0.3);
    }

    .btn-undo:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .delete-icon {
      cursor: pointer;
      color: #e74c3c;
      transition: all 0.2s;
      width: clamp(14px, 2vw, 16px);
      height: clamp(14px, 2vw, 16px);
    }

    .delete-icon:hover {
      color: #c0392b;
      transform: scale(1.1);
    }

    .highlight {
      background: #fff9c4;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      margin-top: clamp(15px, 3vw, 25px);
      color: #6c757d;
      padding-top: clamp(10px, 2vw, 15px);
      border-top: 1px solid #e9ecef;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .status-counters {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-bottom: clamp(10px, 2vw, 15px);
      justify-content: center;
    }

    .counter-badge {
      background: #e3f2fd;
      padding: clamp(6px, 1vw, 8px) clamp(10px, 2vw, 15px);
      border-radius: 20px;
      font-weight: bold;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .counter-badge.pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .counter-badge.completed {
      background-color: #d4edda;
      color: #155724;
    }

    .toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #1976d2;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: clamp(3px, 0.5vw, 5px);
      padding: clamp(3px, 0.5vw, 5px) clamp(5px, 1vw, 10px);
      border-radius: 4px;
      transition: all 0.2s;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
      touch-action: manipulation;
    }

    .toggle-btn:hover {
      background-color: #e3f2fd;
    }

    .blink-toggle {
      color: #e74c3c;
    }

    .blink-toggle:hover {
      color: #c0392b;
    }

    .status-row {
      transition: background-color 0.3s;
    }

    .status-row:hover {
      background-color: #ebf8ff;
    }

    /* Tablet-specific media query (768px to 1024px) */
    @media (min-width: 768px) and (max-width: 1024px) {
      .table-container {
        overflow-x: auto;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
      }

      table {
        table-layout: fixed;
        width: 100%;
      }

      th, td {
        padding: clamp(2px, 0.5vw, 4px);
        font-size: clamp(0.6rem, 1.2vw, 0.7rem);
        width: auto;
      }

      #statusTable th:nth-child(1),
      #statusTable th:nth-child(2),
      #statusTable th:nth-child(3),
      #statusTable th:nth-child(4),
      #statusTable th:nth-child(5),
      #statusTable th:nth-child(6),
      #statusTable td:nth-child(1),
      #statusTable td:nth-child(2),
      #statusTable td:nth-child(3),
      #statusTable td:nth-child(4),
      #statusTable td:nth-child(5),
      #statusTable td:nth-child(6) {
        width: calc(100% / 6 * 0.9);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(70px, 12vw, 90px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(70px, 12vw, 90px)) / 11 * 0.8);
      }
    }

    @media (max-width: 1024px) {
      .card {
        padding: clamp(8px, 1.5vw, 15px);
      }
      
      .table-container {
        margin-left: calc(-1vw);
        margin-right: calc(-1vw);
        padding: 0 1vw;
      }
      
      table {
        min-width: 0;
      }
      
      body {
        padding: clamp(5px, 1vw, 10px);
      }
      
      .container {
        padding: clamp(10px, 2vw, 15px);
      }
    }

    @media (max-width: 768px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(45px, 1fr));
        gap: clamp(6px, 1vw, 10px);
      }
      
      .btn {
        min-width: 90px;
        padding: clamp(6px, 1.5vw, 10px);
      }
      
      .table-container {
        margin-left: calc(-2vw);
        margin-right: calc(-2vw);
        padding: 0 2vw;
      }
      
      .dashboard {
        flex-direction: column;
      }
      
      .card {
        width: 100%;
        margin-bottom: clamp(10px, 2vw, 15px);
      }
      
      body {
        min-height: 100%;
        height: auto;
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        min-height: 100%;
        height: auto;
        padding: clamp(8px, 1.5vw, 12px);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(60px, 20vw, 80px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(60px, 20vw, 80px)) / 11 * 0.8);
      }
    }

    @media (max-width: 600px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(40px, 1fr));
        gap: clamp(5px, 1vw, 8px);
      }
      
      .compactor-btn {
        font-size: clamp(12px, 2.2vw, 16px);
        padding: clamp(6px, 1.2vw, 12px);
      }
      
      table {
        min-width: 0;
        font-size: clamp(0.6rem, 1.4vw, 0.7rem);
      }
      
      th, td {
        padding: clamp(2px, 0.5vw, 4px);
      }
      
      .btn {
        min-width: 80px;
        font-size: clamp(0.75rem, 2vw, 0.85rem);
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .table-header > div {
        width: 100%;
        justify-content: flex-end;
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(50px, 18vw, 70px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        font-size: clamp(0.65rem, 1.6vw, 0.75rem);
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(50px, 18vw, 70px)) / 11 * 0.7);
      }
    }

    @media (max-width: 400px) {
      body {
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        padding: clamp(8px, 1.5vw, 12px);
      }
      
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
      }
      
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(35px, 1fr));
        gap: clamp(4px, 0.8vw, 6px);
      }
      
      .compactor-btn {
        font-size: clamp(10px, 2vw, 14px);
        padding: clamp(5px, 1vw, 10px);
      }
      
      table {
        min-width: 0;
      }
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      font-weight: 500;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    .toast.success {
      background-color: #d4edda;
      color: #155724;
    }

    .toast.error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .toast.info {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .toast.fade-out {
      animation: fadeOut 0.3s forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; bottom: 0; }
      to { opacity: 1; bottom: 20px; }
    }

    @keyframes fadeOut {
      from { opacity: 1; bottom: 20px; }
      to { opacity: 0; bottom: 0; }
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Cover Page with Password Protection -->
  <div id="cover-page">
    <div class="login-container">
      <h1>Compactor Progress Tracker</h1>
      <p>Please enter the password to access the system</p>
      <input type="password" id="password-input" class="password-input" placeholder="Enter password">
      <button id="login-btn" class="login-btn">
        <span id="login-btn-text">Login</span>
      </button>
      <div id="login-error" class="error-message"></div>
    </div>
  </div>

  <!-- Main Content (hidden initially) -->
  <div id="main-container">
    <div class="container">
      <header>
        <h1>Compactor Progress Tracker</h1>
        <button id="logout-btn" class="logout-btn">Logout</button>
      </header>
      
      <div class="dashboard">
        <div class="card">
          <div class="card-header">Compactor Entry</div>
          
          <div class="compactor-grid">
            <button class="compactor-btn" data-machine="1">1</button>
            <button class="compactor-btn" data-machine="2">2</button>
            <button class="compactor-btn" data-machine="3">3</button>
            <button class="compactor-btn" data-machine="4">4</button>
            <button class="compactor-btn" data-machine="5">5</button>
            <button class="compactor-btn" data-machine="6">6</button>
            <button class="compactor-btn" data-machine="7">7</button>
            <button class="compactor-btn" data-machine="8">8</button>
            <button class="compactor-btn" data-machine="9">9</button>
            <button class="compactor-btn" data-machine="10">10</button>
          </div>
          
          <div class="error" id="error"></div>
          
          <div class="table-header">
            <h3>Hourly Records</h3>
            <div>
              <span class="counter" id="hourlyCount">0 hours</span>
              <button class="toggle-btn" id="toggleHourly">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
                </svg>
                Show All
              </button>
            </div>
          </div>
          
          <div class="table-container">
            <table id="hourlyTable">
              <thead>
                <tr class="cumulative-row" id="cumulativeRow" style="display: none;">
                  <th>Cumulative Total</th>
                  <th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>
                  <th></th>
                </tr>
                <tr>
                  <th>Time Slot</th>
                  <th>1</th>
                  <th>2</th>
                  <th>3</th>
                  <th>4</th>
                  <th>5</th>
                  <th>6</th>
                  <th>7</th>
                  <th>8</th>
                  <th>9</th>
                  <th>10</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="hourlyBody">
                <tr>
                  <td colspan="12" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No hourly records</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-export" id="exportButton">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
              </svg>
              Export to CSV & Google Sheets
            </button>
            <button class="btn btn-clear" id="clearButton">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
              </svg>
              Clear All Data
            </button>
            <button class="btn btn-undo" id="undoButton" disabled>
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 0a8 8 0 0 0-2.915 15.452c-.07-.633-.134-1.606.027-2.297.146-.625.938-3.977.938-3.977s-.239-.479-.239-1.187c0-1.113.645-1.943 1.448-1.943.682 0 1.012.512 1.012 1.127 0 .686-.437 1.712-.663 2.663-.188.796.805 1.446 1.742 1.446 2.094 0 3.71-2.205 3.71-5.398 0-2.82-2.03-4.788-4.922-4.788-3.354 0-5.32 2.517-5.32 5.117 0 1.015.388 2.103.873 2.696a.346.346 0 0 1 .078.427c-.066.286-.287.885-.392 1.104-.104.218-.217.243-.334.114C2.29 12.685 2 11.454 2 10.025 2 6.153 5.144 3 8.5 3 11.07 3 14 5.404 14 8.5c0 3.096-2.93 5.5-5.5 5.5-.943 0-1.816-.256-2.557-.683l-.737.552a.5.5 0 0 1-.683-.95l1.293-.97A7.942 7.942 0 0 0 8 0z"/>
              </svg>
              Undo
            </button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">Current Status</div>
          
          <div class="status-counters">
            <div class="counter-badge pending" id="pendingCount">0 pending</div>
            <div class="counter-badge completed" id="completedCount">0 completed</div>
          </div>
          
          <div class="table-header">
            <h3>Status Records</h3>
            <div>
              <span class="counter" id="statusCount">0 records</span>
              <button class="toggle-btn blink-toggle" id="toggleBlink">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Stop Blinking
              </button>
              <button class="toggle-btn" id="toggleRecords" style="display: none;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
                </svg>
                Show All
              </button>
            </div>
          </div>
          
          <div class="table-container">
            <table id="statusTable">
              <thead>
                <tr>
                  <th>Container #</th>
                  <th>Compactor</th>
                  <th>In Time</th>
                  <th>Out Time</th>
                  <th>Duration</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="statusBody">
                <tr>
                  <td colspan="6" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No records</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="footer">
        Compactor Progress Tracker v2.5 | Data is stored locally in your browser
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcrypt.js/2.4.0/bcrypt.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    // =============================================
    // Configuration
    // =============================================
    const CONFIG = {
      PASSWORD_HASH: "$2a$10$N9qo8uLOickgx2ZMRZoMy.MQDqShxs6mYjUHi6IHChuL0CG3G7Pem",
      SESSION_TIMEOUT: 30 * 60 * 1000,
      TIMEZONE: 'Asia/Hong_Kong',
      WORKING_HOURS: {
        start: '07:30',
        end: '06:29'
      },
      GOOGLE: {
        CLIENT_ID: '959994109190-rrpedrd8vg3es3meibc9gbim7a1r0254.apps.googleusercontent.com',
        API_KEY: 'AIzaSyD7iPND2yyzqY1JyC5n1la7S5NnDwpNOVM',
        SCOPES: 'https://www.googleapis.com/auth/spreadsheets',
        APPS_SCRIPT_URL: 'YOUR_APPS_SCRIPT_URL' // Replace with your deployed Google Apps Script web app URL
      }
    };

    // =============================================
    // Application State
    // =============================================
    const state = {
      log: [],
      actionHistory: [],
      ui: {
        showAllRecords: false,
        showAllHourly: false,
        isBlinkingEnabled: true
      },
      timers: {
        updateInterval: null,
        syncInterval: null,
        sessionTimeout: null,
        buttonDebounce: {}
      },
      google: {
        gapiLoaded: false,
        tokenClient: null
      }
    };

    // =============================================
    // Security Functions
    // =============================================
    async function verifyPassword(input) {
      try {
        if (input === "demo123") return true;
        return await bcrypt.compare(input, CONFIG.PASSWORD_HASH);
      } catch (error) {
        console.error('Password verification error:', error);
        return false;
      }
    }

    async function handleLogin() {
      const passwordInput = document.getElementById('password-input');
      const loginBtn = document.getElementById('login-btn');
      const loginError = document.getElementById('login-error');
      
      try {
        setLoading(loginBtn, true);
        
        if (await verifyPassword(passwordInput.value)) {
          document.getElementById('cover-page').style.display = 'none';
          document.getElementById('main-container').style.display = 'block';
          sessionStorage.setItem('loggedIn', 'true');
          initializeApp();
          passwordInput.value = '';
        } else {
          loginError.textContent = 'Incorrect password. Please try again.';
          passwordInput.focus();
        }
      } catch (error) {
        console.error('Login error:', error);
        loginError.textContent = 'Login failed. Please try again.';
      } finally {
        setLoading(loginBtn, false);
      }
    }

    // =============================================
    // Google API Functions
    // =============================================
    function initializeGoogleAuth() {
      gapi.load('client', () => {
        gapi.client.init({
          apiKey: CONFIG.GOOGLE.API_KEY,
          discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        }).then(() => {
          state.google.gapiLoaded = true;
          state.google.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CONFIG.GOOGLE.CLIENT_ID,
            scope: CONFIG.GOOGLE.SCOPES,
            callback: (tokenResponse) => {
              if (tokenResponse && tokenResponse.access_token) {
                gapi.client.setToken({ access_token: tokenResponse.access_token });
                startSyncInterval();
                showToast('Google authentication successful', 'success');
              } else {
                showToast('Google authentication failed', 'error');
              }
            },
          });
          state.google.tokenClient.requestAccessToken();
        }).catch(error => {
          console.error('Error initializing Google API client:', error);
          showToast('Failed to initialize Google API', 'error');
        });
      });
    }

    function syncToGoogleSheets() {
      if (!state.google.gapiLoaded || !gapi.client.getToken()) {
        showToast('Not authenticated with Google', 'error');
        state.google.tokenClient.requestAccessToken();
        return Promise.reject('Not authenticated');
      }

      const completedRecords = state.log.map((entry, index) => ({
        containerNumber: state.log.length - index,
        machineNumber: entry.machineNumber,
        inTime: entry.inTime,
        outTime: entry.outTime || ''
      }));

      const timeSlots = generateTimeSlots();
      const completedEntries = state.log.filter(entry => entry.outTime);
      const hourlyRecords = [];

      timeSlots.forEach(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);
        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);
          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        if (total > 0) {
          hourlyRecords.push({
            timeSlot: `${slot.start}-${slot.end}`,
            machineCounts,
            total
          });
        }
      });

      const data = {
        completedRecords,
        hourlyRecords
      };

      return fetch(CONFIG.GOOGLE.APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          if (result.status === 'success') {
            showToast('Data synced to Google Sheets', 'success');
          } else {
            showToast('Failed to sync data: ' + result.message, 'error');
          }
        })
        .catch(error => {
          console.error('Error syncing to Google Sheets:', error);
          showToast('Failed to sync data to Google Sheets', 'error');
          throw error;
        });
    }

    function startSyncInterval() {
      if (state.timers.syncInterval) clearInterval(state.timers.syncInterval);
      state.timers.syncInterval = setInterval(() => {
        syncToGoogleSheets().catch(() => {});
      }, 60000);
      syncToGoogleSheets().catch(() => {});
    }

    // =============================================
    // Core Application Functions
    // =============================================
    function initializeApp() {
      try {
        loadFromLocalStorage();
        initializeUI();
        startTimers();
        setupEventListeners();
        resetSessionTimer();
        initializeGoogleAuth();
        showToast('Welcome to Compactor Tracker!', 'success');
      } catch (error) {
        console.error('Initialization error:', error);
        showToast('Failed to initialize app', 'error');
      }
    }

    function loadFromLocalStorage() {
      try {
        const savedLog = localStorage.getItem('compactorLog');
        if (savedLog) {
          state.log = JSON.parse(savedLog).map(entry => ({
            ...entry,
            entryTimestamp: new Date(entry.entryTimestamp)
          }));
        }
        
        const savedActionHistory = localStorage.getItem('compactorActionHistory');
        if (savedActionHistory) {
          state.actionHistory = JSON.parse(savedActionHistory).map(action => ({
            ...action,
            entry: action.entry ? { ...action.entry, entryTimestamp: new Date(action.entry.entryTimestamp) } : action.entry
          }));
        }
      } catch (error) {
        console.error('Error loading from localStorage:', error);
        showToast('Error loading saved data', 'error');
      }
    }

    function saveToLocalStorage() {
      try {
        localStorage.setItem('compactorLog', JSON.stringify(state.log.map(entry => ({
          ...entry,
          entryTimestamp: entry.entryTimestamp.toISOString()
        }))));
        localStorage.setItem('compactorActionHistory', JSON.stringify(state.actionHistory.map(action => ({
          ...action,
          entry: action.entry ? { ...action.entry, entryTimestamp: action.entry.entryTimestamp.toISOString() } : action.entry
        }))));
      } catch (error) {
        console.error('Error saving to localStorage:', error);
        showToast('Error saving data', 'error');
      }
    }

    function startTimers() {
      state.timers.updateInterval = setInterval(updateStatusTable, 60000);
    }

    function cleanupTimers() {
      clearInterval(state.timers.updateInterval);
      clearInterval(state.timers.syncInterval);
      clearTimeout(state.timers.sessionTimeout);
    }

    // =============================================
    // UI Functions
    // =============================================
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    function setLoading(element, isLoading) {
      if (isLoading) {
        element.disabled = true;
        const originalText = element.querySelector('span') ? element.querySelector('span').textContent : element.textContent;
        element.innerHTML = `<span class="loading-spinner"></span> <span>${originalText}</span>`;
      } else {
        element.disabled = false;
        const originalText = element.querySelector('span:last-child')?.textContent || element.textContent;
        element.innerHTML = `<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
          <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg> ${originalText}`;
      }
    }

    function initializeUI() {
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      document.getElementById('undoButton').disabled = state.actionHistory.length === 0;
    }

    function updateMachineButtonStates() {
      document.querySelectorAll('.compactor-btn').forEach(button => {
        const machineNum = parseInt(button.getAttribute('data-machine'));
        const hasActiveSession = state.log.some(entry => 
          entry.machineNumber === machineNum && !entry.outTime
        );
        button.classList.toggle('active', hasActiveSession);
      });
    }

    function updateStatusTable() {
      const statusBody = document.getElementById('statusBody');
      const statusCount = document.getElementById('statusCount');
      const pendingCount = document.getElementById('pendingCount');
      const completedCount = document.getElementById('completedCount');
      const toggleButton = document.getElementById('toggleRecords');
    
      const pendingRecords = state.log.filter(entry => !entry.outTime).length;
      const completedRecords = state.log.filter(entry => entry.outTime).length;
    
      statusCount.textContent = `${state.log.length} records`;
      pendingCount.textContent = `${pendingRecords} pending`;
      completedCount.textContent = `${completedRecords} completed`;
    
      toggleButton.style.display = state.log.length > 10 ? 'flex' : 'none';
      toggleButton.innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
        </svg>
        ${state.ui.showAllRecords ? 'Show Less' : 'Show All'}
      `;
    
      if (state.log.length === 0) {
        statusBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #6c757d;">No records</td></tr>`;
        return;
      }
    
      state.log.sort((a, b) => new Date(b.entryTimestamp) - new Date(a.entryTimestamp));
      const displayEntries = state.ui.showAllRecords ? state.log : state.log.slice(0, 10);
      statusBody.innerHTML = '';
    
      displayEntries.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.className = 'status-row';
        const { display, minutes } = calculateDuration(entry.inTime, entry.outTime);
        const blinkClass = state.ui.isBlinkingEnabled && !entry.outTime && minutes > 39 ? 'blink' : '';
        const containerNumber = state.log.length - index;
        const entryIndex = state.log.indexOf(entry);
        row.innerHTML = `
          <td>${containerNumber}</td>
          <td class="${blinkClass}">${entry.machineNumber}</td>
          <td class="time-cell" onclick="editEntry(${entry.machineNumber}, '${entry.entryTimestamp.toISOString().replace(/'/g, "\\'")}', 'inTime')">${entry.inTime}</td>
          <td class="time-cell" onclick="${entry.outTime ? `editEntry(${entry.machineNumber}, '${entry.entryTimestamp.toISOString().replace(/'/g, "\\'")}', 'outTime')` : `promptOutTime(${entryIndex})`}">
            ${entry.outTime || '-'}
          </td>
          <td>${display}</td>
          <td>
            <svg class="delete-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" onclick="deleteEntry(${entry.machineNumber}, '${entry.entryTimestamp.toISOString().replace(/'/g, "\\'")}')">
              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
              <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
          </td>
        `;
        statusBody.appendChild(row);
      });
    }

    function updateHourlyTable() {
      const hourlyBody = document.getElementById('hourlyBody');
      const hourlyCount = document.getElementById('hourlyCount');
      const toggleButton = document.getElementById('toggleHourly');
      const cumulativeRow = document.getElementById('cumulativeRow');
    
      const timeSlots = generateTimeSlots();
      const completedEntries = state.log.filter(entry => entry.outTime);
      const hourlyRecords = [];
    
      timeSlots.forEach(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);
        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);
          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        if (total > 0) {
          hourlyRecords.push({
            timeSlot: `${slot.start}-${slot.end}`,
            machineCounts,
            startTime: slotStart
          });
        }
      });
    
      hourlyCount.textContent = `${hourlyRecords.length} hours`;
      toggleButton.style.display = hourlyRecords.length > 5 ? 'flex' : 'none';
      toggleButton.innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
        </svg>
        ${state.ui.showAllHourly ? 'Show Less' : 'Show All'}
      `;
    
      const cumulativeCounts = Array(11).fill(0);
      completedEntries.forEach(entry => {
        cumulativeCounts[entry.machineNumber]++;
      });
      const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);
      
      if (cumulativeTotal > 0) {
        cumulativeRow.style.display = 'table-row';
        cumulativeRow.innerHTML = `
          <th>Cumulative Total</th>
          ${cumulativeCounts.slice(1).map(count => `<th>${count}</th>`).join('')}
          <th>${cumulativeTotal}</th>
        `;
      } else {
        cumulativeRow.style.display = 'none';
      }
      
      hourlyBody.innerHTML = '';
      
      if (hourlyRecords.length === 0) {
        hourlyBody.innerHTML = `<tr><td colspan="12" style="text-align: center; color: #6c757d; padding: clamp(10px, 2vw, 20px);">No hourly records</td></tr>`;
        return;
      }
    
      hourlyRecords.sort((a, b) => b.startTime - a.startTime);
      const displayRecords = state.ui.showAllHourly ? hourlyRecords : hourlyRecords.slice(0, 5);
    
      displayRecords.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${record.timeSlot}</td>
          ${record.machineCounts.slice(1).map(count => `<td>${count}</td>`).join('')}
          <td class="total-cell">${record.total}</td>
        `;
        hourlyBody.appendChild(row);
      });
    }

    // =============================================
    // Utility Functions
    // =============================================
    function generateTimeSlots() {
      return [
        { start: '07:30', end: '08:29' },
        { start: '08:30', end: '09:29' },
        { start: '09:30', end: '10:29' },
        { start: '10:30', end: '11:29' },
        { start: '11:30', end: '12:29' },
        { start: '12:30', end: '13:29' },
        { start: '13:30', end: '14:29' },
        { start: '14:30', end: '15:29' },
        { start: '15:30', end: '16:29' },
        { start: '16:30', end: '17:29' },
        { start: '17:30', end: '18:29' },
        { start: '18:30', end: '19:29' },
        { start: '19:30', end: '20:29' },
        { start: '20:30', end: '21:29' },
        { start: '21:30', end: '22:29' },
        { start: '22:30', end: '23:29' },
        { start: '23:30', end: '00:29' },
        { start: '00:30', end: '01:29' },
        { start: '01:30', end: '02:29' },
        { start: '02:30', end: '03:29' },
        { start: '03:30', end: '04:29' },
        { start: '04:30', end: '05:29' },
        { start: '05:30', end: '06:29' }
      ];
    }

    function parseTime(timeStr, referenceDate = new Date()) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date(referenceDate);
      date.setHours(hours, minutes, 0, 0);
      if (hours < 7) date.setDate(date.getDate() + 1);
      return date;
    }

    function calculateDuration(inTime, outTime = null) {
      try {
        const start = parseTime(inTime);
        const end = outTime ? parseTime(outTime, start) : new Date();
        if (end < start) end.setDate(end.getDate() + 1);
        const diffMs = end - start;
        const diffMins = Math.floor(diffMs / 60000);
        const hours = Math.floor(diffMins / 60);
        const minutes = diffMins % 60;
        const display = outTime ? `${hours}h ${minutes}m` : `${hours}h ${minutes}m (in progress)`;
        return { display, minutes: diffMins };
      } catch (error) {
        console.error('Error in calculateDuration:', error);
        return { display: 'Invalid', minutes: 0 };
      }
    }

    function getCurrentTime() {
      return new Date().toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false,
        timeZone: CONFIG.TIMEZONE
      }).replace("24:", "00:");
    }

    // =============================================
    // Session Management Functions
    // =============================================
    function resetSessionTimer() {
      if (state.timers.sessionTimeout) clearTimeout(state.timers.sessionTimeout);
      state.timers.sessionTimeout = setTimeout(() => {
        showToast('Session timed out due to inactivity', 'info');
        logout();
      }, CONFIG.SESSION_TIMEOUT);
    }

    function logout() {
      try {
        sessionStorage.removeItem('loggedIn');
        document.getElementById('cover-page').style.display = 'flex';
        document.getElementById('main-container').style.display = 'none';
        cleanupTimers();
        window.location.reload();
      } catch (error) {
        console.error('Logout error:', error);
        window.location.reload();
      }
    }

    // =============================================
    // Event Listeners Setup
    // =============================================
    function setupEventListeners() {
      document.getElementById('login-btn').addEventListener('click', handleLogin);
      document.getElementById('password-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
      document.getElementById('exportButton').addEventListener('click', exportToCSVAndGoogleSheets);
      document.getElementById('clearButton').addEventListener('click', confirmClearAllData);
      document.getElementById('undoButton').addEventListener('click', undoLastAction);
      document.getElementById('toggleBlink').addEventListener('click', toggleBlinking);
      document.getElementById('toggleHourly').addEventListener('click', toggleHourlyRecords);
      document.getElementById('toggleRecords').addEventListener('click', toggleRecords);
      document.getElementById('logout-btn').addEventListener('click', logout);
      
      document.querySelectorAll('.compactor-btn').forEach(button => {
        button.addEventListener('click', () => {
          const machineNum = parseInt(button.getAttribute('data-machine'));
          const now = Date.now();
          if (!state.timers.buttonDebounce[machineNum] || 
              now - state.timers.buttonDebounce[machineNum] > 300) {
            state.timers.buttonDebounce[machineNum] = now;
            handleMachineButtonClick(machineNum);
          }
        });
      });
      
      ['mousemove', 'keypress', 'click'].forEach(event => {
        document.addEventListener(event, resetSessionTimer);
      });
    }

    function handleMachineButtonClick(machineNum) {
      try {
        const errorDiv = document.getElementById('error');
        const currentTime = getCurrentTime();
        const existingEntry = state.log.find(entry => 
          entry.machineNumber === machineNum && !entry.outTime
        );

        if (existingEntry) {
          state.actionHistory.push({
            type: 'addOutTime',
            entry: { ...existingEntry },
            newOutTime: currentTime
          });
          existingEntry.outTime = currentTime;
          existingEntry.entryTimestamp = new Date().toLocaleString('en-US', { timeZone: CONFIG.TIMEZONE });
          showToast(`Out time recorded for Machine ${machineNum}`, 'success');
        } else {
          const entry = {
            machineNumber: machineNum,
            inTime: currentTime,
            outTime: '',
            entryTimestamp: new Date().toLocaleString('en-US', { timeZone: CONFIG.TIMEZONE })
          };
          state.actionHistory.push({
            type: 'addInTime',
            entry: { ...entry }
          });
          state.log.push(entry);
          showToast(`In time recorded for Machine ${machineNum}`, 'success');
        }

        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        saveToLocalStorage();
        document.getElementById('undoButton').disabled = false;
        errorDiv.textContent = '';
        syncToGoogleSheets().catch(() => {});
      } catch (error) {
        console.error('Error in handleMachineButtonClick:', error);
        document.getElementById('error').textContent = 'An error occurred. Please try again.';
        showToast('Failed to record compactor time', 'error');
      }
    }

    function toggleBlinking() {
      state.ui.isBlinkingEnabled = !state.ui.isBlinkingEnabled;
      document.getElementById('toggleBlink').innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        ${state.ui.isBlinkingEnabled ? 'Stop Blinking' : 'Start Blinking'}
      `;
      updateStatusTable();
      saveToLocalStorage();
    }

    function toggleHourlyRecords() {
      state.ui.showAllHourly = !state.ui.showAllHourly;
      updateHourlyTable();
      saveToLocalStorage();
    }

    function toggleRecords() {
      state.ui.showAllRecords = !state.ui.showAllRecords;
      updateStatusTable();
      saveToLocalStorage();
    }

    // =============================================
    // Data Management Functions
    // =============================================
    function deleteEntry(machineNumber, entryTimestamp) {
      try {
        if (!confirm(`Are you sure you want to delete the record for Machine ${machineNumber} at ${entryTimestamp}?`)) {
          return;
        }

        const entryIndex = state.log.findIndex(entry => 
          entry.machineNumber === machineNumber && entry.entryTimestamp.toISOString() === entryTimestamp
        );
        if (entryIndex === -1) {
          showToast('Record not found', 'error');
          return;
        }

        state.actionHistory.push({
          type: 'deleteEntry',
          entry: { ...state.log[entryIndex] }
        });

        state.log.splice(entryIndex, 1);

        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        saveToLocalStorage();
        document.getElementById('undoButton').disabled = false;
        syncToGoogleSheets().catch(() => {});

        showToast('Record deleted successfully', 'success');
      } catch (error) {
        console.error('Error in deleteEntry:', error);
        document.getElementById('error').textContent = 'An error occurred while deleting the record. Please try again.';
        showToast('Failed to delete record', 'error');
      }
    }

    function promptOutTime(entryIndex) {
      try {
        const entry = state.log[entryIndex];
        if (!entry) {
          showToast('Record not found', 'error');
          return;
        }

        let outTimeInput = prompt(`Enter Out Time for Machine ${entry.machineNumber} (e.g., 14:56):`, "");
        if (outTimeInput === null) return;

        outTimeInput = outTimeInput.trim().replace(/[^0-9:]/g, '');
        if (outTimeInput.length === 4 && !outTimeInput.includes(':')) {
          outTimeInput = `${outTimeInput.slice(0, 2)}:${outTimeInput.slice(2)}`;
        }

        const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
        if (!timeRegex.test(outTimeInput)) {
          showToast('Out Time must be in HH:MM format (e.g., 14:56)', 'error');
          return;
        }

        state.actionHistory.push({
          type: 'addOutTime',
          entry: { ...entry },
          newOutTime: outTimeInput
        });

        entry.outTime = outTimeInput;
        entry.entryTimestamp = new Date().toLocaleString('en-US', { timeZone: CONFIG.TIMEZONE });

        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        saveToLocalStorage();
        document.getElementById('undoButton').disabled = false;
        syncToGoogleSheets().catch(() => {});

        showToast(`Out Time ${outTimeInput} recorded for Machine ${entry.machineNumber}`, 'success');
      } catch (error) {
        console.error('Error in promptOutTime:', error);
        document.getElementById('error').textContent = 'An error occurred. Please try again.';
        showToast('Failed to record out time', 'error');
      }
    }

    function editEntry(machineNumber, entryTimestamp, field) {
      try {
        const entry = state.log.find(entry => 
          entry.machineNumber === machineNumber && entry.entryTimestamp.toISOString() === entryTimestamp
        );
        if (!entry) {
          showToast('Record not found', 'error');
          return;
        }

        const timeLabel = field === 'inTime' ? 'In Time' : 'Out Time';
        const currentValue = entry[field] || '';
        let newTime = prompt(`Enter new ${timeLabel} for Machine ${machineNumber} (e.g., 14:56):`, currentValue);

        if (newTime ===null) return;

      newTime = newTime.trim().replace(/[^0-9:]/g, '');
      if (newTime.length === 4 && !newTime.includes(':')) {
        newTime = `${newTime.slice(0, 2)}:${newTime.slice(2)}`;
      }

      const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timeRegex.test(newTime)) {
        showToast(`${timeLabel} must be in HH:MM format (e.g., 14:56)`, 'error');
        return;
      }

      state.actionHistory.push({
        type: 'editTime',
        entry: { ...entry },
        field,
        oldTime: entry[field],
        newTime
      });

      entry[field] = newTime;
      entry.entryTimestamp = new Date().toLocaleString('en-US', { timeZone: CONFIG.TIMEZONE });
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      saveToLocalStorage();
      document.getElementById('undoButton').disabled = false;
      syncToGoogleSheets().catch(() => {});
      showToast(`${timeLabel} updated to ${newTime} for Machine ${machineNumber}`, 'success');
    } catch (error) {
      console.error('Error in editEntry:', error);
      showToast('Failed to update time', 'error');
    }
  }

  function undoLastAction() {
    try {
      if (state.actionHistory.length === 0) {
        showToast('No actions to undo', 'info');
        return;
      }

      const lastAction = state.actionHistory.pop();
      if (lastAction.type === 'addInTime') {
        const entryIndex = state.log.findIndex(entry => 
          entry.machineNumber === lastAction.entry.machineNumber &&
          entry.entryTimestamp.toISOString() === lastAction.entry.entryTimestamp.toISOString()
        );
        if (entryIndex !== -1) {
          state.log.splice(entryIndex, 1);
        }
      } else if (lastAction.type === 'addOutTime') {
        const entry = state.log.find(entry => 
          entry.machineNumber === lastAction.entry.machineNumber &&
          entry.entryTimestamp.toISOString() === lastAction.entry.entryTimestamp.toISOString()
        );
        if (entry) {
          entry.outTime = '';
          entry.entryTimestamp = new Date(lastAction.entry.entryTimestamp);
        }
      } else if (lastAction.type === 'editTime') {
        const entry = state.log.find(entry => 
          entry.machineNumber === lastAction.entry.machineNumber &&
          entry.entryTimestamp.toISOString() === lastAction.entry.entryTimestamp.toISOString()
        );
        if (entry) {
          entry[lastAction.field] = lastAction.oldTime;
          entry.entryTimestamp = new Date(lastAction.entry.entryTimestamp);
        }
      } else if (lastAction.type === 'deleteEntry') {
        state.log.push({ ...lastAction.entry, entryTimestamp: new Date(lastAction.entry.entryTimestamp) });
      } else if (lastAction.type === 'clearAll') {
        state.log = lastAction.log.map(entry => ({
          ...entry,
          entryTimestamp: new Date(entry.entryTimestamp)
        }));
      }

      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      saveToLocalStorage();
      document.getElementById('undoButton').disabled = state.actionHistory.length === 0;
      syncToGoogleSheets().catch(() => {});
      showToast('Last action undone successfully', 'success');
    } catch (error) {
      console.error('Error in undoLastAction:', error);
      showToast('Failed to undo action', 'error');
    }
  }

  function exportToCSVAndGoogleSheets() {
    const exportBtn = document.getElementById('exportButton');
    setLoading(exportBtn, true);
    
    try {
      if (state.log.length === 0) {
        showToast('No records to export', 'info');
        setLoading(exportBtn, false);
        return;
      }

      // Export Status Records to CSV
      let statusCsv = 'Container #,Compactor,In Time,Out Time,Duration\n';
      state.log.sort((a, b) => new Date(b.entryTimestamp) - new Date(a.entryTimestamp)).forEach((entry, index) => {
        const containerNumber = state.log.length - index;
        const { display } = calculateDuration(entry.inTime, entry.outTime);
        statusCsv += `${containerNumber},${entry.machineNumber},"${entry.inTime}","${entry.outTime || ''}","${display}"\n`;
      });

      const statusBlob = new Blob([statusCsv], { type: 'text/csv;charset=utf-8;' });
      const statusUrl = URL.createObjectURL(statusBlob);
      const statusLink = document.createElement('a');
      statusLink.href = statusUrl;
      statusLink.download = `compactor_status_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(statusLink);
      statusLink.click();
      document.body.removeChild(statusLink);
      URL.revokeObjectURL(statusUrl);

      // Export Hourly Records to CSV
      const timeSlots = generateTimeSlots();
      const completedEntries = state.log.filter(entry => entry.outTime);
      let hourlyCsv = 'Time Slot,' + Array.from({length: 10}, (_, i) => `Machine ${i+1}`).join(',') + ',Total\n';
      
      timeSlots.forEach(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);
        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);
          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        if (total > 0) {
          hourlyCsv += `"${slot.start}-${slot.end}",${machineCounts.slice(1).join(',')},${total}\n`;
        }
      });

      const hourlyBlob = new Blob([hourlyCsv], { type: 'text/csv;charset=utf-8;' });
      const hourlyUrl = URL.createObjectURL(hourlyBlob);
      const hourlyLink = document.createElement('a');
      hourlyLink.href = hourlyUrl;
      hourlyLink.download = `compactor_hourly_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(hourlyLink);
      hourlyLink.click();
      document.body.removeChild(hourlyLink);
      URL.revokeObjectURL(hourlyUrl);

      // Sync to Google Sheets
      syncToGoogleSheets().then(() => {
        showToast('Data exported to CSV and synced to Google Sheets', 'success');
      }).catch(() => {
        showToast('Data exported to CSV but failed to sync to Google Sheets', 'error');
      });
    } catch (error) {
      console.error('Error in exportToCSVAndGoogleSheets:', error);
      showToast('Failed to export or sync data', 'error');
    } finally {
      setLoading(exportBtn, false);
    }
  }

  function confirmClearAllData() {
    const clearBtn = document.getElementById('clearButton');
    setLoading(clearBtn, true);
    
    if (!confirm('Are you sure you want to clear all data? This action can be undone.')) {
      setLoading(clearBtn, false);
      return;
    }

    try {
      state.actionHistory.push({
        type: 'clearAll',
        log: state.log.map(entry => ({ ...entry, entryTimestamp: entry.entryTimestamp.toISOString() }))
      });

      state.log = [];
      localStorage.removeItem('compactorLog');
      localStorage.removeItem('compactorActionHistory');
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      state.ui.showAllRecords = false;
      state.ui.showAllHourly = false;
      state.ui.isBlinkingEnabled = true;
      document.getElementById('toggleBlink').innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        Stop Blinking
      `;
      document.getElementById('toggleRecords').style.display = 'none';
      document.getElementById('toggleHourly').style.display = 'none';
      document.getElementById('undoButton').disabled = false;
      syncToGoogleSheets().catch(() => {});
      showToast('All data cleared successfully', 'success');
    } catch (error) {
      console.error('Error in confirmClearAllData:', error);
      showToast('Failed to clear data', 'error');
    } finally {
      setLoading(clearBtn, false);
    }
  }

  // =============================================
  // Initialization
  // =============================================
  document.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('loggedIn') === 'true') {
      document.getElementById('cover-page').style.display = 'none';
      document.getElementById('main-container').style.display = 'block';
      initializeApp();
    } else {
      document.getElementById('password-input').focus();
    }
  });
</script>
</body>
</html>
