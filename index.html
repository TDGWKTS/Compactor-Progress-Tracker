<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.gstatic.com 'unsafe-inline'; frame-src https://accounts.google.com;">
  <title>Compactor Progress Tracker</title>
  <script src="https://apis.google.com/js/api.js" crossorigin="anonymous" onerror="handleScriptError()"></script>
  <style>
    /* Your existing styles remain unchanged */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: #333;
    }
    /* ... rest of styles ... */
  </style>
</head>
<body>
  <div class="container">
    <h1>Compactor Progress Tracker</h1>

    <div class="instructions">
      <h4>Instructions</h4>
      <ul>
        <li><span class="highlight">Sign In</span>: Click the "Sign In with Google" button to authenticate and access the tracker.</li>
        <li><span class="highlight">Select Compactor</span>: Click a compactor number to record <span class="highlight">In Time</span>. Click again to record <span class="highlight">Out Time</span>.</li>
        <li><span class="highlight">Edit Times</span>: Click on <span class="highlight">In Time</span> or <span class="highlight">Out Time</span> in the Completed Records table to edit.</li>
        <li><span class="highlight">Delete Records</span>: Click the delete icon in the Completed Records table to remove an entry.</li>
        <li><span class="highlight">Export Data</span>: Click "Export to CSV" to download completed and hourly records.</li>
        <li><span class="highlight">Clear Data</span>: Click "Clear All Data" to reset all records (irreversible).</li>
        <li>Data syncs to Google Sheets every minute. Ensure you are signed in with an authorized Google account.</li>
      </ul>
    </div>

    <div class="buttons">
      <button id="signInButton">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0c1.072 0 2.1.24 3.03.672l-1.94 1.94a5.5 5.5 0 0 0-7.59 7.59l2.828-2.829a.5.5 0 0 1 .707 0l1.415 1.414a.5.5 0 0 1 0 .707l-2.828 2.828a5.5 5.5 0 0 0 7.59 7.59l1.94-1.94a8.46 8.46 0 0 0 2.384-5.885 9.42 9.42 0 0 0-.139-1.626l-1.94 1.94z"/>
        </svg>
        Sign In with Google
      </button>
      <button id="signOutButton" style="display: none;">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
          <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0-.708 0l-3-3a.5.5 0 0 0-.708.708L13.293 8H3.5a.5.5 0 0 0 0 1h9.793l-1.147 1.146a.5.5 0 0 0 .708.708l3-3z"/>
        </svg>
        Sign Out
      </button>
    </div>

    <div class="panels">
      <div class="panel">
        <div class="panel-header">Compactor Entry</div>
        <div class="form-group">
          <label>Select Compactor:</label>
          <div class="machine-buttons">
            <button id="machineButton1" class="machine-button">1</button>
            <button id="machineButton2" class="machine-button">2</button>
            <button id="machineButton3" class="machine-button">3</button>
            <button id="machineButton4" class="machine-button">4</button>
            <button id="machineButton5" class="machine-button">5</button>
            <button id="machineButton6" class="machine-button">6</button>
            <button id="machineButton7" class="machine-button">7</button>
            <button id="machineButton8" class="machine-button">8</button>
            <button id="machineButton9" class="machine-button">9</button>
            <button id="machineButton10" class="machine-button">10</button>
          </div>
        </div>
        <div class="error" id="error"></div>

        <div class="table-header" style="margin-top: 25px;">
          <h4>Hourly Records</h4>
          <div class="display: flex; align-items: center; gap: 10px;">
            <div class="counter" id="hourlyCount">0 hourly records</div>
            <button id="toggleHourly" class="toggle-button">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
              </svg>
              Show All
            </button>
          </div>
        </div>
        <table id="hourlyTable">
          <thead>
            <tr>
              <th>Time Slot</th>
              <th>Container Count</th>
              <th>Compactors</th>
            </tr>
          </thead>
          <tbody id="hourlyBody">
            <tr>
              <td colspan="3" style="text-align: center; color: #6c757d;">No hourly records</td>
            </tr>
          </tbody>
        </table>

        <div class="buttons">
          <button id="exportButton">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 0 0-.708.708z"/>
            </svg>
            Export to CSV
          </button>
          <button id="clearButton">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5"/>
              <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 1-1-1V2a1 1 0 0 1 1-1H6a1h2a1.5 0 0 0 0 1h3.5v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1.0 0 0 1 0 1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </button>
            Clear All Data
          </button>
        </div>
      </div>
      <!-- Rest of the HTML (Current Status, Entry Log, Completed Records) remains unchanged -->
    </div>

    <div class="footer">
      Compactor Progress Tracker v3.0 | Data is stored locally in your browser
    </div>
  </div>

  <script>
    // Handle script loading error
    function handleScriptError() {
      console.error('Failed to load Google API script');
      showNotification('Failed to load Google API script. Check network or ad blockers.', 'error');
    }

    // In-memory log to track entries and deletions
    let log = [];
    let deletedEntries = [];
    let showAllRecords = false;
    let showAllHourly = false;
    let isBlinkingEnabled = true;
    let updateInterval = null;
    let token = null;

    // Initialize Google Auth
    function initGoogleAuth() {
      if (typeof gapi === 'undefined') {
        console.error('Google API script not loaded');
        showNotification('Google API script not loaded. Check network or ad blockers.', 'error');
        return;
      }
      console.log('Loading Google Auth...');
      try {
        gapi.load('auth2', () => {
          console.log('Google Auth2 loaded');
          gapi.auth2.init({
            client_id: '959994109190-rrpedrd8vg3es3meibc9gbim7a1r0254.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/spreadsheets'
          }).then(() => {
            console.log('Google Auth initialized');
            const authInstance = gapi.auth2.getAuthInstance();
            if (authInstance.isSignedIn.get()) {
              console.log('User already signed in');
              token = authInstance.currentUser.get().getAuthResponse().access_token;
              document.getElementById('signInButton').style.display = 'none';
              document.getElementById('signOutButton').style.display = 'flex';
              showNotification('Authenticated with Google.', 'success');
              sendToGoogleSheets();
            } else {
              console.log('Initiating sign-in...');
              authInstance.signIn().then(() => {
                console.log('Sign-in successful');
                token = authInstance.currentUser.get().getAuthResponse().access_token;
                document.getElementById('signInButton').style.display = 'none';
                document.getElementById('signOutButton').style.display = 'flex';
                showNotification('Authenticated with Google.', 'success');
                sendToGoogleSheets();
              }).catch(error => {
                console.error('Authentication failed:', error);
                showNotification(`Failed to authenticate with Google: ${error.error || error.message}`, 'error');
              });
            }
          }).catch(error => {
            console.error('Google Auth initialization failed:', error);
            showNotification(`Failed to initialize Google Auth: ${error.error || error.message}`, 'error');
          });
        });
      } catch (error) {
        console.error('Error during Google Auth loading:', error);
        showNotification('Error during Google Auth loading: ' + error.message, 'error');
      }
    }

    // Sign out
    function signOut() {
      if (typeof gapi === 'undefined' || !gapi.auth2) {
        console.error('Google API not available for sign out');
        showNotification('Google API not available. Please refresh the page.', 'error');
        return;
      }
      gapi.auth2.getAuthInstance().signOut().then(() => {
        token = null;
        document.getElementById('signInButton').style.display = 'flex';
        document.getElementById('signOutButton').style.display = 'none';
        showNotification('Signed out successfully.', 'success');
      }).catch(error => {
        console.error('Sign out failed:', error);
        showNotification('Failed to sign out. Please try again.', 'error');
      });
    }

    // Rest of your JavaScript (generateEntryId, saveToStorage, loadFromStorage, etc.) remains unchanged
    // Include all other functions from the previous index.html
  </script>
</body>
</html>
