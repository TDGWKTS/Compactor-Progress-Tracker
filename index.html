<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.gstatic.com https://accounts.google.com https://*.googleapis.com https://ssl.gstatic.com https://www.google.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://accounts.google.com https://sheets.googleapis.com https://www.googleapis.com;">
  <title>Compactor Progress Tracker</title>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: clamp(10px, 2vw, 15px);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      height: auto;
      color: #333;
      line-height: 1.5;
      font-size: clamp(14px, 2.5vw, 16px);
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .container {
      max-width: min(1400px, 95vw);
      margin: 0 auto;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      padding: clamp(15px, 2.5vw, 20px);
      position: relative;
      flex-grow: 1;
      height: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800);
    }

    header {
      text-align: center;
      margin-bottom: clamp(15px, 3vw, 25px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
    }

    h1 {
      color: #2c3e50;
      margin: clamp(10px, 2vw, 15px) 0;
      font-weight: 600;
      position: relative;
      padding-bottom: 15px;
      font-size: clamp(1.5rem, 5vw, 2rem);
      flex: 1;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(60px, 10vw, 80px);
      height: 4px;
      background: linear-gradient(90deg, #4CAF50, #2196F3);
      border-radius: 2px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: clamp(10px, 2vw, 15px);
      flex: 0 0 auto;
    }

    .sync-status {
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
      padding: clamp(6px, 1vw, 8px) clamp(10px, 2vw, 15px);
      border-radius: 20px;
      font-weight: bold;
      flex: 0 0 auto;
    }

    .sync-status.connected {
      background-color: #d4edda;
      color: #155724;
    }

    .sync-status.disconnected {
      background-color: #fff3cd;
      color: #856404;
    }

    .sync-status.error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .dashboard {
      display: flex;
      flex-direction: column;
      gap: clamp(15px, 3vw, 25px);
      margin-bottom: clamp(15px, 3vw, 25px);
      flex-grow: 1;
    }

    @media (min-width: 768px) {
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: clamp(10px, 2vw, 20px);
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
      width: 100%;
      overflow: visible;
      flex-grow: 0;
      min-height: 0;
      overflow-y: auto;
    }

    .card-header {
      font-size: clamp(1rem, 3vw, 1.25rem);
      font-weight: 600;
      margin-bottom: clamp(10px, 2vw, 15px);
      color: #2c3e50;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .compactor-grid {
      display: grid;
      grid-template-rows: repeat(2, auto);
      grid-template-columns: repeat(5, minmax(50px, 1fr));
      grid-template-areas: 
        "b1 b2 b3 b4 b5"
        "b6 b7 b8 b9 b10";
      gap: clamp(8px, 1.5vw, 12px);
      margin-bottom: clamp(10px, 2vw, 20px);
    }

    .compactor-btn[data-machine="1"] { grid-area: b1; }
    .compactor-btn[data-machine="2"] { grid-area: b2; }
    .compactor-btn[data-machine="3"] { grid-area: b3; }
    .compactor-btn[data-machine="4"] { grid-area: b4; }
    .compactor-btn[data-machine="5"] { grid-area: b5; }
    .compactor-btn[data-machine="6"] { grid-area: b6; }
    .compactor-btn[data-machine="7"] { grid-area: b7; }
    .compactor-btn[data-machine="8"] { grid-area: b8; }
    .compactor-btn[data-machine="9"] { grid-area: b9; }
    .compactor-btn[data-machine="10"] { grid-area: b10; }

    .compactor-btn {
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(14px, 2.5vw, 18px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #4CAF50;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      touch-action: manipulation;
    }

    .compactor-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .compactor-btn.active {
      background-color: #6c757d;
      transform: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .error {
      color: #e74c3c;
      font-size: clamp(0.9rem, 2vw, 1rem);
      margin: clamp(10px, 1vw, 10px) 0;
      min-height: 24px;
      font-weight: bold;
      text-align: center;
    }

    .table-container {
      overflow-x: auto;
      overflow-y: auto;
      margin-top: clamp(10px, 2vw, 20px);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      width: 100%;
      max-height: 400px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      table-layout: fixed;
    }

    th {
      background-color: #f1f5f9;
      padding: clamp(4px, 1vw, 8px);
      text-align: center;
      font-weight: 600;
      color: #2c3e50;
      border: 1px solid #d1d5db;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
    }

    td {
      padding: clamp(4px, 1vw, 8px);
      border: 1px solid #d1d5db;
      color: #4a5568;
      text-align: center;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #hourlyTable th:nth-child(1),
    #hourlyTable td:nth-child(1) {
      width: clamp(80px, 15vw, 100px);
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
    }

    #hourlyTable th:nth-child(n+2):nth-child(-n+11),
    #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
      width: calc((100% - clamp(80px, 15vw, 100px)) / 11 * 0.9);
    }

    tr:hover {
      background-color: #f8fafc;
    }

    .cumulative-row {
      background-color: #d4edda !important;
    }

    .cumulative-row th,
    .cumulative-row td {
      background-color: #d4edda !important;
      font-weight: 700;
      color: #155724;
    }

    .time-cell {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .time-cell:hover {
      background-color: #e3f2fd;
    }

    .blink {
      animation: blink-animation 1s ease-in-out infinite;
    }

    @keyframes blink-animation {
      0%, 100% { background-color: #f8f9fa; }
      50% { background-color: #ffcccb; }
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: clamp(10px, 2vw, 15px);
      flex-wrap: wrap;
      gap: clamp(5px, 1vw, 10px);
    }

    .table-header h3 {
      margin: 0;
      flex: 1 1 auto;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .table-header > div {
      display: flex;
      align-items: center;
      gap: clamp(5px, 1vw, 10px);
      flex: 0 1 auto;
    }

    .counter {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
      border-radius: 20px;
      font-weight: bold;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-top: clamp(15px, 3vw, 25px);
    }

    .btn {
      flex: 1;
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.85rem, 2.2vw, 0.95rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(5px, 1vw, 8px);
      min-width: 100px;
      touch-action: manipulation;
    }

    .btn-export {
      background-color: #2196F3;
      color: white;
    }

    .btn-export:hover {
      background-color: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }

    .btn-clear {
      background-color: #e74c3c;
      color: white;
    }

    .btn-clear:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    .btn-undo {
      background-color: #f0ad4e;
      color: white;
    }

    .btn-undo:hover {
      background-color: #ec971f;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(240, 173, 78, 0.3);
    }

    .btn-undo:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-signin {
      background-color: #4285F4;
      color: white;
    }

    .btn-signin:hover {
      background-color: #3267d6;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(66, 133, 244, 0.3);
    }

    .btn-signout {
      background-color: #6c757d;
      color: white;
    }

    .btn-signout:hover {
      background-color: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
    }

    .delete-icon {
      cursor: pointer;
      color: #e74c3c;
      transition: all 0.2s;
      width: clamp(14px, 2vw, 16px);
      height: clamp(14px, 2vw, 16px);
    }

    .delete-icon:hover {
      color: #c0392b;
      transform: scale(1.1);
    }

    .highlight {
      background: #fff9c4;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      margin-top: clamp(15px, 3vw, 25px);
      color: #6c757d;
      padding-top: clamp(10px, 2vw, 15px);
      border-top: 1px solid #e9ecef;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .status-counters {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-bottom: clamp(10px, 2vw, 15px);
      justify-content: center;
    }

    .counter-badge {
      background: #e3f2fd;
      padding: clamp(6px, 1vw, 8px) clamp(10px, 2vw, 15px);
      border-radius: 20px;
      font-weight: bold;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .counter-badge.pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .counter-badge.completed {
      background-color: #d4edda;
      color: #155724;
    }

    .toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #1976d2;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: clamp(3px, 0.5vw, 5px);
      padding: clamp(3px, 0.5vw, 5px) clamp(5px, 1vw, 10px);
      border-radius: 4px;
      transition: all 0.2s;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
      touch-action: manipulation;
    }

    .toggle-btn:hover {
      background-color: #e3f2fd;
    }

    .blink-toggle {
      color: #e74c3c;
    }

    .blink-toggle:hover {
      color: #c0392b;
    }

    .status-row {
      transition: background-color 0.3s;
    }

    .status-row:hover {
      background-color: #ebf8ff;
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .table-container {
        overflow-x: auto;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
      }

      table {
        table-layout: fixed;
        width: 100%;
      }

      th, td {
        padding: clamp(2px, 0.5vw, 4px);
        font-size: clamp(0.6rem, 1.2vw, 0.7rem);
        width: auto;
      }

      #statusTable th:nth-child(1),
      #statusTable th:nth-child(2),
      #statusTable th:nth-child(3),
      #statusTable th:nth-child(4),
      #statusTable th:nth-child(5),
      #statusTable th:nth-child(6),
      #statusTable td:nth-child(1),
      #statusTable td:nth-child(2),
      #statusTable td:nth-child(3),
      #statusTable td:nth-child(4),
      #statusTable td:nth-child(5),
      #statusTable td:nth-child(6) {
        width: calc(100% / 6 * 0.9);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(70px, 12vw, 90px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(70px, 12vw, 90px)) / 11 * 0.8);
      }
    }

    @media (max-width: 1024px) {
      .card {
        padding: clamp(8px, 1.5vw, 15px);
      }
      
      .table-container {
        margin-left: calc(-1vw);
        margin-right: calc(-1vw);
        padding: 0 1vw;
      }
      
      table {
        min-width: 0;
      }
      
      body {
        padding: clamp(5px, 1vw, 10px);
      }
      
      .container {
        padding: clamp(10px, 2vw, 15px);
      }
    }

    @media (max-width: 768px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(45px, 1fr));
        gap: clamp(6px, 1vw, 10px);
      }
      
      .btn {
        min-width: 90px;
        padding: clamp(6px, 1.5vw, 10px);
      }
      
      .table-container {
        margin-left: calc(-2vw);
        margin-right: calc(-2vw);
        padding: 0 2vw;
      }
      
      .dashboard {
        flex-direction: column;
      }
      
      .card {
        width: 100%;
        margin-bottom: clamp(10px, 2vw, 15px);
      }
      
      body {
        min-height: 100%;
        height: auto;
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        min-height: 100%;
        height: auto;
        padding: clamp(8px, 1.5vw, 12px);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(60px, 20vw, 80px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(60px, 20vw, 80px)) / 11 * 0.8);
      }
    }

    @media (max-width: 600px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(40px, 1fr));
        gap: clamp(5px, 1vw, 8px);
      }
      
      .compactor-btn {
        font-size: clamp(12px, 2.2vw, 16px);
        padding: clamp(6px, 1.2vw, 12px);
      }
      
      table {
        min-width: 0;
        font-size: clamp(0.6rem, 1.4vw, 0.7rem);
      }
      
      th, td {
        padding: clamp(2px, 0.5vw, 4px);
      }
      
      .btn {
        min-width: 80px;
        font-size: clamp(0.75rem, 2vw, 0.85rem);
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .table-header > div {
        width: 100%;
        justify-content: flex-end;
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(50px, 18vw, 70px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        font-size: clamp(0.65rem, 1.6vw, 0.75rem);
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(50px, 18vw, 70px)) / 11 * 0.7);
      }
    }

    @media (max-width: 400px) {
      body {
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        padding: clamp(8px, 1.5vw, 12px);
      }
      
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
      }
      
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(35px, 1fr));
        gap: clamp(4px, 0.8vw, 6px);
      }
      
      .compactor-btn {
        font-size: clamp(10px, 2vw, 14px);
        padding: clamp(5px, 1vw, 10px);
      }
      
      table {
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Compactor Progress Tracker</h1>
      <div class="header-right">
        <span id="syncStatus" class="sync-status disconnected">Not signed in</span>
        <button id="signInButton" class="btn btn-signin">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
            <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
          </svg>
          Sign In
        </button>
      </div>
    </header>
    <div id="error" class="error"></div>
    <div class="dashboard">
      <div class="card">
        <div class="card-header">Compactor Controls</div>
        <div class="compactor-grid">
          <button class="compactor-btn" data-machine="1" aria-label="Toggle compactor 1 status">1</button>
          <button class="compactor-btn" data-machine="2" aria-label="Toggle compactor 2 status">2</button>
          <button class="compactor-btn" data-machine="3" aria-label="Toggle compactor 3 status">3</button>
          <button class="compactor-btn" data-machine="4" aria-label="Toggle compactor 4 status">4</button>
          <button class="compactor-btn" data-machine="5" aria-label="Toggle compactor 5 status">5</button>
          <button class="compactor-btn" data-machine="6" aria-label="Toggle compactor 6 status">6</button>
          <button class="compactor-btn" data-machine="7" aria-label="Toggle compactor 7 status">7</button>
          <button class="compactor-btn" data-machine="8" aria-label="Toggle compactor 8 status">8</button>
          <button class="compactor-btn" data-machine="9" aria-label="Toggle compactor 9 status">9</button>
          <button class="compactor-btn" data-machine="10" aria-label="Toggle compactor 10 status">10</button>
        </div>
      </div>
      <div class="card">
        <div class="table-header">
          <h3>Status Records</h3>
          <div>
            <span id="statusCount" class="counter">0 records</span>
            <span id="pendingCount" class="counter counter-badge pending">0 pending</span>
            <span id="completedCount" class="counter counter-badge completed">0 completed</span>
            <button id="toggleRecords" class="toggle-btn" style="display: none;">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
              </svg>
              Show All
            </button>
          </div>
        </div>
        <div class="table-container">
          <table id="statusTable">
            <caption>Compactor Status Records</caption>
            <thead>
              <tr>
                <th>#</th>
                <th>Machine</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Duration</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="statusBody">
              <tr><td colspan="6" style="text-align: center; color: #6c757d;">No records</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <div class="table-header">
          <h3>Hourly Records</h3>
          <div>
            <span id="hourlyCount" class="counter">0 hours</span>
            <button id="toggleHourly" class="toggle-btn" style="display: none;">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
              </svg>
              Show All
            </button>
            <button id="toggleBlink" class="toggle-btn blink-toggle">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
              Stop Blinking
            </button>
          </div>
        </div>
        <div class="table-container">
          <table id="hourlyTable">
            <caption>Hourly Compactor Records</caption>
            <thead>
              <tr>
                <th>Time Slot</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
                <th>5</th>
                <th>6</th>
                <th>7</th>
                <th>8</th>
                <th>9</th>
                <th>10</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="hourlyBody">
              <tr><td colspan="12" style="text-align: center; color: #6c757d;">No hourly records</td></tr>
            </tbody>
            <tr id="cumulativeRow" class="cumulative-row" style="display: none;"></tr>
          </table>
        </div>
      </div>
    </div>
    <div class="btn-group">
      <button id="exportButton" class="btn btn-export">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
          <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
        Export
      </button>
      <button id="clearButton" class="btn btn-clear">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
        </svg>
        Clear
      </button>
      <button id="undoButton" class="btn btn-undo" disabled>
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
          <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
        </svg>
        Undo
      </button>
    </div>
    <div class="footer">
      Compactor Progress Tracker &copy; 2025
    </div>
  </div>
</body>
<script>
// Google Sheets API configuration
  const API_KEY = 'AIzaSyD7iPND2yyzqY1JyC5n1la7S5NnDwpNOVM';
  const CLIENT_ID = '959994109190-rrpedrd8vg3es3meibc9gbim7a1r0254.apps.googleusercontent.com';
  const SPREADSHEET_ID = '1w6suOx0R43BUGhi_ylAohNzj7j3Z_quO9k2yoJ5CcSo';
  const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

  let log = [];
  let actionHistory = [];
  let showAllRecords = false;
  let showAllHourly = false;
  let isBlinkingEnabled = true;
  let updateInterval = null;
  let syncInterval = null;
  let accessToken = null;
  let tokenClient = null;
  let firstEntryDate = null;

  const timeSlots = [
    { start: '07:30', end: '08:29' },
    { start: '08:30', end: '09:29' },
    { start: '09:30', end: '10:29' },
    { start: '10:30', end: '11:29' },
    { start: '11:30', end: '12:29' },
    { start: '12:30', end: '13:29' },
    { start: '13:30', end: '14:29' },
    { start: '14:30', end: '15:29' },
    { start: '15:30', end: '16:29' },
    { start: '16:30', end: '17:29' },
    { start: '17:30', end: '18:29' },
    { start: '18:30', end: '19:29' },
    { start: '19:30', end: '20:29' },
    { start: '20:30', end: '21:29' },
    { start: '21:30', end: '22:29' },
    { start: '22:30', end: '23:29' },
    { start: '23:30', end: '00:29' },
    { start: '00:30', end: '01:29' },
    { start: '01:30', end: '02:29' },
    { start: '02:30', end: '03:29' },
    { start: '03:30', end: '04:29' },
    { start: '04:30', end: '05:29' },
    { start: '05:30', end: '06:29' }
  ];

  const parseTime = (timeStr, referenceDate = new Date()) => {
    const [hours, mins] = timeStr.split(':').map(Number);
    const date = new Date(referenceDate);
    date.setHours(hours, mins, 0, 0);
    if (hours < 7) date.setDate(date.getDate() + 1);
    return date;
  };

  function loadFromLocalStorage() {
    const savedData = localStorage.getItem('compactorData');
    if (savedData) {
      const parsedData = JSON.parse(savedData);
      log = parsedData.log || [];
      actionHistory = parsedData.actionHistory || [];
      showAllRecords = parsedData.showAllRecords || false;
      showAllHourly = parsedData.showAllHourly || false;
      isBlinkingEnabled = parsedData.isBlinkingEnabled || true;
      firstEntryDate = parsedData.firstEntryDate ? new Date(parsedData.firstEntryDate) : null;
      log = log.map(entry => ({
        ...entry,
        entryTimestamp: new Date(entry.entryTimestamp)
      }));
    }
  }

  function saveToLocalStorage() {
    const data = {
      log,
      actionHistory,
      showAllRecords,
      showAllHourly,
      isBlinkingEnabled,
      firstEntryDate: firstEntryDate ? firstEntryDate.toISOString() : null
    };
    localStorage.setItem('compactorData', JSON.stringify(data));
    sessionStorage.setItem('tempCompactorData', JSON.stringify(data));
  }

  function clearLocalStorage() {
    localStorage.removeItem('compactorData');
    sessionStorage.removeItem('tempCompactorData');
    log = [];
    actionHistory = [];
    showAllRecords = false;
    showAllHourly = false;
    isBlinkingEnabled = true;
    firstEntryDate = null;
  }

  function formatTimeForExport(date) {
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const seconds = date.getSeconds().toString().padStart(2, '0');
    return `${hours}${minutes}${seconds}`;
  }

  function displayError(message) {
    const errorElement = document.getElementById('error');
    errorElement.textContent = message;
    updateSyncStatus('error', message);
    setTimeout(() => {
      if (errorElement.textContent === message) {
        errorElement.textContent = '';
      }
    }, 5000);
  }

  function updateSyncStatus(status, message) {
    const syncStatus = document.getElementById('syncStatus');
    syncStatus.textContent = message;
    syncStatus.className = `sync-status ${status}`;
    if (status !== 'disconnected') {
      setTimeout(() => {
        syncStatus.textContent = accessToken ? 'Connected to Google Sheets' : 'Not signed in';
        syncStatus.className = `sync-status ${accessToken ? 'connected' : 'disconnected'}`;
      }, 3000);
    }
  }

  function waitForGoogleApis(attempts = 50) {
    if (attempts <= 0) {
      displayError('Google APIs failed to load');
      console.error('Google APIs failed to load after multiple attempts');
      updateSyncStatus('error', 'Google APIs failed to load');
      return;
    }
    if (typeof google !== 'undefined' && typeof gapi !== 'undefined') {
      initClient();
      waitForGoogleSignIn();
    } else {
      setTimeout(() => waitForGoogleApis(attempts - 1), 100);
    }
  }

  function waitForGoogleSignIn(attempts = 50) {
    if (attempts <= 0) {
      displayError('Google Sign-In library failed to load');
      console.error('Google Sign-In library failed to load after multiple attempts');
      updateSyncStatus('error', 'Google Sign-In library failed to load');
      return;
    }
    if (typeof google !== 'undefined' && typeof google.accounts !== 'undefined') {
      initGoogleSignIn();
    } else {
      setTimeout(() => waitForGoogleSignIn(attempts - 1), 100);
    }
  }

  function initClient() {
    try {
      gapi.load('client', () => {
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS
        }).then(() => {
          if (accessToken) {
            gapi.client.setToken({ access_token: accessToken });
            checkSpreadsheetAccess();
          }
        }).catch(error => {
          console.error('Error initializing Google API client:', error);
          displayError(`Google API init failed: ${error.details || error.message || 'Unknown error'}`);
          updateSyncStatus('error', `Google API init failed: ${error.details || error.message || 'Unknown error'}`);
        });
      });
    } catch (error) {
      console.error('Error loading gapi client:', error);
      displayError('Google API load failed');
      updateSyncStatus('error', 'Google API load failed');
    }
  }

  function initGoogleSignIn() {
    try {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            gapi.client.setToken({ access_token: accessToken });
            displayError('Connected to Google Sheets');
            updateSyncStatus('connected', 'Connected to Google Sheets');
            document.getElementById('signInButton').style.display = 'none';
            checkSpreadsheetAccess();
          } else {
            console.error('Authentication failed: No access token received');
            displayError('Authentication failed. Click Sign In and allow popups.');
            updateSyncStatus('error', 'Authentication failed');
          }
        },
        error_callback: (error) => {
          console.error('Google Sign-In error:', error);
          let errorMessage = error.message || 'Unknown error';
          if (error.message && error.message.includes('popup')) {
            errorMessage = 'Popup blocked. Allow popups and try Sign In again.';
          }
          displayError(`Sign-in failed: ${errorMessage}`);
          updateSyncStatus('error', `Sign-in failed: ${errorMessage}`);
        }
      });
    } catch (error) {
      console.error('Error initializing Google Sign-In:', error);
      displayError('Sign-in initialization failed');
      updateSyncStatus('error', 'Sign-in initialization failed');
    }
  }

  function signOut() {
    if (accessToken) {
      google.accounts.oauth2.revoke(accessToken, () => {
        console.log('Access token revoked');
      });
      accessToken = null;
      gapi.client.setToken(null);
      document.getElementById('signInButton').style.display = 'flex';
      document.getElementById('signInButton').className = 'btn btn-signin';
      document.getElementById('signInButton').innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
          <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
        </svg>
        Sign In
      `;
      updateSyncStatus('disconnected', 'Not signed in');
      displayError('Signed out');
    }
  }

  async function checkSpreadsheetAccess() {
    if (!accessToken) {
      displayError('Not signed in');
      updateSyncStatus('disconnected', 'Not signed in');
      return;
    }
    try {
      await gapi.client.sheets.spreadsheets.get({
        spreadsheetId: SPREADSHEET_ID
      });
      if (await ensureSheetExists('Sheet1') && await ensureSheetExists('Sheet2')) {
        syncToGoogleSheets();
      }
    } catch (error) {
      console.error('Error accessing spreadsheet:', error);
      displayError(`Cannot access spreadsheet: ${error.result?.error?.message || error.message || 'Unknown error'}. Share the sheet with your Google account.`);
      updateSyncStatus('error', `Cannot access spreadsheet: ${error.result?.error?.message || error.message || 'Unknown error'}`);
    }
  }

  async function ensureSheetExists(sheetName) {
    if (!accessToken) {
      displayError('Not signed in');
      updateSyncStatus('disconnected', 'Not signed in');
      return false;
    }
    try {
      const response = await gapi.client.sheets.spreadsheets.get({
        spreadsheetId: SPREADSHEET_ID
      });
      const sheets = response.result.sheets;
      const sheetExists = sheets.some(sheet => sheet.properties.title === sheetName);
      if (!sheetExists) {
        await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: SPREADSHEET_ID,
          requests: [{
            addSheet: {
              properties: {
                title: sheetName
              }
            }
          }]
        });
      }
      return true;
    } catch (error) {
      console.error(`Error checking/creating ${sheetName}:`, error);
      displayError(`Cannot access spreadsheet: ${error.result?.error?.message || error.message || 'Unknown error'}. Verify spreadsheet ID and permissions.`);
      updateSyncStatus('error', `Cannot access spreadsheet: ${error.result?.error?.message || error.message || 'Unknown error'}`);
      return false;
    }
  }

  async function ensureExportSheetExists(sheetName) {
    if (!accessToken) {
      displayError('Not signed in');
      updateSyncStatus('disconnected', 'Not signed in');
      return false;
    }
    try {
      const response = await gapi.client.sheets.spreadsheets.get({
        spreadsheetId: SPREADSHEET_ID
      });
      const sheets = response.result.sheets;
      const sheetExists = sheets.some(sheet => sheet.properties.title === sheetName);
      if (!sheetExists) {
        await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: SPREADSHEET_ID,
          requests: [{
            addSheet: {
              properties: {
                title: sheetName
              }
            }
          }]
        });
      }
      return true;
    } catch (error) {
      console.error(`Error checking/creating export sheet ${sheetName}:`, error);
      displayError(`Cannot create export sheet: ${error.result?.error?.message || error.message || 'Unknown error'}. Verify spreadsheet ID and permissions.`);
      updateSyncStatus('error', `Cannot create export sheet: ${error.result?.error?.message || error.message || 'Unknown error'}`);
      return false;
    }
  }

  async function syncToGoogleSheets(context = 'auto') {
    if (!accessToken) {
      displayError('Not signed in');
      updateSyncStatus('disconnected', 'Not signed in');
      return false;
    }

    if (!(await ensureSheetExists('Sheet1')) || !(await ensureSheetExists('Sheet2'))) {
      return false;
    }

    displayError(`Syncing to Google Sheets (${context})...`);
    updateSyncStatus('connected', `Syncing to Google Sheets (${context})...`);

    const statusValues = log.map(entry => [
      entry.entryTimestamp.toISOString(),
      entry.machineNumber,
      entry.inTime,
      entry.outTime || '',
      calculateDuration(entry.inTime, entry.outTime).display
    ]);

    const hourlyRecords = [];
    const completedEntries = log.filter(entry => entry.outTime);

    timeSlots.forEach(slot => {
      const slotStart = parseTime(slot.start, firstEntryDate || new Date());
      const slotEnd = parseTime(slot.end, slotStart);
      const machineCounts = Array(11).fill(0);

      completedEntries.forEach(entry => {
        const inTime = parseTime(entry.inTime, firstEntryDate || new Date());
        const outTime = parseTime(entry.outTime, inTime);

        if (inTime >= slotStart && outTime <= slotEnd) {
          machineCounts[entry.machineNumber]++;
        }
      });

      if (showAllHourly || machineCounts.some(count => count > 0)) {
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        hourlyRecords.push([`${slot.start}-${slot.end}`, ...machineCounts.slice(1), total]);
      }
    });

    const cumulativeCounts = Array(11).fill(0);
    completedEntries.forEach(entry => {
      cumulativeCounts[entry.machineNumber]++;
    });
    const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);
    if (cumulativeTotal > 0) {
      hourlyRecords.unshift(['Cumulative Total', ...cumulativeCounts.slice(1), cumulativeTotal]);
    }

    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'Sheet1!A1:E',
        valueInputOption: 'RAW',
        resource: {
          values: [
            ['Timestamp', 'Machine Number', 'In Time', 'Out Time', 'Duration'],
            ...statusValues
          ]
        }
      });

      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: 'Sheet2!A1:L',
        valueInputOption: 'RAW',
        resource: {
          values: [
            ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
            ...hourlyRecords
          ]
        }
      });

      displayError(`Synced to Google Sheets (${context})`);
      updateSyncStatus('connected', `Synced to Google Sheets (${context})`);
      return true;
    } catch (error) {
      console.error(`Error syncing to Google Sheets (${context}):`, error);
      let errorMessage = error.result?.error?.message || error.message || 'Unknown error';
      if (error.result?.error?.status === 'PERMISSION_DENIED') {
        errorMessage = 'Permission denied. Share the spreadsheet with your Google account.';
      } else if (error.result?.error?.status === 'UNAUTHENTICATED') {
        accessToken = null;
        errorMessage = 'Authentication expired. Click Sign In and allow popups.';
        document.getElementById('signInButton').style.display = 'flex';
        document.getElementById('signInButton').className = 'btn btn-signin';
        document.getElementById('signInButton').innerHTML = `
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
            <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
          </svg>
          Sign In
        `;
      } else if (error.result?.error?.status === 'INVALID_ARGUMENT') {
        errorMessage = 'Invalid request. Ensure the spreadsheet has tabs named "Sheet1" and "Sheet2" and verify the spreadsheet ID.';
      }
      displayError(`Sync failed: ${errorMessage}`);
      updateSyncStatus('error', `Sync failed: ${errorMessage}`);
      return false;
    }
  }

  async function exportAndClearData() {
    if (!log.length) {
      displayError('No data to export');
      updateSyncStatus('error', 'No data to export');
      return;
    }

    if (!confirm('Are you sure you want to export the data to CSV, sync to Google Sheets, and clear all data?')) {
      return;
    }

    const now = new Date();
    const dateString = firstEntryDate ? firstEntryDate.toISOString().slice(0, 10).replace(/-/g, '') : now.toISOString().slice(0, 10).replace(/-/g, '');
    const timeString = formatTimeForExport(now);
    const sheetName = `CPT_${dateString}_${timeString}`;

    const statusValues = log.map(entry => [
      entry.entryTimestamp.toISOString(),
      entry.machineNumber,
      entry.inTime,
      entry.outTime || '',
      calculateDuration(entry.inTime, entry.outTime).display
    ]);

    const hourlyRecords = [];
    const completedEntries = log.filter(entry => entry.outTime);

    timeSlots.forEach(slot => {
      const slotStart = parseTime(slot.start, firstEntryDate || new Date());
      const slotEnd = parseTime(slot.end, slotStart);
      const machineCounts = Array(11).fill(0);

      completedEntries.forEach(entry => {
        const inTime = parseTime(entry.inTime, firstEntryDate || new Date());
        const outTime = parseTime(entry.outTime, inTime);

        if (inTime >= slotStart && outTime <= slotEnd) {
          machineCounts[entry.machineNumber]++;
        }
      });

      if (showAllHourly || machineCounts.some(count => count > 0)) {
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        hourlyRecords.push([`${slot.start}-${slot.end}`, ...machineCounts.slice(1), total]);
      }
    });

    const cumulativeCounts = Array(11).fill(0);
    completedEntries.forEach(entry => {
      cumulativeCounts[entry.machineNumber]++;
    });
    const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);
    if (cumulativeTotal > 0) {
      hourlyRecords.unshift(['Cumulative Total', ...cumulativeCounts.slice(1), cumulativeTotal]);
    }

    const data = [
      ['STATUS RECORDS'],
      ['Timestamp', 'Machine Number', 'In Time', 'Out Time', 'Duration'],
      ...statusValues,
      ['', '', '', '', ''],
      ['HOURLY RECORDS'],
      ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
      ...hourlyRecords,
      ['', '', '', '', '', '', '', '', '', '', '', ''],
      ['Total Completed Entries', cumulativeTotal, '']
    ];

    try {
      const csv = '\ufeff' + data.map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `CPT_${dateString}_${timeString}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      let exportSuccess = false;
      if (accessToken) {
        displayError('Exporting to Google Sheet...');
        updateSyncStatus('connected', 'Exporting to Google Sheet...');
        if (await ensureExportSheetExists(sheetName)) {
          try {
            await gapi.client.sheets.spreadsheets.values.update({
              spreadsheetId: SPREADSHEET_ID,
              range: `${sheetName}!A1`,
              valueInputOption: 'RAW',
              resource: { values: data }
            });
            exportSuccess = true;
            displayError('Exported to Google Sheet and CSV');
            updateSyncStatus('connected', 'Exported to Google Sheet and CSV');
          } catch (error) {
            console.error('Error exporting to Google Sheet:', error);
            let errorMessage = error.result?.error?.message || error.message || 'Unknown error';
            if (error.result?.error?.status === 'PERMISSION_DENIED') {
              errorMessage = 'Permission denied. Share the spreadsheet with your Google account.';
            } else if (error.result?.error?.status === 'UNAUTHENTICATED') {
              accessToken = null;
              errorMessage = 'Authentication expired. Click Sign In and allow popups.';
              document.getElementById('signInButton').style.display = 'flex';
              document.getElementById('signInButton').className = 'btn btn-signin';
              document.getElementById('signInButton').innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
                  <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                </svg>
                Sign In
              `;
            } else if (error.result?.error?.status === 'INVALID_ARGUMENT') {
              errorMessage = `Invalid request. Ensure the spreadsheet has a tab named "${sheetName}" and verify the spreadsheet ID.`;
            }
            displayError(`Export failed: ${errorMessage}`);
            updateSyncStatus('error', `Export failed: ${errorMessage}`);
          }
        }
      }

      actionHistory.push({ action: 'clear', prevLog: JSON.parse(JSON.stringify(log)) });
      clearLocalStorage();
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      document.getElementById('undoButton').disabled = false;
      displayError(exportSuccess ? 
        'Data exported to CSV and Google Sheet, local storage cleared' : 
        'Data exported to CSV, local storage cleared, Google Sheet sync failed');
      updateSyncStatus(exportSuccess ? 'connected' : 'error', exportSuccess ? 
        'Data exported to CSV and Google Sheet, local storage cleared' : 
        'Data exported to CSV, local storage cleared, Google Sheet sync failed');
    } catch (error) {
      console.error('Error during CSV export:', error);
      displayError('Failed to export CSV');
      updateSyncStatus('error', 'Failed to export CSV');
    }
  }

  function initializeApp() {
    loadFromLocalStorage();
    updateStatusTable();
    updateHourlyTable();
    updateMachineButtonStates();
    document.getElementById('undoButton').disabled = actionHistory.length === 0;
    updateInterval = setInterval(updateStatusTable, 60000);
    syncInterval = setInterval(async () => {
      if (accessToken) {
        try {
          await gapi.client.sheets.spreadsheets.get({
            spreadsheetId: SPREADSHEET_ID
          });
          syncToGoogleSheets();
        } catch (error) {
          if (error.result?.error?.status === 'UNAUTHENTICATED') {
            accessToken = null;
            document.getElementById('signInButton').style.display = 'flex';
            document.getElementById('signInButton').className = 'btn btn-signin';
            document.getElementById('signInButton').innerHTML = `
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
                <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
              </svg>
              Sign In
            `;
            displayError('Authentication expired. Click Sign In and allow popups.');
            updateSyncStatus('disconnected', 'Not signed in');
          }
        }
      }
    }, 300000);
    waitForGoogleApis();
    window.addEventListener('beforeunload', saveToLocalStorage);
  }

  function calculateDuration(inTime, outTime) {
    if (!outTime) {
      const now = new Date();
      const inDate = parseTime(inTime, firstEntryDate || new Date());
      const minutes = Math.floor((now - inDate) / 60000);
      return { display: `${minutes} min`, minutes };
    }
    const inDate = parseTime(inTime, firstEntryDate || new Date());
    const outDate = parseTime(outTime, inDate);
    const minutes = Math.floor((outDate - inDate) / 60000);
    return { display: `${minutes} min`, minutes };
  }

  function updateStatusTable() {
    const statusBody = document.getElementById('statusBody');
    const statusCount = document.getElementById('statusCount');
    const pendingCount = document.getElementById('pendingCount');
    const completedCount = document.getElementById('completedCount');
    const toggleButton = document.getElementById('toggleRecords');

    const pendingRecords = log.filter(entry => !entry.outTime).length;
    const completedRecords = log.filter(entry => entry.outTime).length;

    statusCount.textContent = `${log.length} records`;
    pendingCount.textContent = `${pendingRecords} pending`;
    completedCount.textContent = `${completedRecords} completed`;

    toggleButton.style.display = log.length > 10 ? 'flex' : 'none';
    toggleButton.innerHTML = `
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
      </svg>
      ${showAllRecords ? 'Show Less' : 'Show All'}
    `;

    if (log.length === 0) {
      statusBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #6c757d;">No records</td></tr>`;
      return;
    }

    log.sort((a, b) => new Date(b.entryTimestamp) - new Date(a.entryTimestamp));
    const displayEntries = showAllRecords ? log : log.slice(0, 10);

    statusBody.innerHTML = '';
    displayEntries.forEach((entry, index) => {
      const row = document.createElement('tr');
      row.className = 'status-row';
      row.dataset.machine = entry.machineNumber;
      row.dataset.timestamp = entry.entryTimestamp.toISOString();

      const { display, minutes } = calculateDuration(entry.inTime, entry.outTime);
      const blinkClass = isBlinkingEnabled && !entry.outTime && minutes > 39 ? 'blink' : '';
      const containerNumber = log.length - index;

      row.innerHTML = `
        <td>${containerNumber}</td>
        <td class="${blinkClass}">${entry.machineNumber}</td>
        <td class="time-cell">${entry.inTime}</td>
        <td class="time-cell">${entry.outTime || '-'}</td>
        <td>${display}</td>
        <td>
          <svg class="delete-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
          </svg>
        </td>
      `;
      statusBody.appendChild(row);
    });

    document.querySelectorAll('.time-cell').forEach(cell => {
      cell.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        const machine = row.dataset.machine;
        const timestamp = row.dataset.timestamp;
        const entry = log.find(e => e.machineNumber == machine && e.entryTimestamp.toISOString() === timestamp);
        if (entry && !entry.outTime) {
          const now = new Date();
          const hours = now.getHours().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');
          actionHistory.push({ action: 'out', machine, prevLog: JSON.parse(JSON.stringify(log)) });
          entry.outTime = `${hours}:${minutes}`;
          saveToLocalStorage();
          syncToGoogleSheets('manual');
          updateStatusTable();
          updateHourlyTable();
          updateMachineButtonStates();
          document.getElementById('undoButton').disabled = false;
        }
      });
    });

    document.querySelectorAll('.delete-icon').forEach(icon => {
      icon.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        const machine = row.dataset.machine;
        const timestamp = row.dataset.timestamp;
        const entryIndex = log.findIndex(e => e.machineNumber == machine && e.entryTimestamp.toISOString() === timestamp);
        if (entryIndex !== -1) {
          actionHistory.push({ action: 'delete', entry: JSON.parse(JSON.stringify(log[entryIndex])), index: entryIndex });
          log.splice(entryIndex, 1);
          if (!log.length) firstEntryDate = null;
          saveToLocalStorage();
          syncToGoogleSheets('manual');
          updateStatusTable();
          updateHourlyTable();
          updateMachineButtonStates();
          document.getElementById('undoButton').disabled = false;
        }
      });
    });
  }

  function updateHourlyTable() {
    const hourlyBody = document.getElementById('hourlyBody');
    const hourlyCount = document.getElementById('hourlyCount');
    const toggleHourly = document.getElementById('toggleHourly');
    const cumulativeRow = document.getElementById('cumulativeRow');
    const completedEntries = log.filter(entry => entry.outTime);

    const hourlyRecords = [];
    timeSlots.forEach(slot => {
      const slotStart = parseTime(slot.start, firstEntryDate || new Date());
      const slotEnd = parseTime(slot.end, slotStart);
      const machineCounts = Array(11).fill(0);

      completedEntries.forEach(entry => {
        const inTime = parseTime(entry.inTime, firstEntryDate || new Date());
        const outTime = parseTime(entry.outTime, inTime);

        if (inTime >= slotStart && outTime <= slotEnd) {
          machineCounts[entry.machineNumber]++;
        }
      });

      if (showAllHourly || machineCounts.some(count => count > 0)) {
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        hourlyRecords.push([`${slot.start}-${slot.end}`, ...machineCounts.slice(1), total]);
      }
    });

    hourlyCount.textContent = `${hourlyRecords.length} hours`;
    toggleHourly.style.display = timeSlots.length > hourlyRecords.length ? 'flex' : 'none';
    toggleHourly.innerHTML = `
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
      </svg>
      ${showAllHourly ? 'Show Less' : 'Show All'}
    `;

    if (hourlyRecords.length === 0) {
      hourlyBody.innerHTML = `<tr><td colspan="12" style="text-align: center; color: #6c757d;">No hourly records</td></tr>`;
      cumulativeRow.style.display = 'none';
      return;
    }

    hourlyBody.innerHTML = '';
    hourlyRecords.forEach(record => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${record[0]}</td>
        ${record.slice(1).map(value => `<td>${value}</td>`).join('')}
      `;
      hourlyBody.appendChild(row);
    });

    const cumulativeCounts = Array(11).fill(0);
    completedEntries.forEach(entry => {
      cumulativeCounts[entry.machineNumber]++;
    });
    const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);

    if (cumulativeTotal > 0) {
      cumulativeRow.style.display = '';
      cumulativeRow.innerHTML = `
        <th>Cumulative Total</th>
        ${cumulativeCounts.slice(1).map(count => `<td>${count}</td>`).join('')}
        <td>${cumulativeTotal}</td>
      `;
    } else {
      cumulativeRow.style.display = 'none';
    }
  }

  function updateMachineButtonStates() {
    document.querySelectorAll('.compactor-btn').forEach(button => {
      const machine = button.dataset.machine;
      const isActive = log.some(entry => entry.machineNumber == machine && !entry.outTime);
      button.classList.toggle('active', isActive);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    initializeApp();

    document.querySelectorAll('.compactor-btn').forEach(button => {
      button.addEventListener('click', () => {
        const machine = button.dataset.machine;
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const time = `${hours}:${minutes}`;
        const isActive = log.some(entry => entry.machineNumber == machine && !entry.outTime);

        if (!firstEntryDate) {
          firstEntryDate = new Date();
        }

        if (isActive) {
          const entry = log.find(entry => entry.machineNumber == machine && !entry.outTime);
          actionHistory.push({ action: 'out', machine, prevLog: JSON.parse(JSON.stringify(log)) });
          entry.outTime = time;
        } else {
          actionHistory.push({ action: 'in', machine, prevLog: JSON.parse(JSON.stringify(log)) });
          log.push({
            entryTimestamp: new Date(),
            machineNumber: parseInt(machine),
            inTime: time,
            outTime: null
          });
        }

        saveToLocalStorage();
        syncToGoogleSheets('manual');
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = false;
      });
    });

    document.getElementById('signInButton').addEventListener('click', () => {
      if (accessToken) {
        signOut();
      } else {
        tokenClient.requestAccessToken();
      }
    });

    document.getElementById('exportButton').addEventListener('click', exportAndClearData);

    document.getElementById('clearButton').addEventListener('click', () => {
      if (!log.length) {
        displayError('No data to clear');
        return;
      }
      if (confirm('Are you sure you want to clear all data?')) {
        actionHistory.push({ action: 'clear', prevLog: JSON.parse(JSON.stringify(log)) });
        clearLocalStorage();
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = false;
        displayError('Data cleared');
        syncToGoogleSheets('manual');
      }
    });

    document.getElementById('undoButton').addEventListener('click', () => {
      if (actionHistory.length === 0) return;

      const lastAction = actionHistory.pop();
      log = JSON.parse(JSON.stringify(lastAction.prevLog || []));

      if (lastAction.action === 'delete') {
        log.splice(lastAction.index, 0, lastAction.entry);
      }

      if (!log.length) {
        firstEntryDate = null;
      } else {
        const earliestEntry = log.reduce((earliest, entry) => {
          const entryDate = parseTime(entry.inTime, entry.entryTimestamp);
          return !earliest || entryDate < earliest ? entryDate : earliest;
        }, null);
        firstEntryDate = earliestEntry ? new Date(earliestEntry.getFullYear(), earliestEntry.getMonth(), earliestEntry.getDate()) : null;
      }

      saveToLocalStorage();
      syncToGoogleSheets('manual');
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      document.getElementById('undoButton').disabled = actionHistory.length === 0;
      displayError('Last action undone');
    });

    document.getElementById('toggleRecords').addEventListener('click', () => {
      showAllRecords = !showAllRecords;
      saveToLocalStorage();
      updateStatusTable();
    });

    document.getElementById('toggleHourly').addEventListener('click', () => {
      showAllHourly = !showAllHourly;
      saveToLocalStorage();
      updateHourlyTable();
    });

    document.getElementById('toggleBlink').addEventListener('click', () => {
      isBlinkingEnabled = !isBlinkingEnabled;
      document.getElementById('toggleBlink').innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="${isBlinkingEnabled ? 'M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z' : 'M4 4.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z'}"/>
        </svg>
        ${isBlinkingEnabled ? 'Stop Blinking' : 'Start Blinking'}
      `;
      saveToLocalStorage();
      updateStatusTable();
    });
  });
</script>
</html>
