<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compactor Progress Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
    h1, h2 { text-align: center; color: #333; }
    .container { max-width: 1200px; margin: auto; }
    .auth { text-align: center; margin-bottom: 20px; }
    .machine-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .machine-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .machine-button:hover { background-color: #0056b3; }
    .machine-button.active { background-color: #28a745; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; }
    .control-button { padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .control-button:hover { background-color: #c82333; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #007bff; color: white; }
    .error { color: red; margin: 10px 0; text-align: center; }
    .footer { text-align: center; margin-top: 20px; color: #666; }
    .editable:hover { cursor: pointer; text-decoration: underline; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="container">
    <h1>Compactor Progress Tracker</h1>
    <div class="auth" id="auth">
      <div id="g_id_onload"
           data-client_id="YOUR_GOOGLE_CLIENT_ID"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard" data-text="signin_with"></div>
    </div>
    <div id="main" style="display: none;">
      <h2>Compactor Entry</h2>
      <div class="machine-buttons" id="machineButtons"></div>
      <div class="controls">
        <button class="control-button" onclick="exportToCSV()">Export to CSV</button>
        <button class="control-button" onclick="clearData()">Clear All Data</button>
      </div>
      <div class="error" id="error"></div>
      <h2>Entry Log (Pending Out Time)</h2>
      <table id="pendingTable">
        <thead>
          <tr>
            <th>Compactor</th>
            <th>In Time</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h2>Completed Records</h2>
      <table id="completedTable">
        <thead>
          <tr>
            <th>Compactor</th>
            <th>In Time</th>
            <th>Out Time</th>
            <th>Duration</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h2>Hourly Records</h2>
      <table id="hourlyTable">
        <thead>
          <tr>
            <th>Time Slot</th>
            <th>Container Count</th>
            <th>Compactors</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="footer">
      Compactor Progress Tracker v2.4 | Data is stored locally in your browser | <span id="lastSync">Last synced: None</span>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwS19uEIbcvDSRMRZLfYObaNIPShcEWqyfIGji6E1eCoc4IxmNZ6bEFVqx4bmv-mTQC/exec'; // Replace with your Apps Script URL
    let log = [];
    let userEmail = null;
    let idToken = null;
    const timeSlots = Array.from({length: 23}, (_, i) => {
      const startHour = (7 + i) % 24;
      const endHour = (8 + i) % 24;
      const start = `${startHour.toString().padStart(2, '0')}:30`;
      const end = `${endHour.toString().padStart(2, '0')}:29`;
      return { start, end };
    });

    function handleCredentialResponse(response) {
      const data = JSON.parse(atob(response.credential.split('.')[1]));
      userEmail = data.email;
      idToken = response.credential;
      document.getElementById('auth').style.display = 'none';
      document.getElementById('main').style.display = 'block';
      initializeApp();
    }

    function parseTime(timeStr, referenceDate = new Date()) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date(referenceDate);
      if (hours < 7 && date.getHours() >= 7) {
        date.setDate(date.getDate() + 1);
      }
      date.setHours(hours, minutes, 0, 0);
      return date;
    }

    function formatDuration(start, end) {
      if (!end) return '-';
      const diff = parseTime(end) - parseTime(start);
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${minutes}m`;
    }

    function initializeApp() {
      const machineButtonsContainer = document.getElementById('machineButtons');
      for (let i = 1; i <= 10; i++) {
        const button = document.createElement('button');
        button.className = 'machine-button';
        button.textContent = `Compactor ${i}`;
        button.onclick = () => handleMachineButtonClick(i);
        machineButtonsContainer.appendChild(button);
      }
      updatePendingTable();
      updateCompletedTable();
      updateHourlyTable();
      syncToGoogleSheets();
      setInterval(syncToGoogleSheets, 60000);
      const lastSyncTime = localStorage.getItem('lastSyncTime') || 'None';
      document.getElementById('lastSync').textContent = `Last synced: ${lastSyncTime}`;
    }

    function handleMachineButtonClick(machineNumber) {
      if (!userEmail) {
        document.getElementById('error').textContent = 'Please sign in to record data.';
        return;
      }
      console.log('Button clicked for Compactor', machineNumber, 'at', new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
      const now = new Date();
      const timeStr = now.toLocaleString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Hong_Kong' });
      const latestEntry = log.find(entry => entry.machineNumber === machineNumber && !entry.outTime);
      if (latestEntry) {
        latestEntry.outTime = timeStr;
      } else {
        log.push({ machineNumber, inTime: timeStr, entryTimestamp: now.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }) });
      }
      console.log('Updated log:', JSON.stringify(log, null, 2));
      updatePendingTable();
      updateCompletedTable();
      updateHourlyTable();
      syncToGoogleSheets();
    }

    function updatePendingTable() {
      const tbody = document.querySelector('#pendingTable tbody');
      tbody.innerHTML = '';
      const pending = log.filter(entry => !entry.outTime);
      document.querySelector('#pendingTable').previousElementSibling.textContent = `Entry Log (Pending Out Time) - ${pending.length} pending`;
      if (pending.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No pending entries</td></tr>';
      } else {
        pending.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.machineNumber}</td>
            <td>${entry.inTime}</td>
            <td>-</td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    function updateCompletedTable() {
      const tbody = document.querySelector('#completedTable tbody');
      tbody.innerHTML = '';
      const completed = log.filter(entry => entry.outTime);
      document.querySelector('#completedTable').previousElementSibling.textContent = `Completed Records - ${completed.length} completed`;
      if (completed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No completed entries</td></tr>';
      } else {
        completed.forEach((entry, index) => {
          const duration = formatDuration(entry.inTime, entry.outTime);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.machineNumber}</td>
            <td><span class="editable" onclick="editTime(${log.indexOf(entry)}, 'inTime')">${entry.inTime}</span></td>
            <td><span class="editable" onclick="editTime(${log.indexOf(entry)}, 'outTime')">${entry.outTime}</span></td>
            <td>${duration}</td>
            <td><button onclick="deleteEntry(${log.indexOf(entry)})">Delete</button></td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    function updateHourlyTable() {
      const tbody = document.querySelector('#hourlyTable tbody');
      tbody.innerHTML = '';
      const completedEntries = log.filter(entry => entry.outTime);
      document.querySelector('#hourlyTable').previousElementSibling.textContent = `Hourly Records - ${completedEntries.length} hourly records`;
      if (completedEntries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No hourly records</td></tr>';
      } else {
        timeSlots.forEach(slot => {
          const slotStart = parseTime(slot.start);
          const slotEnd = parseTime(slot.end, slotStart);
          const compactorCounts = Array(11).fill(0);
          let containerCount = 0;
          completedEntries.forEach(entry => {
            const inTime = parseTime(entry.inTime);
            const outTime = parseTime(entry.outTime, inTime);
            if (inTime >= slotStart && outTime <= slotEnd) {
              compactorCounts[entry.machineNumber]++;
              containerCount++;
            }
          });
          if (containerCount > 0) {
            const compactors = compactorCounts.slice(1).map((count, i) => count > 0 ? `Compactor ${i+1}: ${count}` : '').filter(Boolean).join(', ');
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${slot.start}-${slot.end}</td>
              <td>${containerCount}</td>
              <td>${compactors || '-'}</td>
            `;
            tbody.appendChild(row);
          }
        });
        if (!tbody.children.length) {
          tbody.innerHTML = '<tr><td colspan="3">No hourly records</td></tr>';
        }
      }
    }

    function syncToGoogleSheets() {
      if (!userEmail) {
        console.log('No user signed in, skipping sync.');
        return;
      }
      try {
        const statusRecords = log.map((entry, index) => ({
          containerNumber: log.length - index,
          compactorNumber: entry.machineNumber || 0,
          inTime: entry.inTime || '',
          outTime: entry.outTime || '',
          userEmail: userEmail
        }));
        const completedEntries = log.filter(entry => entry.outTime);
        const hourlyRecords = timeSlots.map(slot => {
          const slotStart = parseTime(slot.start);
          const slotEnd = parseTime(slot.end, slotStart);
          const compactorCounts = Array(11).fill(0);
          let containerCount = 0;
          completedEntries.forEach(entry => {
            const inTime = parseTime(entry.inTime);
            const outTime = parseTime(entry.outTime, inTime);
            if (inTime >= slotStart && outTime <= slotEnd) {
              compactorCounts[entry.machineNumber]++;
              containerCount++;
            }
          });
          return {
            timeSlot: `${slot.start}-${slot.end}`,
            containerCount,
            compactorCounts: compactorCounts.slice(1),
            userEmail: userEmail
          };
        }).filter(record => record.containerCount > 0);
        const payload = { statusRecords, hourlyRecords, idToken };
        const syncTime = new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
        console.log('Sync attempt at', syncTime);
        console.log('Payload:', JSON.stringify(payload, null, 2));
        fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(() => {
          console.log('Data synced to Google Sheets');
          localStorage.setItem('lastSyncTime', syncTime);
          document.getElementById('lastSync').textContent = `Last synced: ${syncTime}`;
        }).catch(error => {
          console.error('Error syncing to Google Sheets:', error);
          document.getElementById('error').textContent = 'Failed to sync data to Google Sheets. Please try again later.';
        });
      } catch (error) {
        console.error('Error in syncToGoogleSheets:', error);
        document.getElementById('error').textContent = 'An error occurred while syncing data. Please try again.';
      }
    }

    function editTime(index, field) {
      if (!userEmail) {
        document.getElementById('error').textContent = 'Please sign in to edit data.';
        return;
      }
      const entry = log[index];
      const newTime = prompt(`Enter new ${field === 'inTime' ? 'In Time' : 'Out Time'} (HH:mm)`, entry[field]);
      if (newTime) {
        entry[field] = newTime;
        updatePendingTable();
        updateCompletedTable();
        updateHourlyTable();
        syncToGoogleSheets();
      }
    }

    function deleteEntry(index) {
      if (!userEmail) {
        document.getElementById('error').textContent = 'Please sign in to delete data.';
        return;
      }
      log.splice(index, 1);
      updatePendingTable();
      updateCompletedTable();
      updateHourlyTable();
      syncToGoogleSheets();
    }

    function clearData() {
      if (!userEmail) {
        document.getElementById('error').textContent = 'Please sign in to clear data.';
        return;
      }
      if (confirm('Are you sure you want to clear all data? This action is irreversible.')) {
        log = [];
        updatePendingTable();
        updateCompletedTable();
        updateHourlyTable();
        syncToGoogleSheets();
      }
    }

    function exportToCSV() {
      if (!userEmail) {
        document.getElementById('error').textContent = 'Please sign in to export data.';
        return;
      }
      const completedEntries = log.filter(entry => entry.outTime);
      const statusCSV = 'Compactor,In Time,Out Time\n' +
        completedEntries.map(entry => `${entry.machineNumber},"${entry.inTime}","${entry.outTime}"`).join('\n');
      
      const hourlyData = timeSlots.map(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const compactorCounts = Array(11).fill(0);
        let containerCount = 0;
        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);
          if (inTime >= slotStart && outTime <= slotEnd) {
            compactorCounts[entry.machineNumber]++;
            containerCount++;
          }
        });
        return {
          'Time Slot': `${slot.start}-${slot.end}`,
          'Container Count': containerCount,
          'Compactors': compactorCounts.slice(1).map((count, i) => count > 0 ? `Compactor ${i+1}: ${count}` : '').filter(Boolean).join(', ')
        };
      }).filter(row => row['Container Count'] > 0);
      const hourlyCSV = 'Time Slot,Container Count,Compactors\n' +
        hourlyData.map(row => `"${row['Time Slot']}",${row['Container Count']},"${row['Compactors']}"`).join('\n');

      const date = new Date().toISOString().split('T')[0];
      const statusBlob = new Blob([statusCSV], { type: 'text/csv' });
      const hourlyBlob = new Blob([hourlyCSV], { type: 'text/csv' });
      const statusLink = document.createElement('a');
      statusLink.href = URL.createObjectURL(statusBlob);
      statusLink.download = `compactor_status_${date}.csv`;
      statusLink.click();
      const hourlyLink = document.createElement('a');
      hourlyLink.href = URL.createObjectURL(hourlyBlob);
      hourlyLink.download = `compactor_hourly_${date}.csv`;
      hourlyLink.click();
    }
  </script>
</body>
</html>
