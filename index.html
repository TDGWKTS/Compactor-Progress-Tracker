<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compactor Progress Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
    h1 { text-align: center; color: #333; }
    .container { max-width: 1200px; margin: auto; }
    .machine-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .machine-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .machine-button:hover { background-color: #0056b3; }
    .machine-button.active { background-color: #28a745; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; }
    .control-button { padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .control-button:hover { background-color: #c82333; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #007bff; color: white; }
    .error { color: red; margin: 10px 0; }
    .footer { text-align: center; margin-top: 20px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Compactor Progress Tracker</h1>
    <div class="machine-buttons" id="machineButtons"></div>
    <div class="controls">
      <button class="control-button" onclick="undoLastAction()">Undo</button>
      <button class="control-button" onclick="clearData()">Clear Data</button>
      <button class="control-button" onclick="exportToCSV()">Export to CSV</button>
    </div>
    <div class="error" id="error"></div>
    <h2>Current Status</h2>
    <table id="statusTable">
      <thead>
        <tr>
          <th>No. of Container</th>
          <th>Compactor</th>
          <th>In Time</th>
          <th>Out Time</th>
          <th>Duration</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h2>Hourly Records</h2>
    <table id="hourlyTable">
      <thead>
        <tr>
          <th>Time Slot</th>
          <th>Machine 1</th>
          <th>Machine 2</th>
          <th>Machine 3</th>
          <th>Machine 4</th>
          <th>Machine 5</th>
          <th>Machine 6</th>
          <th>Machine 7</th>
          <th>Machine 8</th>
          <th>Machine 9</th>
          <th>Machine 10</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="footer">
      Compactor Progress Tracker v2.4 | Data is stored locally in your browser | <span id="lastSync">Last synced: None</span>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzx-lh6_AQ_Ky7ijNLy8Xt_sk830aledU1ok69wBt_t0lMKCK8t8CTp3CQdoe1ehbMysg/exec'; // Replace with your Apps Script URL
    let log = [];
    let actionHistory = [];
    const timeSlots = Array.from({length: 23}, (_, i) => {
      const startHour = (7 + i) % 24;
      const endHour = (8 + i) % 24;
      const start = `${startHour.toString().padStart(2, '0')}:30`;
      const end = `${endHour.toString().padStart(2, '0')}:29`;
      return { start, end };
    });

    function parseTime(timeStr, referenceDate = new Date()) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date(referenceDate);
      if (hours < 7 && date.getHours() >= 7) {
        date.setDate(date.getDate() + 1);
      }
      date.setHours(hours, minutes, 0, 0);
      return date;
    }

    function formatDuration(start, end) {
      const diff = parseTime(end) - parseTime(start);
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}h ${minutes}m`;
    }

    function initializeSampleData() {
      // Add sample data for testing
      log = [
        { machineNumber: 1, inTime: '15:45', outTime: '16:00', entryTimestamp: '8/2/2025, 3:45:00 PM' }
      ];
      updateStatusTable();
      updateHourlyTable();
      syncToGoogleSheets();
    }

    function handleMachineButtonClick(machineNumber) {
      console.log('Button clicked for Machine', machineNumber, 'at', new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }));
      const now = new Date();
      const timeStr = now.toLocaleString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Hong_Kong' });
      const latestEntry = log.find(entry => entry.machineNumber === machineNumber && !entry.outTime);
      if (latestEntry) {
        latestEntry.outTime = timeStr;
        actionHistory.push({ action: 'addOutTime', machineNumber, outTime: timeStr });
      } else {
        const entry = { machineNumber, inTime: timeStr, entryTimestamp: now.toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' }) };
        log.push(entry);
        actionHistory.push({ action: 'addInTime', machineNumber, inTime: timeStr });
      }
      console.log('Updated log:', JSON.stringify(log, null, 2));
      updateStatusTable();
      updateHourlyTable();
      syncToGoogleSheets();
    }

    function updateStatusTable() {
      const tbody = document.querySelector('#statusTable tbody');
      tbody.innerHTML = '';
      log.forEach((entry, index) => {
        const row = document.createElement('tr');
        const containerNumber = log.length - index;
        const duration = entry.outTime ? formatDuration(entry.inTime, entry.outTime) : '-';
        row.innerHTML = `
          <td>${containerNumber}</td>
          <td>${entry.machineNumber}</td>
          <td>${entry.inTime || '-'}</td>
          <td>${entry.outTime || '-'}</td>
          <td>${duration}</td>
          <td>
            <button onclick="editEntry(${index})">Edit</button>
            <button onclick="deleteEntry(${index})">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateHourlyTable() {
      const tbody = document.querySelector('#hourlyTable tbody');
      tbody.innerHTML = '';
      const completedEntries = log.filter(entry => entry.outTime);
      timeSlots.forEach(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);
        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);
          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });
        const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${slot.start}-${slot.end}</td>
          ${machineCounts.slice(1).map(count => `<td>${count}</td>`).join('')}
          <td>${total}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function syncToGoogleSheets() {
      try {
        const statusRecords = log.map((entry, index) => ({
          containerNumber: log.length - index,
          compactorNumber: entry.machineNumber || 0,
          inTime: entry.inTime || '',
          outTime: entry.outTime || ''
        }));
        const hourlyRecords = [];
        const completedEntries = log.filter(entry => entry.outTime);
        timeSlots.forEach(slot => {
          const slotStart = parseTime(slot.start);
          const slotEnd = parseTime(slot.end, slotStart);
          const machineCounts = Array(11).fill(0);
          completedEntries.forEach(entry => {
            const inTime = parseTime(entry.inTime);
            const outTime = parseTime(entry.outTime, inTime);
            if (inTime >= slotStart && outTime <= slotEnd) {
              machineCounts[entry.machineNumber]++;
            }
          });
          hourlyRecords.push({
            timeSlot: `${slot.start}-${slot.end}`,
            machineCounts: machineCounts.slice(1),
            total: machineCounts.slice(1).reduce((sum, count) => sum + count, 0)
          });
        });
        const payload = { statusRecords, hourlyRecords };
        const syncTime = new Date().toLocaleString('en-US', { timeZone: 'Asia/Hong_Kong' });
        console.log('Sync attempt at', syncTime);
        console.log('Payload:', JSON.stringify(payload, null, 2));
        fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(() => {
          console.log('Data synced to Google Sheets');
          localStorage.setItem('lastSyncTime', syncTime);
          document.getElementById('lastSync').textContent = `Last synced: ${syncTime}`;
        }).catch(error => {
          console.error('Error syncing to Google Sheets:', error);
          document.getElementById('error').textContent = 'Failed to sync data to Google Sheets. Please try again later.';
        });
      } catch (error) {
        console.error('Error in syncToGoogleSheets:', error);
        document.getElementById('error').textContent = 'An error occurred while syncing data. Please try again.';
      }
    }

    function undoLastAction() {
      const lastAction = actionHistory.pop();
      if (lastAction) {
        if (lastAction.action === 'addInTime') {
          log = log.filter(entry => !(entry.machineNumber === lastAction.machineNumber && entry.inTime === lastAction.inTime));
        } else if (lastAction.action === 'addOutTime') {
          const entry = log.find(e => e.machineNumber === lastAction.machineNumber && e.outTime === lastAction.outTime);
          if (entry) entry.outTime = null;
        } else if (lastAction.action === 'delete') {
          log.splice(lastAction.index, 0, lastAction.entry);
        } else if (lastAction.action === 'edit') {
          log[lastAction.index] = lastAction.originalEntry;
        }
        updateStatusTable();
        updateHourlyTable();
        syncToGoogleSheets();
      }
    }

    function editEntry(index) {
      const entry = log[index];
      const newInTime = prompt('Enter new In Time (HH:mm)', entry.inTime);
      const newOutTime = prompt('Enter new Out Time (HH:mm)', entry.outTime || '');
      if (newInTime || newOutTime) {
        actionHistory.push({ action: 'edit', index, originalEntry: { ...entry } });
        if (newInTime) entry.inTime = newInTime;
        if (newOutTime) entry.outTime = newOutTime;
        updateStatusTable();
        updateHourlyTable();
        syncToGoogleSheets();
      }
    }

    function deleteEntry(index) {
      actionHistory.push({ action: 'delete', index, entry: { ...log[index] } });
      log.splice(index, 1);
      updateStatusTable();
      updateHourlyTable();
      syncToGoogleSheets();
    }

    function clearData() {
      if (confirm('Are you sure you want to clear all data?')) {
        log = [];
        actionHistory = [];
        updateStatusTable();
        updateHourlyTable();
        syncToGoogleSheets();
      }
    }

    function exportToCSV() {
      const statusData = log.map((entry, index) => ({
        'No. of Container': log.length - index,
        'Compactor Number': entry.machineNumber,
        'In Time': entry.inTime || '',
        'Out Time': entry.outTime || ''
      }));
      const statusCSV = 'No. of Container,Compactor Number,In Time,Out Time\n' +
        statusData.map(row => `${row['No. of Container']},${row['Compactor Number']},"${row['In Time']}","${row['Out Time']}"`).join('\n');
      
      const completedEntries = log.filter(entry => entry.outTime);
      const hourlyData = timeSlots.map(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);
        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);
          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });
        return {
          'Time Slot': `${slot.start}-${slot.end}`,
          ...machineCounts.slice(1).reduce((obj, count, i) => ({ ...obj, [`Machine ${i + 1}`]: count }), {}),
          'Total': machineCounts.slice(1).reduce((sum, count) => sum + count, 0)
        };
      });
      const hourlyCSV = 'Time Slot,Machine 1,Machine 2,Machine 3,Machine 4,Machine 5,Machine 6,Machine 7,Machine 8,Machine 9,Machine 10,Total\n' +
        hourlyData.map(row => `"${row['Time Slot']}",${row['Machine 1']},${row['Machine 2']},${row['Machine 3']},${row['Machine 4']},${row['Machine 5']},${row['Machine 6']},${row['Machine 7']},${row['Machine 8']},${row['Machine 9']},${row['Machine 10']},${row['Total']}`).join('\n');

      const date = new Date().toISOString().split('T')[0];
      const statusBlob = new Blob([statusCSV], { type: 'text/csv' });
      const hourlyBlob = new Blob([hourlyCSV], { type: 'text/csv' });
      const statusLink = document.createElement('a');
      statusLink.href = URL.createObjectURL(statusBlob);
      statusLink.download = `compactor_status_${date}.csv`;
      statusLink.click();
      const hourlyLink = document.createElement('a');
      hourlyLink.href = URL.createObjectURL(hourlyBlob);
      hourlyLink.download = `compactor_hourly_${date}.csv`;
      hourlyLink.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeSampleData();
      const lastSyncTime = localStorage.getItem('lastSyncTime') || 'None';
      document.getElementById('lastSync').textContent = `Last synced: ${lastSyncTime}`;
      const machineButtonsContainer = document.getElementById('machineButtons');
      for (let i = 1; i <= 10; i++) {
        const button = document.createElement('button');
        button.className = 'machine-button';
        button.textContent = `Machine ${i}`;
        button.onclick = () => handleMachineButtonClick(i);
        machineButtonsContainer.appendChild(button);
      }
      setInterval(syncToGoogleSheets, 30000);
    });
  </script>
</body>
</html>
