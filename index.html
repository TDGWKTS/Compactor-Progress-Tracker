<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.gstatic.com https://accounts.google.com https://*.googleapis.com https://ssl.gstatic.com https://www.google.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://accounts.google.com https://sheets.googleapis.com https://www.googleapis.com;">
  <title>Compactor Progress Tracker</title>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: clamp(10px, 2vw, 15px);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      height: auto;
      color: #333;
      line-height: 1.5;
      font-size: clamp(14px, 2.5vw, 16px);
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Cover Page Styles */
    #cover-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .login-container {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      padding: 30px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-container h1 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    .login-container p {
      color: #6c757d;
      margin-bottom: 30px;
    }

    .error-message {
      color: #e74c3c;
      margin-top: 10px;
      font-weight: bold;
      min-height: 20px;
    }

    /* Main Container Styles (hidden initially) */
    #main-container {
      display: none;
    }

    .container {
      max-width: min(1400px, 95vw);
      margin: 0 auto;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      padding: clamp(15px, 2.5vw, 20px);
      position: relative;
      flex-grow: 1;
      height: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800);
    }

    header {
      text-align: center;
      margin-bottom: clamp(15px, 3vw, 25px);
    }

    h1 {
      color: #2c3e50;
      margin: clamp(10px, 2vw, 15px) 0;
      font-weight: 600;
      position: relative;
      padding-bottom: 15px;
      font-size: clamp(1.5rem, 5vw, 2rem);
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(60px, 10vw, 80px);
      height: 4px;
      background: linear-gradient(90deg, #4CAF50, #2196F3);
      border-radius: 2px;
    }

    .dashboard {
      display: flex;
      flex-direction: column;
      gap: clamp(15px, 3vw, 25px);
      margin-bottom: clamp(15px, 3vw, 25px);
      flex-grow: 1;
    }

    @media (min-width: 768px) {
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: clamp(10px, 2vw, 20px);
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
      width: 100%;
      overflow: visible;
      flex-grow: 0;
      min-height: 0;
      overflow-y: auto;
    }

    .card-header {
      font-size: clamp(1rem, 3vw, 1.25rem);
      font-weight: 600;
      margin-bottom: clamp(10px, 2vw, 15px);
      color: #2c3e50;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .compactor-grid {
      display: grid;
      grid-template-rows: repeat(2, auto);
      grid-template-columns: repeat(5, minmax(50px, 1fr));
      grid-template-areas: 
        "b1 b2 b3 b4 b5"
        "b6 b7 b8 b9 b10";
      gap: clamp(8px, 1.5vw, 12px);
      margin-bottom: clamp(10px, 2vw, 20px);
    }

    .compactor-btn[data-machine="1"] { grid-area: b1; }
    .compactor-btn[data-machine="2"] { grid-area: b2; }
    .compactor-btn[data-machine="3"] { grid-area: b3; }
    .compactor-btn[data-machine="4"] { grid-area: b4; }
    .compactor-btn[data-machine="5"] { grid-area: b5; }
    .compactor-btn[data-machine="6"] { grid-area: b6; }
    .compactor-btn[data-machine="7"] { grid-area: b7; }
    .compactor-btn[data-machine="8"] { grid-area: b8; }
    .compactor-btn[data-machine="9"] { grid-area: b9; }
    .compactor-btn[data-machine="10"] { grid-area: b10; }

    .compactor-btn {
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(14px, 2.5vw, 18px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #4CAF50;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      touch-action: manipulation;
    }

    .compactor-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .compactor-btn.active {
      background-color: #6c757d;
      transform: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .error {
      color: #e74c3c;
      font-size: clamp(0.9rem, 2vw, 1rem);
      margin: clamp(10px, 1vw, 10px) 0;
      min-height: 24px;
      font-weight: bold;
      text-align: center;
    }

    .table-container {
      overflow-x: hidden;
      overflow-y: auto;
      margin-top: clamp(10px, 2vw, 20px);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      width: 100%;
      max-height: 400px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      table-layout: fixed;
    }

    th {
      background-color: #f1f5f9;
      padding: clamp(4px, 1vw, 8px);
      text-align: center;
      font-weight: 600;
      color: #2c3e50;
      border: 1px solid #d1d5db;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
    }

    td {
      padding: clamp(4px, 1vw, 8px);
      border: 1px solid #d1d5db;
      color: #4a5568;
      text-align: center;
      font-size: clamp(0.7rem, 1.5vw, 0.8rem);
      width: auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #hourlyTable th:nth-child(1),
    #hourlyTable td:nth-child(1) {
      width: clamp(80px, 15vw, 100px);
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
    }

    #hourlyTable th:nth-child(n+2):nth-child(-n+11),
    #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
      width: calc((100% - clamp(80px, 15vw, 100px)) / 11 * 0.9);
    }

    tr:hover {
      background-color: #f8fafc;
    }

    .cumulative-row {
      background-color: #d4edda !important;
    }

    .cumulative-row th,
    .cumulative-row td {
      background-color: #d4edda !important;
      font-weight: 700;
      color: #155724;
    }

    .time-cell {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .time-cell:hover {
      background-color: #e3f2fd;
    }

    .blink {
      animation: blink-animation 1s ease-in-out infinite;
    }

    @keyframes blink-animation {
      0%, 100% { background-color: #f8f9fa; }
      50% { background-color: #ffcccb; }
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: clamp(10px, 2vw, 15px);
      flex-wrap: wrap;
      gap: clamp(5px, 1vw, 10px);
    }

    .table-header h3 {
      margin: 0;
      flex: 1 1 auto;
      font-size: clamp(1rem, 3vw, 1.2rem);
    }

    .table-header > div {
      display: flex;
      align-items: center;
      gap: clamp(5px, 1vw, 10px);
      flex: 0 1 auto;
    }

    .counter {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
      border-radius: 20px;
      font-weight: bold;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-top: clamp(15px, 3vw, 25px);
    }

    .btn {
      flex: 1;
      padding: clamp(8px, 1.5vw, 12px);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.85rem, 2.2vw, 0.95rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(5px, 1vw, 8px);
      min-width: 100px;
      touch-action: manipulation;
    }

    .btn-export {
      background-color: #2196F3;
      color: white;
    }

    .btn-export:hover {
      background-color: #0b7dda;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }

    .btn-clear {
      background-color: #e74c3c;
      color: white;
    }

    .btn-clear:hover {
      background-color: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    .btn-undo {
      background-color: #f0ad4e;
      color: white;
    }

    .btn-undo:hover {
      background-color: #ec971f;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(240, 173, 78, 0.3);
    }

    .btn-undo:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .delete-icon {
      cursor: pointer;
      color: #e74c3c;
      transition: all 0.2s;
      width: clamp(14px, 2vw, 16px);
      height: clamp(14px, 2vw, 16px);
    }

    .delete-icon:hover {
      color: #c0392b;
      transform: scale(1.1);
    }

    .highlight {
      background: #fff9c4;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      margin-top: clamp(15px, 3vw, 25px);
      color: #6c757d;
      padding-top: clamp(10px, 2vw, 15px);
      border-top: 1px solid #e9ecef;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .status-counters {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(10px, 2vw, 15px);
      margin-bottom: clamp(10px, 2vw, 15px);
      justify-content: center;
    }

    .counter-badge {
      background: #e3f2fd;
      padding: clamp(6px, 1vw, 8px) clamp(10px, 2vw, 15px);
      border-radius: 20px;
      font-weight: bold;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
    }

    .counter-badge.pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .counter-badge.completed {
      background-color: #d4edda;
      color: #155724;
    }

    .toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #1976d2;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: clamp(3px, 0.5vw, 5px);
      padding: clamp(3px, 0.5vw, 5px) clamp(5px, 1vw, 10px);
      border-radius: 4px;
      transition: all 0.2s;
      flex: 0 0 auto;
      font-size: clamp(0.75rem, 1.8vw, 0.85rem);
      touch-action: manipulation;
    }

    .toggle-btn:hover {
      background-color: #e3f2fd;
    }

    .blink-toggle {
      color: #e74c3c;
    }

    .blink-toggle:hover {
      color: #c0392b;
    }

    .status-row {
      transition: background-color 0.3s;
    }

    .status-row:hover {
      background-color: #ebf8ff;
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .table-container {
        overflow-x: hidden;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
      }

      table {
        table-layout: fixed;
        width: 100%;
      }

      th, td {
        padding: clamp(2px, 0.5vw, 4px);
        font-size: clamp(0.6rem, 1.2vw, 0.7rem);
        width: auto;
      }

      #statusTable th:nth-child(1),
      #statusTable th:nth-child(2),
      #statusTable th:nth-child(3),
      #statusTable th:nth-child(4),
      #statusTable th:nth-child(5),
      #statusTable th:nth-child(6),
      #statusTable td:nth-child(1),
      #statusTable td:nth-child(2),
      #statusTable td:nth-child(3),
      #statusTable td:nth-child(4),
      #statusTable td:nth-child(5),
      #statusTable td:nth-child(6) {
        width: calc(100% / 6 * 0.9);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(70px, 12vw, 90px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(70px, 12vw, 90px)) / 11 * 0.8);
      }
    }

    @media (max-width: 1024px) {
      .card {
        padding: clamp(8px, 1.5vw, 15px);
      }
      
      .table-container {
        margin-left: calc(-1vw);
        margin-right: calc(-1vw);
        padding: 0 1vw;
      }
      
      table {
        min-width: 0;
      }
      
      body {
        padding: clamp(5px, 1vw, 10px);
      }
      
      .container {
        padding: clamp(10px, 2vw, 15px);
      }
    }

    @media (max-width: 768px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(45px, 1fr));
        gap: clamp(6px, 1vw, 10px);
      }
      
      .btn {
        min-width: 90px;
        padding: clamp(6px, 1.5vw, 10px);
      }
      
      .table-container {
        margin-left: calc(-2vw);
        margin-right: calc(-2vw);
        padding: 0 2vw;
      }
      
      .dashboard {
        flex-direction: column;
      }
      
      .card {
        width: 100%;
        margin-bottom: clamp(10px, 2vw, 15px);
      }
      
      body {
        min-height: 100%;
        height: auto;
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        min-height: 100%;
        height: auto;
        padding: clamp(8px, 1.5vw, 12px);
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(60px, 20vw, 80px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(60px, 20vw, 80px)) / 11 * 0.8);
      }
    }

    @media (max-width: 600px) {
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(40px, 1fr));
        gap: clamp(5px, 1vw, 8px);
      }
      
      .compactor-btn {
        font-size: clamp(12px, 2.2vw, 16px);
        padding: clamp(6px, 1.2vw, 12px);
      }
      
      table {
        min-width: 0;
        font-size: clamp(0.6rem, 1.4vw, 0.7rem);
      }
      
      th, td {
        padding: clamp(2px, 0.5vw, 4px);
      }
      
      .btn {
        min-width: 80px;
        font-size: clamp(0.75rem, 2vw, 0.85rem);
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .table-header > div {
        width: 100%;
        justify-content: flex-end;
      }

      #hourlyTable th:nth-child(1),
      #hourlyTable td:nth-child(1) {
        width: clamp(50px, 18vw, 70px);
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        font-size: clamp(0.65rem, 1.6vw, 0.75rem);
      }

      #hourlyTable th:nth-child(n+2):nth-child(-n+11),
      #hourlyTable td:nth-child(n+2):nth-child(-n+11) {
        width: calc((100% - clamp(50px, 18vw, 70px)) / 11 * 0.7);
      }
    }

    @media (max-width: 400px) {
      body {
        padding: clamp(5px, 1vw, 8px);
      }
      
      .container {
        padding: clamp(8px, 1.5vw, 12px);
      }
      
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.5rem);
      }
      
      .compactor-grid {
        grid-template-columns: repeat(5, minmax(35px, 1fr));
        gap: clamp(4px, 0.8vw, 6px);
      }
      
      .compactor-btn {
        font-size: clamp(10px, 2vw, 14px);
        padding: clamp(5px, 1vw, 10px);
      }
      
      table {
        min-width: 0;
      }
    }
  </style>
  <script>
    // Define handleCredentialResponse in global scope
    window.handleCredentialResponse = function(response) {
      console.log('handleCredentialResponse called with:', response);
      if (response.credential) {
        console.log('Credential received:', response.credential);
        try {
          const profile = parseJwt(response.credential);
          console.log('Parsed profile:', profile);
          accessToken = response.credential;
          document.getElementById('cover-page').style.display = 'none';
          document.getElementById('main-container').style.display = 'block';
          sessionStorage.setItem('loggedIn', 'true');
          console.log('Page transition completed, initializing app...');
          initializeApp();
        } catch (e) {
          console.error('Error in handleCredentialResponse:', e);
          document.getElementById('login-error').textContent = 'Error processing sign-in. Please try again.';
        }
      } else {
        console.error('No credential received in response:', response);
        document.getElementById('login-error').textContent = 'Sign-in failed: No credential received. Please try again.';
      }
    };

    // Parse JWT token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error('Error parsing JWT:', e);
        return {};
      }
    }

    // Google Sheets API configuration
    const API_KEY = 'AIzaSyD7iPND2yyzqY1JyC5n1la7S5NnDwpNOVM';
    const CLIENT_ID = '959994109190-rrpedrd8vg3es3meibc9gbim7a1r0254.apps.googleusercontent.com';
    const SPREADSHEET_ID = '1w6suOx0R43BUGhi_ylAohNzj7j3Z_quO9k2yoJ5CcSo';
    const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    let log = [];
    let actionHistory = [];
    let showAllRecords = false;
    let showAllHourly = false;
    let isBlinkingEnabled = true;
    let updateInterval = null;
    let syncInterval = null;
    let accessToken = null;
    let tokenClient = null;
    let firstEntryDate = null;

    const timeSlots = [
      { start: '07:30', end: '08:29' },
      { start: '08:30', end: '09:29' },
      { start: '09:30', end: '10:29' },
      { start: '10:30', end: '11:29' },
      { start: '11:30', end: '12:29' },
      { start: '12:30', end: '13:29' },
      { start: '13:30', end: '14:29' },
      { start: '14:30', end: '15:29' },
      { start: '15:30', end: '16:29' },
      { start: '16:30', end: '17:29' },
      { start: '17:30', end: '18:29' },
      { start: '18:30', end: '19:29' },
      { start: '19:30', end: '20:29' },
      { start: '20:30', end: '21:29' },
      { start: '21:30', end: '22:29' },
      { start: '22:30', end: '23:29' },
      { start: '23:30', end: '00:29' },
      { start: '00:30', end: '01:29' },
      { start: '01:30', end: '02:29' },
      { start: '02:30', end: '03:29' },
      { start: '03:30', end: '04:29' },
      { start: '04:30', end: '05:29' },
      { start: '05:30', end: '06:29' }
    ];

    const parseTime = (timeStr, referenceDate = new Date()) => {
      const [hours, mins] = timeStr.split(':').map(Number);
      const date = new Date(referenceDate);
      date.setHours(hours, mins, 0, 0);
      if (hours < 7) date.setDate(date.getDate() + 1);
      return date;
    };

    // Load data from local storage
    function loadFromLocalStorage() {
      const savedData = localStorage.getItem('compactorData');
      if (savedData) {
        const parsedData = JSON.parse(savedData);
        log = parsedData.log || [];
        actionHistory = parsedData.actionHistory || [];
        showAllRecords = parsedData.showAllRecords || false;
        showAllHourly = parsedData.showAllHourly || false;
        isBlinkingEnabled = parsedData.isBlinkingEnabled || true;
        firstEntryDate = parsedData.firstEntryDate ? new Date(parsedData.firstEntryDate) : null;
        log = log.map(entry => ({
          ...entry,
          entryTimestamp: new Date(entry.entryTimestamp)
        }));
      }
    }

    // Save data to local storage
    function saveToLocalStorage() {
      const data = {
        log,
        actionHistory,
        showAllRecords,
        showAllHourly,
        isBlinkingEnabled,
        firstEntryDate: firstEntryDate ? firstEntryDate.toISOString() : null
      };
      localStorage.setItem('compactorData', JSON.stringify(data));
      sessionStorage.setItem('tempCompactorData', JSON.stringify(data));
    }

    // Clear local storage
    function clearLocalStorage() {
      localStorage.removeItem('compactorData');
      sessionStorage.removeItem('tempCompactorData');
      log = [];
      actionHistory = [];
      showAllRecords = false;
      showAllHourly = false;
      isBlinkingEnabled = true;
      firstEntryDate = null;
    }

    // Format time for export (HHMMSS)
    function formatTimeForExport(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const seconds = date.getSeconds().toString().padStart(2, '0');
      return `${hours}${minutes}${seconds}`;
    }

    // Wait for Google APIs to load
    function waitForGoogleApis(attempts = 50) {
      if (attempts <= 0) {
        document.getElementById('error').textContent = 'Error: Google APIs failed to load';
        console.error('Google APIs failed to load after multiple attempts');
        return;
      }
      if (typeof google !== 'undefined' && typeof gapi !== 'undefined') {
        initClient();
      } else {
        setTimeout(() => waitForGoogleApis(attempts - 1), 100);
      }
    }

    // Initialize Google API client
    function initClient() {
      try {
        gapi.load('client', () => {
          gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS
          }).then(() => {
            initGoogleSignIn();
          }).catch(error => {
            console.error('Error initializing Google API client:', error);
            document.getElementById('error').textContent = `Google API init failed: ${error.details || error.message || 'Unknown error'}`;
          });
        });
      } catch (error) {
        console.error('Error loading gapi client:', error);
        document.getElementById('error').textContent = 'Google API load failed';
      }
    }

    // Initialize Google Identity Services
    function initGoogleSignIn() {
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) {
              accessToken = tokenResponse.access_token;
              gapi.client.setToken({ access_token: accessToken });
              document.getElementById('error').textContent = 'Connected to Google Sheets';
              setTimeout(() => {
                document.getElementById('error').textContent = '';
              }, 3000);
              checkSpreadsheetAccess();
            } else {
              console.error('Authentication failed: No access token received');
              document.getElementById('error').textContent = 'Authentication failed. Click Sign In and allow popups.';
            }
          },
          error_callback: (error) => {
            console.error('Google Sign-In error:', error);
            let errorMessage = error.message || 'Unknown error';
            if (error.message.includes('popup')) {
              errorMessage = 'Popup blocked. Allow popups and try Sign In again.';
            }
            document.getElementById('error').textContent = `Sign-in failed: ${errorMessage}`;
          }
        });
        tokenClient.requestAccessToken({ prompt: '' });
      } catch (error) {
        console.error('Error initializing Google Sign-In:', error);
        document.getElementById('error').textContent = 'Sign-in initialization failed';
      }
    }

    // Check spreadsheet access
    async function checkSpreadsheetAccess() {
      if (!accessToken) {
        document.getElementById('error').textContent = 'Not signed in';
        return;
      }
      try {
        await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: SPREADSHEET_ID
        });
        if (await ensureSheetExists('Sheet1') && await ensureSheetExists('Sheet2')) {
          syncToGoogleSheets();
        }
      } catch (error) {
        console.error('Error accessing spreadsheet:', error);
        document.getElementById('error').textContent = `Cannot access spreadsheet: ${error.result?.error?.message || error.message || 'Unknown error'}. Share the sheet with your Google account.`;
      }
    }

    // Ensure sheet exists
    async function ensureSheetExists(sheetName) {
      if (!accessToken) {
        document.getElementById('error').textContent = 'Not signed in';
        return false;
      }
      try {
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: SPREADSHEET_ID
        });
        const sheets = response.result.sheets;
        const sheetExists = sheets.some(sheet => sheet.properties.title === sheetName);
        if (!sheetExists) {
          await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: SPREADSHEET_ID,
            requests: [{
              addSheet: {
                properties: {
                  title: sheetName
                }
              }
            }]
          });
        }
        return true;
      } catch (error) {
        console.error(`Error checking/creating ${sheetName}:`, error);
        document.getElementById('error').textContent = `Cannot access spreadsheet: ${error.result?.error?.message || error.message || 'Unknown error'}. Verify spreadsheet ID and permissions.`;
        return false;
      }
    }

    // Ensure export sheet exists
    async function ensureExportSheetExists(sheetName) {
      if (!accessToken) {
        document.getElementById('error').textContent = 'Not signed in';
        return false;
      }
      try {
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: SPREADSHEET_ID
        });
        const sheets = response.result.sheets;
        const sheetExists = sheets.some(sheet => sheet.properties.title === sheetName);
        if (!sheetExists) {
          await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: SPREADSHEET_ID,
            requests: [{
              addSheet: {
                properties: {
                  title: sheetName
                }
              }
            }]
          });
        }
        return true;
      } catch (error) {
        console.error(`Error checking/creating export sheet ${sheetName}:`, error);
        document.getElementById('error').textContent = `Cannot create export sheet: ${error.result?.error?.message || error.message || 'Unknown error'}. Verify spreadsheet ID and permissions.`;
        return false;
      }
    }

    // Sync to Google Sheets
    async function syncToGoogleSheets(context = 'auto') {
      if (!accessToken) {
        document.getElementById('error').textContent = 'Not signed in';
        initGoogleSignIn();
        return false;
      }

      if (!(await ensureSheetExists('Sheet1')) || !(await ensureSheetExists('Sheet2'))) {
        return false;
      }

      document.getElementById('error').textContent = `Syncing to Google Sheets (${context})...`;

      const statusValues = log.map(entry => [
        entry.entryTimestamp.toISOString(),
        entry.machineNumber,
        entry.inTime,
        entry.outTime || '',
        calculateDuration(entry.inTime, entry.outTime).display
      ]);

      const hourlyRecords = [];
      const completedEntries = log.filter(entry => entry.outTime);

      timeSlots.forEach(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);

        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);

          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });

        if (showAllHourly || machineCounts.some(count => count > 0)) {
          const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
          hourlyRecords.push([`${slot.start}-${slot.end}`, ...machineCounts.slice(1), total]);
        }
      });

      const cumulativeCounts = Array(11).fill(0);
      completedEntries.forEach(entry => {
        cumulativeCounts[entry.machineNumber]++;
      });
      const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);
      if (cumulativeTotal > 0) {
        hourlyRecords.unshift(['Cumulative Total', ...cumulativeCounts.slice(1), cumulativeTotal]);
      }

      try {
        // Sync Status Records to Sheet1
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Sheet1!A1:E',
          valueInputOption: 'RAW',
          resource: {
            values: [
              ['Timestamp', 'Machine Number', 'In Time', 'Out Time', 'Duration'],
              ...statusValues
            ]
          }
        });

        // Sync Hourly Records to Sheet2
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: 'Sheet2!A1:L',
          valueInputOption: 'RAW',
          resource: {
            values: [
              ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
              ...hourlyRecords
            ]
          }
        });

        document.getElementById('error').textContent = `Synced to Google Sheets (${context})`;
        setTimeout(() => {
          document.getElementById('error').textContent = 'Connected to Google Sheets';
        }, 3000);
        return true;
      } catch (error) {
        console.error(`Error syncing to Google Sheets (${context}):`, error);
        let errorMessage = error.result?.error?.message || error.message || 'Unknown error';
        if (error.result?.error?.status === 'PERMISSION_DENIED') {
          errorMessage = 'Permission denied. Share the spreadsheet with your Google account.';
        } else if (error.result?.error?.status === 'UNAUTHENTICATED') {
          accessToken = null;
          errorMessage = 'Authentication expired. Click Sign In and allow popups.';
          initGoogleSignIn();
        } else if (error.result?.error?.status === 'INVALID_ARGUMENT') {
          errorMessage = 'Invalid request. Ensure the spreadsheet has tabs named "Sheet1" and "Sheet2" and verify the spreadsheet ID.';
        }
        document.getElementById('error').textContent = `Sync failed: ${errorMessage}`;
        return false;
      }
    }

    // Export to Google Sheet and CSV
    async function exportAndClearData() {
      if (!log.length) {
        document.getElementById('error').textContent = 'No data to export';
        return;
      }

      if (!confirm('Are you sure you want to export the data to CSV, sync to Google Sheets, and clear all data?')) {
        return;
      }

      const now = new Date();
      const dateString = firstEntryDate ? firstEntryDate.toISOString().slice(0, 10).replace(/-/g, '') : now.toISOString().slice(0, 10).replace(/-/g, '');
      const timeString = formatTimeForExport(now);
      const sheetName = `CPT_${dateString}_${timeString}`;

      const statusValues = log.map(entry => [
        entry.entryTimestamp.toISOString(),
        entry.machineNumber,
        entry.inTime,
        entry.outTime || '',
        calculateDuration(entry.inTime, entry.outTime).display
      ]);

      const hourlyRecords = [];
      const completedEntries = log.filter(entry => entry.outTime);

      timeSlots.forEach(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);

        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);

          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });

        if (showAllHourly || machineCounts.some(count => count > 0)) {
          const total = machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
          hourlyRecords.push([`${slot.start}-${slot.end}`, ...machineCounts.slice(1), total]);
        }
      });

      const cumulativeCounts = Array(11).fill(0);
      completedEntries.forEach(entry => {
        cumulativeCounts[entry.machineNumber]++;
      });
      const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);
      if (cumulativeTotal > 0) {
        hourlyRecords.unshift(['Cumulative Total', ...cumulativeCounts.slice(1), cumulativeTotal]);
      }

      const data = [
        ['STATUS RECORDS'],
        ['Timestamp', 'Machine Number', 'In Time', 'Out Time', 'Duration'],
        ...statusValues,
        ['', '', '', '', ''],
        ['HOURLY RECORDS'],
        ['Time Slot', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Total'],
        ...hourlyRecords,
        ['', '', '', '', '', '', '', '', '', '', '', ''],
        ['Total Completed Entries', cumulativeTotal, '']
      ];

      // Export to CSV
      try {
        const csv = data.map(row => row.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `CPT_${dateString}_${timeString}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        // Export to Google Sheet
        let exportSuccess = false;
        if (accessToken) {
          document.getElementById('error').textContent = 'Exporting to Google Sheet...';
          if (await ensureExportSheetExists(sheetName)) {
            try {
              await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: `${sheetName}!A1`,
                valueInputOption: 'RAW',
                resource: { values: data }
              });
              exportSuccess = true;
              document.getElementById('error').textContent = 'Exported to Google Sheet and CSV';
            } catch (error) {
              console.error('Error exporting to Google Sheet:', error);
              let errorMessage = error.result?.error?.message || error.message || 'Unknown error';
              if (error.result?.error?.status === 'PERMISSION_DENIED') {
                errorMessage = 'Permission denied. Share the spreadsheet with your Google account.';
              } else if (error.result?.error?.status === 'UNAUTHENTICATED') {
                accessToken = null;
                errorMessage = 'Authentication expired. Click Sign In and allow popups.';
                initGoogleSignIn();
              } else if (error.result?.error?.status === 'INVALID_ARGUMENT') {
                errorMessage = `Invalid request. Ensure the spreadsheet has a tab named "${sheetName}" and verify the spreadsheet ID.`;
              }
              document.getElementById('error').textContent = `Export failed: ${errorMessage}`;
            }
          }
        }

        // Clear data after successful export
        clearLocalStorage();
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = true;
        document.getElementById('error').textContent = exportSuccess ? 
          'Data exported to CSV and Google Sheet, local storage cleared' : 
          'Data exported to CSV, local storage cleared, Google Sheet sync failed';
        setTimeout(() => {
          document.getElementById('error').textContent = accessToken ? 'Connected to Google Sheets' : 'Not signed in';
        }, 3000);
      } catch (error) {
        console.error('Error during CSV export:', error);
        document.getElementById('error').textContent = 'Failed to export CSV';
      }
    }

    function initializeApp() {
      loadFromLocalStorage();
      updateStatusTable();
      updateHourlyTable();
      updateMachineButtonStates();
      document.getElementById('undoButton').disabled = actionHistory.length === 0;
      updateInterval = setInterval(updateStatusTable, 60000);
      syncInterval = setInterval(() => {
        if (accessToken) {
          syncToGoogleSheets();
        }
      }, 60000);
      waitForGoogleApis();

      window.addEventListener('beforeunload', saveToLocalStorage);
    }

    function updateStatusTable() {
      const statusBody = document.getElementById('statusBody');
      const statusCount = document.getElementById('statusCount');
      const pendingCount = document.getElementById('pendingCount');
      const completedCount = document.getElementById('completedCount');
      const toggleButton = document.getElementById('toggleRecords');

      const pendingRecords = log.filter(entry => !entry.outTime).length;
      const completedRecords = log.filter(entry => entry.outTime).length;

      statusCount.textContent = `${log.length} records`;
      pendingCount.textContent = `${pendingRecords} pending`;
      completedCount.textContent = `${completedRecords} completed`;

      toggleButton.style.display = log.length > 10 ? 'flex' : 'none';
      toggleButton.innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
        </svg>
        ${showAllRecords ? 'Show Less' : 'Show All'}
      `;

      if (log.length === 0) {
        statusBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #6c757d;">No records</td></tr>`;
        return;
      }

      log.sort((a, b) => new Date(b.entryTimestamp) - new Date(a.entryTimestamp));
      const displayEntries = showAllRecords ? log : log.slice(0, 10);

      statusBody.innerHTML = '';

      displayEntries.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.className = 'status-row';

        const { display, minutes } = calculateDuration(entry.inTime, entry.outTime);
        const blinkClass = isBlinkingEnabled && !entry.outTime && minutes > 39 ? 'blink' : '';
        const containerNumber = log.length - (showAllRecords ? index : index);
        const entryIndex = log.indexOf(entry);

        row.innerHTML = `
          <td>${containerNumber}</td>
          <td class="${blinkClass}">${entry.machineNumber}</td>
          <td class="time-cell" onclick="editEntry(${entry.machineNumber}, '${entry.entryTimestamp.toISOString().replace(/'/g, "\\'")}', 'inTime')">${entry.inTime}</td>
          <td class="time-cell" onclick="${entry.outTime ? `editEntry(${entry.machineNumber}, '${entry.entryTimestamp.toISOString().replace(/'/g, "\\'")}', 'outTime')` : `promptOutTime(${entryIndex})`}">
            ${entry.outTime || '-'}
          </td>
          <td>${display}</td>
          <td>
            <svg class="delete-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" onclick="deleteEntry(${entry.machineNumber}, '${entry.entryTimestamp.toISOString().replace(/'/g, "\\'")}')">
              <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
              <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
            </svg>
          </td>
        `;

        statusBody.appendChild(row);
      });
    }

    function updateHourlyTable() {
      const hourlyBody = document.getElementById('hourlyBody');
      const hourlyCount = document.getElementById('hourlyCount');
      const toggleButton = document.getElementById('toggleHourly');
      const cumulativeRow = document.getElementById('cumulativeRow');

      const hourlyRecords = [];
      const completedEntries = log.filter(entry => entry.outTime);

      timeSlots.forEach(slot => {
        const slotStart = parseTime(slot.start);
        const slotEnd = parseTime(slot.end, slotStart);
        const machineCounts = Array(11).fill(0);

        completedEntries.forEach(entry => {
          const inTime = parseTime(entry.inTime);
          const outTime = parseTime(entry.outTime, inTime);

          if (inTime >= slotStart && outTime <= slotEnd) {
            machineCounts[entry.machineNumber]++;
          }
        });

        if (showAllHourly || machineCounts.some(count => count > 0)) {
          hourlyRecords.push({
            timeSlot: `${slot.start}-${slot.end}`,
            machineCounts,
            startTime: slotStart
          });
        }
      });

      hourlyCount.textContent = `${hourlyRecords.length} hours`;
      toggleButton.style.display = hourlyRecords.length > 5 ? 'flex' : 'none';
      toggleButton.innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M3.5 3a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
        </svg>
        ${showAllHourly ? 'Show Less' : 'Show All'}
      `;

      const cumulativeCounts = Array(11).fill(0);
      completedEntries.forEach(entry => {
        cumulativeCounts[entry.machineNumber]++;
      });
      const cumulativeTotal = cumulativeCounts.slice(1).reduce((sum, count) => sum + count, 0);

      if (cumulativeTotal > 0) {
        cumulativeRow.style.display = 'table-row';
        cumulativeRow.innerHTML = `
          <th>Cumulative Total</th>
          ${cumulativeCounts.slice(1).map(count => `<th>${count}</th>`).join('')}
          <th>${cumulativeTotal}</th>
        `;
      } else {
        cumulativeRow.style.display = 'none';
      }

      hourlyBody.innerHTML = '';

      if (hourlyRecords.length === 0) {
        hourlyBody.innerHTML = `<tr><td colspan="12" style="text-align: center; color: #6c757d;">No hourly records</td></tr>`;
        return;
      }

      hourlyRecords.sort((a, b) => b.startTime - a.startTime);
      const displayRecords = showAllHourly ? hourlyRecords : hourlyRecords.slice(0, 5);

      displayRecords.forEach(record => {
        const row = document.createElement('tr');
        const total = record.machineCounts.slice(1).reduce((sum, count) => sum + count, 0);
        row.innerHTML = `
          <td>${record.timeSlot}</td>
          ${record.machineCounts.slice(1).map(count => `<td>${count}</td>`).join('')}
          <td class="total-cell">${total}</td>
        `;
        hourlyBody.appendChild(row);
      });
    }

    function updateMachineButtonStates() {
      document.querySelectorAll('.compactor-btn').forEach(button => {
        const machineNum = parseInt(button.getAttribute('data-machine'));
        const hasActiveSession = log.some(entry => 
          entry.machineNumber === machineNum && !entry.outTime
        );
        button.classList.toggle('active', hasActiveSession);
      });
    }

    function calculateDuration(inTime, outTime = null) {
      try {
        const start = parseTime(inTime);
        const end = outTime ? parseTime(outTime) : new Date();

        if (end < start) {
          end.setDate(end.getDate() + 1);
        }

        const diffMs = end - start;
        const diffMins = Math.floor(diffMs / 60000);
        const hours = Math.floor(diffMins / 60);
        const mins = diffMins % 60;

        return {
          display: `${hours}h ${mins}m`,
          minutes: diffMins
        };
      } catch {
        return { display: 'N/A', minutes: 0 };
      }
    }

    function handleMachineButtonClick(machineNum) {
      try {
        const errorDiv = document.getElementById('error');
        const currentTime = new Date().toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false,
          timeZone: 'Asia/Hong_Kong'
        }).replace("24:", "00:");

        const existingEntry = log.find(entry => 
          entry.machineNumber === machineNum && !entry.outTime
        );

        if (!firstEntryDate) firstEntryDate = new Date();

        if (existingEntry) {
          actionHistory.push({
            type: 'addOutTime',
            entry: { ...existingEntry },
            newOutTime: currentTime
          });
          existingEntry.outTime = currentTime;
          existingEntry.entryTimestamp = new Date();
        } else {
          const entry = {
            machineNumber: machineNum,
            inTime: currentTime,
            outTime: '',
            entryTimestamp: new Date()
          };
          actionHistory.push({
            type: 'addInTime',
            entry: { ...entry }
          });
          log.push(entry);
        }

        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = false;
        saveToLocalStorage();
        syncToGoogleSheets();
        errorDiv.textContent = '';
      } catch (error) {
        console.error('Error in handleMachineButtonClick:', error);
        document.getElementById('error').textContent = 'An error occurred. Please try again.';
      }
    }

    function promptOutTime(entryIndex) {
      try {
        const entry = log[entryIndex];
        if (!entry || entry.outTime) return;

        let outTimeInput = prompt(`Enter Out Time for Machine ${entry.machineNumber} (e.g., 1456 for 14:56):`, "");

        if (outTimeInput === null) return;

        outTimeInput = outTimeInput.trim().replace(/[^0-9]/g, '');
        if (outTimeInput.length === 4) {
          outTimeInput = `${outTimeInput.slice(0, 2)}:${outTimeInput.slice(2)}`;
        }

        const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
        if (!timeRegex.test(outTimeInput)) {
          alert('Out Time must be in HH:MM format (e.g., 14:56 or 1456).');
          return;
        }

        actionHistory.push({
          type: 'addOutTime',
          entry: { ...entry },
          newOutTime: outTimeInput
        });

        entry.outTime = outTimeInput;
        entry.entryTimestamp = new Date();

        saveToLocalStorage();
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = false;
        syncToGoogleSheets();

        alert(`Out Time ${outTimeInput} recorded for Machine ${entry.machineNumber}`);
      } catch (error) {
        console.error('Error in promptOutTime:', error);
        document.getElementById('error').textContent = 'An error occurred. Please try again.';
      }
    }

    function editEntry(machineNumber, entryTimestamp, field) {
      try {
        const entry = log.find(entry => 
          entry.machineNumber === machineNumber && entry.entryTimestamp.toISOString() === entryTimestamp
        );
        if (!entry) return;

        const timeLabel = field === 'inTime' ? 'In Time' : 'Out Time';
        const currentValue = field === 'inTime' ? entry.inTime : entry.outTime;

        let newTime = prompt(`Enter new ${timeLabel} for Machine ${machineNumber} (e.g., 1456 for 14:56):`, currentValue ? currentValue.replace(':', '') : '');

        if (newTime === null) return;

        newTime = newTime.trim().replace(/[^0-9]/g, '');
        if (newTime.length === 4) {
          newTime = `${newTime.slice(0, 2)}:${newTime.slice(2)}`;
        }

        const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
        if (!timeRegex.test(newTime)) {
          alert(`${timeLabel} must be in HH:MM format (e.g., 14:56 or 1456).`);
          return;
        }

        actionHistory.push({
          type: 'edit' + field,
          entry: { ...entry },
          newTime: newTime
        });

        if (field === 'inTime') {
          entry.inTime = newTime;
        } else {
          entry.outTime = newTime;
        }

        entry.entryTimestamp = new Date();

        saveToLocalStorage();
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = false;
        syncToGoogleSheets();

        alert(`${timeLabel} updated to ${newTime} for Machine ${machineNumber}`);
      } catch (error) {
        console.error('Error in editEntry:', error);
        document.getElementById('error').textContent = 'An error occurred. Please try again.';
      }
    }

    function deleteEntry(machineNumber, entryTimestamp) {
      try {
        if (!confirm(`Are you sure you want to delete the record for Machine ${machineNumber} at ${entryTimestamp}?`)) {
          return;
        }

        const entryIndex = log.findIndex(entry => 
          entry.machineNumber === machineNumber && entry.entryTimestamp.toISOString() === entryTimestamp
        );
        if (entryIndex === -1) {
          alert('Record not found.');
          return;
        }

        actionHistory.push({
          type: 'deleteEntry',
          entry: { ...log[entryIndex] }
        });

        log.splice(entryIndex, 1);

        saveToLocalStorage();
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = false;
        syncToGoogleSheets();

        alert('Record deleted successfully.');
      } catch (error) {
        console.error('Error in deleteEntry:', error);
        document.getElementById('error').textContent = 'An error occurred while deleting the record. Please try again.';
      }
    }

    function undoLastAction() {
      try {
        if (actionHistory.length === 0) {
          alert('No actions to undo.');
          return;
        }

        const lastAction = actionHistory.pop();

        if (lastAction.type === 'addInTime') {
          const entryIndex = log.findIndex(entry => 
            entry.machineNumber === lastAction.entry.machineNumber && 
            entry.entryTimestamp.toISOString() === lastAction.entry.entryTimestamp.toISOString()
          );
          if (entryIndex !== -1) {
            log.splice(entryIndex, 1);
          }
        } else if (lastAction.type === 'addOutTime') {
          const entry = log.find(entry => 
            entry.machineNumber === lastAction.entry.machineNumber && 
            entry.entryTimestamp.toISOString() === lastAction.entry.entryTimestamp.toISOString()
          );
          if (entry) {
            entry.outTime = '';
            entry.entryTimestamp = new Date(lastAction.entry.entryTimestamp);
          }
        } else if (lastAction.type === 'deleteEntry') {
          log.push({ ...lastAction.entry });
        } else if (lastAction.type === 'editinTime' || lastAction.type === 'editoutTime') {
          const entry = log.find(entry => 
            entry.machineNumber === lastAction.entry.machineNumber && 
            entry.entryTimestamp.toISOString() === lastAction.entry.entryTimestamp.toISOString()
          );
          if (entry) {
            entry.inTime = lastAction.entry.inTime;
            entry.outTime = lastAction.entry.outTime;
            entry.entryTimestamp = new Date(lastAction.entry.entryTimestamp);
          }
        }

        saveToLocalStorage();
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = actionHistory.length === 0;
        syncToGoogleSheets();
      } catch (error) {
        console.error('Error in undoLastAction:', error);
        document.getElementById('error').textContent = 'An error occurred while undoing the last action. Please try again.';
      }
    }

    function clearAllData() {
      if (!confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        return;
      }

      try {
        clearLocalStorage();
        updateStatusTable();
        updateHourlyTable();
        updateMachineButtonStates();
        document.getElementById('undoButton').disabled = true;
        syncToGoogleSheets();
        document.getElementById('error').textContent = 'All data cleared successfully.';
        setTimeout(() => {
          document.getElementById('error').textContent = accessToken ? 'Connected to Google Sheets' : 'Not signed in';
        }, 3000);
      } catch (error) {
        console.error('Error in clearAllData:', error);
        document.getElementById('error').textContent = 'An error occurred while clearing data. Please try again.';
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.compactor-btn').forEach(button => {
        button.addEventListener('click', () => {
          const machineNum = parseInt(button.getAttribute('data-machine'));
          handleMachineButtonClick(machineNum);
        });
      });

      document.getElementById('toggleRecords').addEventListener('click', () => {
        showAllRecords = !showAllRecords;
        updateStatusTable();
        saveToLocalStorage();
      });

      document.getElementById('toggleHourly').addEventListener('click', () => {
        showAllHourly = !showAllHourly;
        updateHourlyTable();
        saveToLocalStorage();
        syncToGoogleSheets();
      });

      document.getElementById('toggleBlink').addEventListener('click', () => {
        isBlinkingEnabled = !isBlinkingEnabled;
        document.getElementById('toggleBlink').innerHTML = `
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="${isBlinkingEnabled ? 'M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z' : 'M4 4a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 4z'}" />
          </svg>
          ${isBlinkingEnabled ? 'Stop Blinking' : 'Start Blinking'}
        `;
        updateStatusTable();
        saveToLocalStorage();
      });

      document.getElementById('exportButton').addEventListener('click', exportAndClearData);
      document.getElementById('clearButton').addEventListener('click', clearAllData);
      document.getElementById('undoButton').addEventListener('click', undoLastAction);
    });
  </script>
</body>
</html>
